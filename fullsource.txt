>>>file: custom/dolielec/admin/anthropic.php
<?php

global $db, $conf, $langs, $user;

// Parameters

$action = GETPOST('action', 'alpha');
$api_key = GETPOST('ANTHROPIC_API_KEY', 'alpha');
$model = GETPOST('ANTHROPIC_DEFAULT_MODEL', 'alpha');
//$temp = GETPOST('OPENAI_TEMPERATURE', 'alphanohtml');
//$top_p = GETPOST('OPENAI_TOP_P', 'alphanohtml');
//$freq = GETPOST('OPENAI_FREQUENCY_PENALTY', 'alphanohtml');
//$presence = GETPOST('OPENAI_PRESENCE_PENALTY', 'alphanohtml');
//$max_tokens = GETPOST('OPENAI_MAX_TOKENS', 'int');

if ($action == 'save') {
dolibarr_set_const($db, 'ANTHROPIC_API_KEY', $api_key, 'chaine', 0, '', $conf->entity);
dolibarr_set_const($db, 'ANTHROPIC_DEFAULT_MODEL', $model, 'chaine', 0, '', $conf->entity);
//dolibarr_set_const($db, 'OPENAI_TEMPERATURE', $temp, 'chaine', 0, '', $conf->entity);
//dolibarr_set_const($db, 'OPENAI_TOP_P', $top_p, 'chaine', 0, '', $conf->entity);
//dolibarr_set_const($db, 'OPENAI_FREQUENCY_PENALTY', $freq, 'chaine', 0, '', $conf->entity);
//dolibarr_set_const($db, 'OPENAI_PRESENCE_PENALTY', $presence, 'chaine', 0, '', $conf->entity);
//dolibarr_set_const($db, 'OPENAI_MAX_TOKENS', $max_tokens, 'int', 0, '', $conf->entity);
setEventMessages($langs->trans("SetupSaved"), null, 'mesgs');
}
// Load current values

$api_key = getDolGlobalString('ANTHROPIC_API_KEY', '');
$model = getDolGlobalString('ANTHROPIC_DEFAULT_MODEL', '');
//$temp = getDolGlobalString('OPENAI_TEMPERATURE', '');
//$top_p = getDolGlobalString('OPENAI_TOP_P', '');
//$freq = getDolGlobalString('OPENAI_FREQUENCY_PENALTY', '');
//$presence = getDolGlobalString('OPENAI_PRESENCE_PENALTY', '');
//$max_tokens = getDolGlobalInt('OPENAI_MAX_TOKENS', '');
// JS path (lo dejamos porque tienes planes con √©l)

//$js = '/custom/dolielec/js/dolielec.js.php';
//echo "\n<script type=\"text/javascript\" src=\"".dol_buildpath($js,1)."\"></script>\n";
// ---- Form UI (igual que el aprobado) ----

print '<form method="POST" action="' . $_SERVER["PHP_SELF"] . '">';
print '<input type="hidden" name="action" value="save">';
print '<div class="div-table-responsive-no-min">';
print '<table class="noborder centpercent">';
print '<tr class="liste_titre">';
print '<th class="titlefield">' . $langs->trans("Parameter") . '</th>';
print '<th>' . $langs->trans("Value") . '</th>';
print '</tr>';
// API Key

print '<tr>';
print '<td><label for="anthropic_api_key">' . $langs->trans("ANTHROPIC_API_KEY") . ' *</label></td>';
print '<td><input type="text" id="anthropic_api_key" name="ANTHROPIC_API_KEY" class="minwidth100" required value="' . dol_escape_htmltag($api_key) . '"> ';
print '<button type="button" id="anthropic_check_api" class="button">'.$langs->trans("CheckConnection").'</button> ';
print '</td>';
print '</tr>';
// Model (select vac√≠o si no hay valor guardado)
print '<tr>';
print '<td><label for="anthropic_model">' . $langs->trans("ANTHROPIC_DEFAULT_MODEL") . ' *</label></td>';
print '<td><select name="ANTHROPIC_DEFAULT_MODEL" id="anthropic_model" required>';
if (!empty($model)) print '<option value="' . dol_escape_htmltag($model) . '">' . dol_escape_htmltag($model) . '</option>';
print '</select></td>';

print '</tr>';

// Temperature

//print '<tr>';
//print '<td><label for="temp">' . $langs->trans("OPENAI_TEMPERATURE") . '</label></td>';
//print '<td><input type="number" step="0.01" min="0" max="2" name="OPENAI_TEMPERATURE" id="temp" placeholder="0.7" value="' . dol_escape_htmltag($temp) . '"></td>';
//print '</tr>';
// Top P

//print '<tr>';
//print '<td><label for="top_p">' . $langs->trans("OPENAI_TOP_P") . '</label></td>';
//print '<td><input type="number" step="0.01" min="0" max="1" name="OPENAI_TOP_P" id="top_p" placeholder="0.7" value="' . dol_escape_htmltag($top_p) . '"></td>';
//print '</tr>';
//// Frequency Penalty

//print '<tr>';
//print '<td><label for="freq">' . $langs->trans("OPENAI_FREQUENCY_PENALTY") . '</label></td>';
//print '<td><input type="number" step="0.01" min="-2" max="2" name="OPENAI_FREQUENCY_PENALTY" id="freq" placeholder="0.5" value="' . dol_escape_htmltag($freq) . '"></td>';
//print '</tr>';

// Presence Penalty

//print '<tr>';
//print '<td><label for="presence">' . $langs->trans("OPENAI_PRESENCE_PENALTY") . '</label></td>';
//print '<td><input type="number" step="0.01" min="-2" max="2" name="OPENAI_PRESENCE_PENALTY" id="presence" placeholder="0.56" value="' . dol_escape_htmltag($presence) . '"></td>';
//print '</tr>';

// Max Tokens

//print '<tr>';
//print '<td><label for="max_tokens">' . $langs->trans("OPENAI_MAX_TOKENS") . '</label></td>';
//print '<td><input type="number" min="1" step="1" name="OPENAI_MAX_TOKENS" id="max_tokens" placeholder="2048" value="' . dol_escape_htmltag($max_tokens) . '"></td>';
//print '</tr>';
print '</table>';
print '</div>';
print '<div class="center">';
print '<input type="submit" class="button button-save" value="' . $langs->trans("Save") . '">';
print '</div>';
print '</form>';

?>>>>file: custom/dolielec/admin/doc.php
<?php
//doc.php - IDM configuration file.
global $db, $conf, $langs, $user;
$langs->loadLangs(array('admin','main','dolielec@dolielec'));
$currenttab  = GETPOST('tab','alpha');
if (empty($currenttab)) $currenttab = 'signature';
$action      = GETPOST('dle_action','alpha');   // acciones propias para no colisionar
$token       = newToken();
$upload_dir  = rtrim(DOL_DATA_ROOT,'/').'/dolielec/docs/cert/';
$cert_file   = getDolGlobalString('DOLIELEC_CERT_FILE','');
$cert_pass   = GETPOST('DOLIELEC_CERT_PASS','restricthtml');
if ($cert_pass === '') $cert_pass = getDolGlobalString('DOLIELEC_CERT_PASS','');
$cert_orig   = getDolGlobalString('DOLIELEC_CERT_ORIG','');
$cert_sha256 = getDolGlobalString('DOLIELEC_CERT_SHA256','');
$scan_info   = null;
$hasOpenSSL  = function () {
    return function_exists('openssl_pkcs12_read') && function_exists('openssl_x509_parse');
};

if ($action === 'dle_doc_scan') {
    if (!$hasOpenSSL()) {
        setEventMessages($langs->trans('ErrorOpenSSLNotAvailable'), null, 'errors');
    } elseif (empty($_FILES['cert_upload']) || $_FILES['cert_upload']['error'] === UPLOAD_ERR_NO_FILE) {
        setEventMessages($langs->trans('ErrorNoFileProvided'), null, 'errors');
    } elseif ($_FILES['cert_upload']['error'] !== UPLOAD_ERR_OK) {
        setEventMessages($langs->trans('ErrorUploadingFile').' (code '.$_FILES['cert_upload']['error'].')', null, 'errors');
    } else {
        $ext = strtolower(pathinfo($_FILES['cert_upload']['name'], PATHINFO_EXTENSION));
        if (!in_array($ext, array('p12','pfx'))) {
            setEventMessages($langs->trans('ErrorBadCertificateExtension'), null, 'errors');
        } elseif (!dol_strlen($cert_pass)) {
            setEventMessages($langs->trans('ErrorPasswordRequired'), null, 'errors');
        } else {
            $raw = @file_get_contents($_FILES['cert_upload']['tmp_name']);
            $bag = array();
            if ($raw === false || !openssl_pkcs12_read($raw, $bag, $cert_pass)) {
                setEventMessages($langs->trans('ErrorPkcs12ReadFailed'), null, 'errors');
            } else {
                $x509   = isset($bag['cert']) ? $bag['cert'] : '';
                $parsed = $x509 ? openssl_x509_parse($x509, false) : false;
                if (!$parsed) {
                    setEventMessages($langs->trans('ErrorX509ParseFailed'), null, 'errors');
                } else {
                                        $scan_info  = $parsed;
                                        $cert_orig   = $_FILES['cert_upload']['name'];
                    $cert_sha256 = @hash_file('sha256', $_FILES['cert_upload']['tmp_name']) ?: '';
                    dolibarr_set_const($db, 'DOLIELEC_CERT_ORIG',   $cert_orig,   'chaine', 0, '', $conf->entity);
                    dolibarr_set_const($db, 'DOLIELEC_CERT_SHA256', $cert_sha256, 'chaine', 0, '', $conf->entity);
                    setEventMessages($langs->trans('CertificateScannedOK'), null, 'mesgs');
                }
            }
        }
    }
}
if ($action === 'dle_doc_save') {
    dol_mkdir($upload_dir);
    if (!is_dir($upload_dir) || !is_writable($upload_dir)) {
        setEventMessages($langs->trans('ErrorFailedToWriteInDir').' '.$upload_dir, null, 'errors');
    } else {
        $had_new_upload = (!empty($_FILES['cert_upload']) && is_array($_FILES['cert_upload']) && $_FILES['cert_upload']['error'] !== UPLOAD_ERR_NO_FILE);
        if ($had_new_upload) {
            if ($_FILES['cert_upload']['error'] !== UPLOAD_ERR_OK) {
                setEventMessages($langs->trans('ErrorUploadingFile').' (code '.$_FILES['cert_upload']['error'].')', null, 'errors');
            } else {
                $ext = strtolower(pathinfo($_FILES['cert_upload']['name'], PATHINFO_EXTENSION));
                if (!in_array($ext, array('p12','pfx'))) {
                    setEventMessages($langs->trans('ErrorBadCertificateExtension'), null, 'errors');
                } else {
                    $dest_abs = $upload_dir.'cert_entity'.$conf->entity.'.'.$ext;
                    $res = dol_move_uploaded_file($_FILES['cert_upload']['tmp_name'], $dest_abs, 1, 0, $_FILES['cert_upload']);
                    if (!($res > 0 && is_readable($dest_abs))) {
                        setEventMessages($langs->trans('ErrorUploadingFile'), null, 'errors');
                    } else {
                                                $okPass = true;
                        if (dol_strlen($cert_pass) && $hasOpenSSL()) {
                            $raw = @file_get_contents($dest_abs);
                            $bag = array();
                            if ($raw === false || !openssl_pkcs12_read($raw, $bag, $cert_pass)) {
                                $okPass = false;
                                setEventMessages($langs->trans('ErrorPkcs12ReadFailed'), null, 'errors');
                            } else {
                                $x509   = isset($bag['cert']) ? $bag['cert'] : '';
                                $parsed = $x509 ? openssl_x509_parse($x509, false) : false;
                                if ($parsed) $scan_info = $parsed;
                            }
                        }
                        if ($okPass) {
                            $cert_file   = $dest_abs;
                            $cert_orig   = $_FILES['cert_upload']['name'];
                            $cert_sha256 = @hash_file('sha256', $dest_abs) ?: '';
                            dolibarr_set_const($db, 'DOLIELEC_CERT_FILE',   $cert_file,   'chaine', 0, '', $conf->entity);
                            dolibarr_set_const($db, 'DOLIELEC_CERT_PASS',   $cert_pass,   'chaine', 0, '', $conf->entity);
                            dolibarr_set_const($db, 'DOLIELEC_CERT_ORIG',   $cert_orig,   'chaine', 0, '', $conf->entity);
                            dolibarr_set_const($db, 'DOLIELEC_CERT_SHA256', $cert_sha256, 'chaine', 0, '', $conf->entity);
                            setEventMessages($langs->trans('FileUploaded'), null, 'mesgs');
                            setEventMessages($langs->trans('SetupSaved'), null, 'mesgs');
                        }
                    }
                }
            }
        } else {
                        dolibarr_set_const($db, 'DOLIELEC_CERT_PASS', $cert_pass, 'chaine', 0, '', $conf->entity);
            setEventMessages($langs->trans('SetupSaved'), null, 'mesgs');
            if (is_readable($cert_file) && $hasOpenSSL() && dol_strlen($cert_pass)) {
                $raw = @file_get_contents($cert_file);
                $bag = array();
                if ($raw !== false && openssl_pkcs12_read($raw, $bag, $cert_pass)) {
                    $x509   = isset($bag['cert']) ? $bag['cert'] : '';
                    $parsed = $x509 ? openssl_x509_parse($x509, false) : false;
                    if ($parsed) $scan_info = $parsed;
                                        if (empty($cert_sha256)) {
                        $cert_sha256 = @hash_file('sha256', $cert_file) ?: '';
                        dolibarr_set_const($db, 'DOLIELEC_CERT_SHA256', $cert_sha256, 'chaine', 0, '', $conf->entity);
                    }
                }
            }
        }
    }
}
$action_url = $_SERVER['PHP_SELF'].'?tab='.urlencode($currenttab); // permanecer en la pestaÒa
print '<form enctype="multipart/form-data" method="POST" action="'.$action_url.'">';
print '<input type="hidden" name="token" value="'.$token.'">';
print '<div class="div-table-responsive-no-min">';
print '<table class="noborder centpercent">';
print '<tr class="liste_titre"><th class="titlefield">'.$langs->trans("Parameter").'</th><th>'.$langs->trans("Value").'</th></tr>';
print '<tr>';
print '<td><label for="cert_upload">'.$langs->trans("CertificateFile").' (.p12/.pfx)</label></td>';
print '<td>';
print '<input type="file" id="cert_upload" name="cert_upload" class="minwidth100" accept=".p12,.pfx">';
if (!empty($cert_file)) {
    print '<br><span class="opacitymedium">'.$langs->trans('CurrentFile').': '.dol_escape_htmltag($cert_file).'</span>';
}
if (!empty($cert_orig)) {
    print '<br><span class="opacitymedium">'.$langs->trans('OriginalFileName').': '.dol_escape_htmltag($cert_orig).'</span>';
}
if (!empty($cert_sha256)) {
    print '<br><span class="opacitymedium">'.$langs->trans('SHA256').': '.dol_escape_htmltag($cert_sha256).'</span>';
}
print '<br><span class="opacitymedium">'.$langs->trans('UploadDest').': '.dol_escape_htmltag($upload_dir).'</span>';
print '</td>';
print '</tr>';
print '<tr>';
print '<td><label for="cert_pass">'.$langs->trans("CertificatePassword").' *</label></td>';
print '<td><input type="password" id="cert_pass" name="DOLIELEC_CERT_PASS" class="minwidth100" required value="'.dol_escape_htmltag($cert_pass).'"></td>';
print '</tr>';
print '</table></div>';
print '<div class="center">';
print '<button type="submit" name="dle_action" value="dle_doc_scan" class="button">'.$langs->trans("Scan").'</button> ';
print '<button type="submit" name="dle_action" value="dle_doc_save" class="button button-save">'.$langs->trans("Save").'</button>';
print '</div>';
print '</form>';
if (is_array($scan_info)) {
    $subject = isset($scan_info['subject']) ? $scan_info['subject'] : array();
    $issuer  = isset($scan_info['issuer'])  ? $scan_info['issuer']  : array();
    $get = function($arr,$k,$def=''){ return isset($arr[$k]) ? $arr[$k] : $def; };
    $cnSubj = $get($subject,'CN');
    $gnSubj = $get($subject,'GN', $get($subject,'givenName',''));
    $snSubj = $get($subject,'SN', $get($subject,'surname',''));
    $oSubj  = $get($subject,'O');
    $cnIss  = $get($issuer,'CN');
    $oIss   = $get($issuer,'O');
    $serial = !empty($scan_info['serialNumber']) ? $scan_info['serialNumber'] : (!empty($scan_info['serialNumberHex']) ? $scan_info['serialNumberHex'] : '');
    $validFrom = !empty($scan_info['validFrom_time_t']) ? dol_print_date($scan_info['validFrom_time_t'],'dayhour') : '';
    $validTo   = !empty($scan_info['validTo_time_t'])   ? dol_print_date($scan_info['validTo_time_t'],'dayhour')   : '';
    print '<br>';
    print '<div class="div-table-responsive-no-min"><table class="noborder centpercent">';
    print '<tr class="liste_titre"><th class="titlefield">'.$langs->trans("Field").'</th><th>'.$langs->trans("Value").'</th></tr>';
    print '<tr><td>'.$langs->trans("SubjectCN").'</td><td>'.dol_escape_htmltag($cnSubj).'</td></tr>';
    print '<tr><td>'.$langs->trans("SubjectGivenName").'</td><td>'.dol_escape_htmltag($gnSubj).'</td></tr>';
    print '<tr><td>'.$langs->trans("SubjectSurname").'</td><td>'.dol_escape_htmltag($snSubj).'</td></tr>';
    print '<tr><td>'.$langs->trans("SubjectOrg").'</td><td>'.dol_escape_htmltag($oSubj).'</td></tr>';
    print '<tr><td>'.$langs->trans("IssuerCN").'</td><td>'.dol_escape_htmltag($cnIss).'</td></tr>';
    print '<tr><td>'.$langs->trans("IssuerOrg").'</td><td>'.dol_escape_htmltag($oIss).'</td></tr>';
    print '<tr><td>'.$langs->trans("SerialNumber").'</td><td>'.dol_escape_htmltag($serial).'</td></tr>';
    print '<tr><td>'.$langs->trans("ValidFrom").'</td><td>'.dol_escape_htmltag($validFrom).'</td></tr>';
    print '<tr><td>'.$langs->trans("ValidTo").'</td><td>'.dol_escape_htmltag($validTo).'</td></tr>';
    print '</table></div>';
}

?>>>>file: custom/dolielec/admin/geoloc.php
<?php
// geoloc.php ‚Äî configuraci√≥n de geolocalizaci√≥n (estilo openai.php limpio)
// Sin inline JS de toggle; los cambios din√°micos los gestiona js/geoloc.js.php

// === Bootstrap Dolibarr ===
if (!defined('DOL_DOCUMENT_ROOT')) {
    $res = 0;
    if (!$res && file_exists("../../main.inc.php"))       $res = @include("../../main.inc.php");
    if (!$res && file_exists("../../../main.inc.php"))    $res = @include("../../../main.inc.php");
    if (!$res && file_exists("../../../../main.inc.php")) $res = @include("../../../../main.inc.php");
    if (!$res) die('Include of main fails');
}
require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
require_once '../lib/dolielec.lib.php';

$langs->loadLangs(array('admin','dolielec'));
if (empty($user->admin)) accessforbidden();

// === Par√°metros ===
$action = GETPOST('action','alpha');
$isSave = ($action === 'save_geoloc');

// === INPUTS (estilo OPEN: variables arriba) ===
$in = array(
    // core
    'DOLIELEC_GEO_PROVIDER' => GETPOST('DOLIELEC_GEO_PROVIDER','alpha'),
    'DOLIELEC_GEO_API_KEY'  => GETPOST('DOLIELEC_GEO_API_KEY','alphanohtml'),
    // base address
    'DOLIELEC_GEO_COUNTRY'  => GETPOST('DOLIELEC_GEO_COUNTRY','alpha'),
    'DOLIELEC_GEO_ADDR'     => GETPOST('DOLIELEC_GEO_ADDR','alphanohtml'),
    'DOLIELEC_GEO_ZIP'      => GETPOST('DOLIELEC_GEO_ZIP','alpha'),
    'DOLIELEC_GEO_TOWN'     => GETPOST('DOLIELEC_GEO_TOWN','alphanohtml'),
    'DOLIELEC_GEO_STATE'    => GETPOST('DOLIELEC_GEO_STATE','alphanohtml'),
    // select / numbers
    'DOLIELEC_ROUTE_OPTIMIZE'   => GETPOST('DOLIELEC_ROUTE_OPTIMIZE','alpha'),
    'DOLIELEC_ROUTE_BUFFER_MIN' => (int)GETPOST('DOLIELEC_ROUTE_BUFFER_MIN','int'),
    // costes
    'DOLIELEC_DRIVE_EUR_PER_KM'     => GETPOST('DOLIELEC_DRIVE_EUR_PER_KM','alphanohtml'),
    'DOLIELEC_PARKING_EUR_PER_H'    => GETPOST('DOLIELEC_PARKING_EUR_PER_H','alphanohtml'),
    'DOLIELEC_PT_MIN_PER_ZONE'      => (int)GETPOST('DOLIELEC_PT_MIN_PER_ZONE','int'),
    'DOLIELEC_ATM_TITLE'            => GETPOST('DOLIELEC_ATM_TITLE','alphanohtml'),
    'DOLIELEC_ATM_MUNI_CSV'         => GETPOST('DOLIELEC_ATM_MUNI_CSV','alphanohtml'),
    'DOLIELEC_ATM_METRO_TARIFA'     => (GETPOST('DOLIELEC_ATM_METRO_TARIFA','alpha')!=='' ? 1 : 0),
    'DOLIELEC_PRICE_ROUND_MODE'     => GETPOST('DOLIELEC_PRICE_ROUND_MODE','alpha'),
    'DOLIELEC_PRICE_ROUND_STEP_EUR' => GETPOST('DOLIELEC_PRICE_ROUND_STEP_EUR','alphanohtml'),
    'DOLIELEC_PRICE_SMOOTH_EUR'     => GETPOST('DOLIELEC_PRICE_SMOOTH_EUR','alphanohtml'),
    'DOLIELEC_PRICE_SMOOTH_PCT'     => GETPOST('DOLIELEC_PRICE_SMOOTH_PCT','alphanohtml'),
    'DOLIELEC_PROPAL_AUTOLINE'      => (GETPOST('DOLIELEC_PROPAL_AUTOLINE','alpha')!=='' ? 1 : 0),
    'DOLIELEC_TRAVEL_PRESENTATION'  => GETPOST('DOLIELEC_TRAVEL_PRESENTATION','alpha'),
    'DOLIELEC_PROPAL_LABEL'         => GETPOST('DOLIELEC_PROPAL_LABEL','alphanohtml'),
    'DOLIELEC_BASE_FEE_LABEL'       => GETPOST('DOLIELEC_BASE_FEE_LABEL','alphanohtml'),
    'DOLIELEC_PROPAL_VAT'           => GETPOST('DOLIELEC_PROPAL_VAT','alphanohtml'),

    // viaje ida+vuelta y billete sencillo por embarque
    'DOLIELEC_TRAVEL_MULTIPLIER' => GETPOST('DOLIELEC_TRAVEL_MULTIPLIER','alphanohtml'),
    'DOLIELEC_SINGLE_BUS_EUR'    => GETPOST('DOLIELEC_SINGLE_BUS_EUR','alphanohtml'),
    'DOLIELEC_SINGLE_METRO_EUR'  => GETPOST('DOLIELEC_SINGLE_METRO_EUR','alphanohtml'),
    'DOLIELEC_SINGLE_TRAM_EUR'   => GETPOST('DOLIELEC_SINGLE_TRAM_EUR','alphanohtml'),
    'DOLIELEC_SINGLE_TRAIN_EUR'  => GETPOST('DOLIELEC_SINGLE_TRAIN_EUR','alphanohtml'),
);
// checkboxes multi
foreach (array(
  'DOLIELEC_MODE_DRIVE','DOLIELEC_MODE_FOOT','DOLIELEC_MODE_TRANSIT_TRAIN','DOLIELEC_MODE_TRANSIT_BUS','DOLIELEC_MODE_TRANSIT_METRO','DOLIELEC_MODE_BIKE',
  'DOLIELEC_SHOW_COST_ON_THIRDPARTY',
  'DOLIELEC_AVOID_HIGHWAYS','DOLIELEC_AVOID_TOLLS','DOLIELEC_AVOID_FERRIES','DOLIELEC_AVOID_STAIRS','DOLIELEC_AVOID_HILLS','DOLIELEC_AVOID_CROWDS','DOLIELEC_AVOID_FORDS'
) as $k) { $in[$k] = (GETPOST($k,'alpha')!=='' ? 1 : 0); }

// === Validaci√≥n m√≠nima ===
$allowedProviders = array('osm','google','ors');
if (!in_array($in['DOLIELEC_GEO_PROVIDER'], $allowedProviders, true)) $in['DOLIELEC_GEO_PROVIDER'] = 'osm';
$needsKey = in_array($in['DOLIELEC_GEO_PROVIDER'], array('google','ors'), true);
if ($isSave && $needsKey && $in['DOLIELEC_GEO_API_KEY']==='') {
    setEventMessages($langs->trans("ErrorApiKeyRequired"), null, 'errors');
    $action = '';
}

// === SAVE (compacto, sin florituras) ===
if ($action === 'save_geoloc') {
    $S = function($name, $val, $type='chaine') use ($db, $conf) { dolibarr_set_const($db, $name, $val, $type, 0, '', $conf->entity); };
    foreach (array(
        'DOLIELEC_GEO_PROVIDER','DOLIELEC_GEO_API_KEY','DOLIELEC_GEO_COUNTRY','DOLIELEC_GEO_ADDR','DOLIELEC_GEO_ZIP',
        'DOLIELEC_GEO_TOWN','DOLIELEC_GEO_STATE','DOLIELEC_ROUTE_OPTIMIZE',
        'DOLIELEC_DRIVE_EUR_PER_KM','DOLIELEC_PARKING_EUR_PER_H','DOLIELEC_ATM_TITLE',
        'DOLIELEC_ATM_MUNI_CSV','DOLIELEC_PRICE_ROUND_MODE','DOLIELEC_PRICE_ROUND_STEP_EUR',
        'DOLIELEC_PRICE_SMOOTH_EUR','DOLIELEC_PRICE_SMOOTH_PCT','DOLIELEC_TRAVEL_PRESENTATION',
        'DOLIELEC_PROPAL_LABEL','DOLIELEC_BASE_FEE_LABEL','DOLIELEC_PROPAL_VAT'
    ) as $k) { $S($k, $in[$k], 'chaine'); }
    foreach (array('DOLIELEC_PT_MIN_PER_ZONE','DOLIELEC_ROUTE_BUFFER_MIN') as $k) { $S($k, (int)$in[$k], 'int'); }
    foreach (array(
        'DOLIELEC_MODE_DRIVE','DOLIELEC_MODE_FOOT','DOLIELEC_MODE_TRANSIT_TRAIN','DOLIELEC_MODE_TRANSIT_BUS','DOLIELEC_MODE_TRANSIT_METRO','DOLIELEC_MODE_BIKE',
        'DOLIELEC_ATM_METRO_TARIFA','DOLIELEC_PROPAL_AUTOLINE','DOLIELEC_SHOW_COST_ON_THIRDPARTY',
        'DOLIELEC_AVOID_HIGHWAYS','DOLIELEC_AVOID_TOLLS','DOLIELEC_AVOID_FERRIES','DOLIELEC_AVOID_STAIRS','DOLIELEC_AVOID_HILLS','DOLIELEC_AVOID_CROWDS','DOLIELEC_AVOID_FORDS'
    ) as $k) { $S($k, (int)$in[$k], 'int'); }
	$multiplier = getDolGlobalString('DOLIELEC_TRAVEL_MULTIPLIER','2');
$single_bus = getDolGlobalString('DOLIELEC_SINGLE_BUS_EUR','0.00');
$single_metro = getDolGlobalString('DOLIELEC_SINGLE_METRO_EUR','0.00');
$single_tram = getDolGlobalString('DOLIELEC_SINGLE_TRAM_EUR','0.00');
$single_train = getDolGlobalString('DOLIELEC_SINGLE_TRAIN_EUR','0.00');
    setEventMessages($langs->trans("SetupSaved"), null, 'mesgs');
    // --- DoliElec: actualizar checksum de configuraci√≥n GEO para rec√°lculos autom√°ticos ---
    $conf_for_checksum = array(
        // Proveedor y modos
        'DOLIELEC_GEO_PROVIDER' => $in['DOLIELEC_GEO_PROVIDER'],
        'DOLIELEC_MODE_DRIVE'   => (int)$in['DOLIELEC_MODE_DRIVE'],
        'DOLIELEC_MODE_FOOT'    => (int)$in['DOLIELEC_MODE_FOOT'],
        'DOLIELEC_MODE_TRANSIT_TRAIN' => (int)$in['DOLIELEC_MODE_TRANSIT_TRAIN'],
        'DOLIELEC_MODE_TRANSIT_BUS'   => (int)$in['DOLIELEC_MODE_TRANSIT_BUS'],
        'DOLIELEC_MODE_TRANSIT_METRO' => (int)$in['DOLIELEC_MODE_TRANSIT_METRO'],
        'DOLIELEC_MODE_BIKE'          => (int)$in['DOLIELEC_MODE_BIKE'],
        // Evitar
        'DOLIELEC_AVOID_HIGHWAYS' => (int)$in['DOLIELEC_AVOID_HIGHWAYS'],
        'DOLIELEC_AVOID_TOLLS'    => (int)$in['DOLIELEC_AVOID_TOLLS'],
        'DOLIELEC_AVOID_FERRIES'  => (int)$in['DOLIELEC_AVOID_FERRIES'],
        'DOLIELEC_AVOID_STAIRS'   => (int)$in['DOLIELEC_AVOID_STAIRS'],
        'DOLIELEC_AVOID_HILLS'    => (int)$in['DOLIELEC_AVOID_HILLS'],
        'DOLIELEC_AVOID_CROWDS'   => (int)$in['DOLIELEC_AVOID_CROWDS'],
		'DOLIELEC_AVOID_FORDS'   => (int)$in['DOLIELEC_AVOID_FORDS'],
        // Direcci√≥n base
        'DOLIELEC_GEO_COUNTRY' => $in['DOLIELEC_GEO_COUNTRY'],
        'DOLIELEC_GEO_ADDR'    => $in['DOLIELEC_GEO_ADDR'],
        'DOLIELEC_GEO_ZIP'     => $in['DOLIELEC_GEO_ZIP'],
        'DOLIELEC_GEO_TOWN'    => $in['DOLIELEC_GEO_TOWN'],
        'DOLIELEC_GEO_STATE'   => $in['DOLIELEC_GEO_STATE'],
        // Optimizaci√≥n y buffer
        'DOLIELEC_ROUTE_OPTIMIZE'   => $in['DOLIELEC_ROUTE_OPTIMIZE'],
        'DOLIELEC_ROUTE_BUFFER_MIN' => (int)$in['DOLIELEC_ROUTE_BUFFER_MIN'],
        // Costes base / tarifas
        'DOLIELEC_DRIVE_EUR_PER_KM'  => $in['DOLIELEC_DRIVE_EUR_PER_KM'],
        'DOLIELEC_PARKING_EUR_PER_H' => $in['DOLIELEC_PARKING_EUR_PER_H'],
        'DOLIELEC_PT_MIN_PER_ZONE'   => (int)$in['DOLIELEC_PT_MIN_PER_ZONE'],
        'DOLIELEC_ATM_TITLE'         => $in['DOLIELEC_ATM_TITLE'],
        'DOLIELEC_ATM_MUNI_CSV'      => $in['DOLIELEC_ATM_MUNI_CSV'],
        'DOLIELEC_ATM_METRO_TARIFA'  => (int)$in['DOLIELEC_ATM_METRO_TARIFA'],
        // Redondeo / estabilidad / presentaci√≥n / IVA
        'DOLIELEC_PRICE_ROUND_MODE'     => $in['DOLIELEC_PRICE_ROUND_MODE'],
        'DOLIELEC_PRICE_ROUND_STEP_EUR' => $in['DOLIELEC_PRICE_ROUND_STEP_EUR'],
        'DOLIELEC_PRICE_SMOOTH_EUR'     => $in['DOLIELEC_PRICE_SMOOTH_EUR'],
        'DOLIELEC_PRICE_SMOOTH_PCT'     => $in['DOLIELEC_PRICE_SMOOTH_PCT'],
        'DOLIELEC_TRAVEL_PRESENTATION'  => $in['DOLIELEC_TRAVEL_PRESENTATION'],
        'DOLIELEC_PROPAL_LABEL'         => $in['DOLIELEC_PROPAL_LABEL'],
        'DOLIELEC_BASE_FEE_LABEL'       => $in['DOLIELEC_BASE_FEE_LABEL'],
        'DOLIELEC_PROPAL_VAT'           => $in['DOLIELEC_PROPAL_VAT'],
    );
    // Nota: NO incluimos la API key en el checksum (no afecta al coste)
    $checksum_geo = sha1(json_encode($conf_for_checksum));
    dolibarr_set_const($db, 'DOLIELEC_GEO_CONF_CHECKSUM', $checksum_geo, 'chaine', 0, '', $conf->entity);

}

// === LOAD actuales (para pintar) ===
$prov   = getDolGlobalString('DOLIELEC_GEO_PROVIDER','osm');
$key    = getDolGlobalString('DOLIELEC_GEO_API_KEY','');
$ct     = getDolGlobalString('DOLIELEC_GEO_COUNTRY','ES');
$addr   = getDolGlobalString('DOLIELEC_GEO_ADDR','');
$zip    = getDolGlobalString('DOLIELEC_GEO_ZIP','');
$town   = getDolGlobalString('DOLIELEC_GEO_TOWN','');
$state  = getDolGlobalString('DOLIELEC_GEO_STATE','');

$modes = array(
    'drive'         => getDolGlobalInt('DOLIELEC_MODE_DRIVE',0),
    'foot'          => getDolGlobalInt('DOLIELEC_MODE_FOOT',1),
    'transit_train' => getDolGlobalInt('DOLIELEC_MODE_TRANSIT_TRAIN',1),
    'transit_bus'   => getDolGlobalInt('DOLIELEC_MODE_TRANSIT_BUS',1),
    'transit_metro' => getDolGlobalInt('DOLIELEC_MODE_TRANSIT_METRO',1),
    'bike'          => getDolGlobalInt('DOLIELEC_MODE_BIKE',0),
);

$opt    = getDolGlobalString('DOLIELEC_ROUTE_OPTIMIZE','time');

$avoid = array(
    'HIGHWAYS' => getDolGlobalInt('DOLIELEC_AVOID_HIGHWAYS',0),
    'TOLLS'    => getDolGlobalInt('DOLIELEC_AVOID_TOLLS',0),
    'FERRIES'  => getDolGlobalInt('DOLIELEC_AVOID_FERRIES',0),
    'STAIRS'   => getDolGlobalInt('DOLIELEC_AVOID_STAIRS',0),
    'HILLS'    => getDolGlobalInt('DOLIELEC_AVOID_HILLS',0),
    'CROWDS'   => getDolGlobalInt('DOLIELEC_AVOID_CROWDS',0),
	'FORDS'   => getDolGlobalInt('DOLIELEC_AVOID_FORDS',0),
);

$buff   = getDolGlobalInt('DOLIELEC_ROUTE_BUFFER_MIN',0);
$show   = getDolGlobalInt('DOLIELEC_SHOW_COST_ON_THIRDPARTY',0);

// Costes
$eurkm      = getDolGlobalString('DOLIELEC_DRIVE_EUR_PER_KM','0.35');
$parkh      = getDolGlobalString('DOLIELEC_PARKING_EUR_PER_H','2.0');
$ptmin      = getDolGlobalInt('DOLIELEC_PT_MIN_PER_ZONE',12);
$title      = getDolGlobalString('DOLIELEC_ATM_TITLE','Billete sencillo');
$csv        = getDolGlobalString('DOLIELEC_ATM_MUNI_CSV','');
$metro      = getDolGlobalInt('DOLIELEC_ATM_METRO_TARIFA',1);
$round_mode = getDolGlobalString('DOLIELEC_PRICE_ROUND_MODE','ceil');
$round_step = getDolGlobalString('DOLIELEC_PRICE_ROUND_STEP_EUR','1.00');
$smooth_eur = getDolGlobalString('DOLIELEC_PRICE_SMOOTH_EUR','0.50');
$smooth_pct = getDolGlobalString('DOLIELEC_PRICE_SMOOTH_PCT','3');
$autoline   = getDolGlobalInt('DOLIELEC_PROPAL_AUTOLINE',1);
$present    = getDolGlobalString('DOLIELEC_TRAVEL_PRESENTATION','explicit');
$label      = getDolGlobalString('DOLIELEC_PROPAL_LABEL','Desplazamiento');
$baselbl    = getDolGlobalString('DOLIELEC_BASE_FEE_LABEL','Tarifa de servicio');
$vat        = getDolGlobalString('DOLIELEC_PROPAL_VAT','21.0');

// === UI ===
llxHeader('', $langs->trans("dolielecGeoSetup"));

print load_fiche_titre($langs->trans("dolielecGeoSetup"), '', 'title_setup');

print '<form method="POST" action="'.$_SERVER['PHP_SELF'].'?tab=geoloc">';
print '<input type="hidden" name="action" value="save_geoloc">';
print '<div class="div-table-responsive-no-min"><table class="noborder centpercent">';

print '<tr class="liste_titre"><th class="titlefield">'.$langs->trans("Parameter").'</th><th>'.$langs->trans("Value").'</th></tr>';

// Marcador de requerido como en openai.php
$reqMark = ' *';

// === Proveedor & API key (sin inline JS; toggle lo hace geoloc.js.php) ===
print '<tr>';
print '<td><label for="DOLIELEC_GEO_PROVIDER">'.$langs->trans("GeoProvider").$reqMark.'</label></td>';
print '<td><select name="DOLIELEC_GEO_PROVIDER" id="DOLIELEC_GEO_PROVIDER" required aria-required="true" aria-describedby="geo_provider_help">';
$opts = array('ors'=>'OpenRouteService','osm'=>'OpenStreetMap','google'=>'Google Maps');
foreach($opts as $k=>$v){
    print '<option value="'.$k.'"'.($prov===$k?' selected':'').'>'.$v.'</option>';
}
print '</select><div id="geo_provider_help" class="small opacitymedium">'.$langs->trans("GoogleAndORSRequiresAPIKey").'</div></td>';
print '</tr>';

// Estado inicial en servidor (el JS lo ajustar√° al vuelo)
$req = ($prov==='google' || $prov==='ors');
$aster = '<span id="req_apikey"'.($req?'':" style=\"display:none\"").'> *</span>';
$attrs = $req ? 'required aria-required="true"' : 'readonly aria-readonly="true" aria-disabled="true"';

print '<tr id="row_api_key">';
print '<td><label for="DOLIELEC_GEO_API_KEY">'.$langs->trans("ApiKey").$aster.'</label></td>';
print '<td><input type="text" id="DOLIELEC_GEO_API_KEY" name="DOLIELEC_GEO_API_KEY" class="minwidth300" value="'.dol_escape_htmltag($key).'" '.$attrs.' aria-describedby="geo_apikey_help" title="'.($req?$langs->trans("ApiKeyRequiredForSelectedProvider"):$langs->trans("ApiKeyNotUsedForProvider")).'"><div id="geo_apikey_help" class="small opacitymedium">'.$langs->trans("RequiredForGoogleAndORS").'</div></td>';
print '</tr>';

// === Direcci√≥n base ===
print '<tr class="liste_titre"><th colspan="2">'.$langs->trans("BaseAddress").'</th></tr>';

print '<tr><td><label for="DOLIELEC_GEO_COUNTRY">'.$langs->trans("CountryCode").$reqMark.'</label></td><td><input type="text" id="DOLIELEC_GEO_COUNTRY" name="DOLIELEC_GEO_COUNTRY" maxlength="2" required aria-required="true" aria-describedby="geo_country_help" value="'.dol_escape_htmltag($ct).'"><div id="geo_country_help" class="small opacitymedium">'.$langs->trans("CountryCodeHelp").'</div></td></tr>';

print '<tr><td><label for="DOLIELEC_GEO_ADDR">'.$langs->trans("Address").$reqMark.'</label></td><td><input type="text" id="DOLIELEC_GEO_ADDR" name="DOLIELEC_GEO_ADDR" required aria-required="true" value="'.dol_escape_htmltag($addr).'"></td></tr>';

print '<tr><td><label for="DOLIELEC_GEO_ZIP">'.$langs->trans("Zip").$reqMark.'</label></td><td><input type="text" id="DOLIELEC_GEO_ZIP" name="DOLIELEC_GEO_ZIP" inputmode="numeric" required aria-required="true" value="'.dol_escape_htmltag($zip).'"></td></tr>';

print '<tr><td><label for="DOLIELEC_GEO_TOWN">'.$langs->trans("Town").$reqMark.'</label></td><td><input type="text" id="DOLIELEC_GEO_TOWN" name="DOLIELEC_GEO_TOWN" required aria-required="true" value="'.dol_escape_htmltag($town).'"></td></tr>';

print '<tr><td><label for="DOLIELEC_GEO_STATE">'.$langs->trans("State").$reqMark.'</label></td><td><input type="text" id="DOLIELEC_GEO_STATE" name="DOLIELEC_GEO_STATE" required aria-required="true" value="'.dol_escape_htmltag($state).'"></td></tr>';

// === Modos de transporte ===
print '<tr class="liste_titre"><th colspan="2">'.$langs->trans("TransportModes").'</th></tr>';
print '<tr><td colspan="2"><fieldset><legend class="visually-hidden">'.$langs->trans("TransportModesLegend").'</legend>';
print '<label for="DOLIELEC_MODE_DRIVE"><input type="checkbox" id="DOLIELEC_MODE_DRIVE" name="DOLIELEC_MODE_DRIVE" '.($modes['drive']?'checked':'').'> '.$langs->trans("ModeDrive").'</label> ';
print '<label for="DOLIELEC_MODE_FOOT"><input type="checkbox" id="DOLIELEC_MODE_FOOT" name="DOLIELEC_MODE_FOOT" '.($modes['foot']?'checked':'').'> '.$langs->trans("ModeFoot").'</label> ';
print '<label for="DOLIELEC_MODE_TRANSIT_TRAIN"><input type="checkbox" id="DOLIELEC_MODE_TRANSIT_TRAIN" name="DOLIELEC_MODE_TRANSIT_TRAIN" '.($modes['transit_train']?'checked':'').'> '.$langs->trans("ModeTrain").'</label> ';
print '<label for="DOLIELEC_MODE_TRANSIT_BUS"><input type="checkbox" id="DOLIELEC_MODE_TRANSIT_BUS" name="DOLIELEC_MODE_TRANSIT_BUS" '.($modes['transit_bus']?'checked':'').'> '.$langs->trans("ModeBus").'</label> ';
print '<label for="DOLIELEC_MODE_TRANSIT_METRO"><input type="checkbox" id="DOLIELEC_MODE_TRANSIT_METRO" name="DOLIELEC_MODE_TRANSIT_METRO" '.($modes['transit_metro']?'checked':'').'> '.$langs->trans("ModeMetro").'</label> ';
print '<label for="DOLIELEC_MODE_BIKE"><input type="checkbox" id="DOLIELEC_MODE_BIKE" name="DOLIELEC_MODE_BIKE" '.($modes['bike']?'checked':'').'> '.$langs->trans("ModeBike").'</label>';
print '</fieldset></td></tr>';

// === Optimizaci√≥n y evitar ===
print '<tr><td><label for="DOLIELEC_ROUTE_OPTIMIZE">'.$langs->trans("OptimizeBy").'</label></td><td><select name="DOLIELEC_ROUTE_OPTIMIZE" id="DOLIELEC_ROUTE_OPTIMIZE"><option value="time"'.($opt==='time'?' selected':'').'>'.$langs->trans("Time").'</option><option value="cost"'.($opt==='cost'?' selected':'').'>'.$langs->trans("Cost").'</option></select></td></tr>';

print '<tr class="liste_titre"><th colspan="2">'.$langs->trans("Avoid").'</th></tr>';
print '<tr><td colspan="2"><fieldset><legend class="visually-hidden">'.$langs->trans("AvoidLegend").'</legend>';
foreach(array('HIGHWAYS'=>'AvoidHighways','TOLLS'=>'AvoidTolls','FERRIES'=>'AvoidFerries','STAIRS'=>'AvoidStairs','HILLS'=>'AvoidHills','CROWDS'=>'AvoidCrowds') as $k=>$tr){
    $id='DOLIELEC_AVOID_'.$k; $c=!empty($avoid[$k])?'checked':'';
    print '<label for="'.$id.'" style="margin-right:1rem;"><input type="checkbox" id="'.$id.'" name="'.$id.'" '.$c.'> '.$langs->trans($tr).'</label>';
}
print '</fieldset></td></tr>';

print '<tr><td><label for="DOLIELEC_ROUTE_BUFFER_MIN">'.$langs->trans("RouteBufferMin").'</label></td><td><input type="number" id="DOLIELEC_ROUTE_BUFFER_MIN" name="DOLIELEC_ROUTE_BUFFER_MIN" value="'.(int)$buff.'"></td></tr>';

print '<tr><td><label for="DOLIELEC_SHOW_COST_ON_THIRDPARTY">'.$langs->trans("ShowCostOnThirdparty").'</label></td><td><input type="checkbox" id="DOLIELEC_SHOW_COST_ON_THIRDPARTY" name="DOLIELEC_SHOW_COST_ON_THIRDPARTY" '.($show?'checked':'').'> <span class="opacitymedium small">'.$langs->trans("TravelCostFreezeNotice").'</span></td></tr>';

// === COSTES base ===
print '<tr class="liste_titre"><th colspan="2">'.$langs->trans("BaseCosts").'</th></tr>';
print '<tr><td><label for="DOLIELEC_DRIVE_EUR_PER_KM">'.$langs->trans("DriveCostPerKm").'</label></td><td><input type="number" step="0.01" name="DOLIELEC_DRIVE_EUR_PER_KM" id="DOLIELEC_DRIVE_EUR_PER_KM" value="'.dol_escape_htmltag($eurkm).'"></td></tr>';
print '<tr><td><label for="DOLIELEC_PARKING_EUR_PER_H">'.$langs->trans("ParkingPerHour").'</label></td><td><input type="number" step="0.10" name="DOLIELEC_PARKING_EUR_PER_H" id="DOLIELEC_PARKING_EUR_PER_H" value="'.dol_escape_htmltag($parkh).'"></td></tr>';
print '<tr><td><label for="DOLIELEC_PT_MIN_PER_ZONE">'.$langs->trans("PtMinutesPerZone").'</label></td><td><input type="number" name="DOLIELEC_PT_MIN_PER_ZONE" id="DOLIELEC_PT_MIN_PER_ZONE" value="'.(int)$ptmin.'"></td></tr>';
// === Pol√≠tica de viaje (ida y vuelta) ===
print '<tr class="liste_titre"><th colspan="2">'.dol_escape_htmltag($langs->trans("TravelPolicy")).'</th></tr>';
print '<tr><td><label for="DOLIELEC_TRAVEL_MULTIPLIER">'.dol_escape_htmltag($langs->trans("TravelMultiplier")).' <span class="fieldrequired" aria-hidden="true">*</span></label></td>';
print '<td><input type="number" min="1" max="2" step="1" id="DOLIELEC_TRAVEL_MULTIPLIER" name="DOLIELEC_TRAVEL_MULTIPLIER" value="'.dol_escape_htmltag($multiplier).'" required aria-required="true" aria-describedby="mult_help">';
print '<div id="mult_help" class="small opacitymedium">'.dol_escape_htmltag($langs->trans("TravelMultiplierHelp")).'</div></td></tr>';
// === Billete sencillo por embarque ===
print '<tr class="liste_titre"><th colspan="2">'.dol_escape_htmltag($langs->trans("SingleTicketPerBoarding")).'</th></tr>';
print '<tr><td><label for="DOLIELEC_SINGLE_BUS_EUR">'.dol_escape_htmltag($langs->trans("SingleBusPrice")).'</label></td><td><input type="number" step="0.01" min="0" id="DOLIELEC_SINGLE_BUS_EUR" name="DOLIELEC_SINGLE_BUS_EUR" value="'.dol_escape_htmltag($single_bus).'"></td></tr>';
print '<tr><td><label for="DOLIELEC_SINGLE_METRO_EUR">'.dol_escape_htmltag($langs->trans("SingleMetroPrice")).'</label></td><td><input type="number" step="0.01" min="0" id="DOLIELEC_SINGLE_METRO_EUR" name="DOLIELEC_SINGLE_METRO_EUR" value="'.dol_escape_htmltag($single_metro).'"></td></tr>';
print '<tr><td><label for="DOLIELEC_SINGLE_TRAM_EUR">'.dol_escape_htmltag($langs->trans("SingleTramPrice")).'</label></td><td><input type="number" step="0.01" min="0" id="DOLIELEC_SINGLE_TRAM_EUR" name="DOLIELEC_SINGLE_TRAM_EUR" value="'.dol_escape_htmltag($single_tram).'"></td></tr>';
print '<tr><td><label for="DOLIELEC_SINGLE_TRAIN_EUR">'.dol_escape_htmltag($langs->trans("SingleTrainPrice")).'</label></td><td><input type="number" step="0.01" min="0" id="DOLIELEC_SINGLE_TRAIN_EUR" name="DOLIELEC_SINGLE_TRAIN_EUR" value="'.dol_escape_htmltag($single_train).'"></td></tr>';
// === Tarifas ATM/AMB ===
print '<tr class="liste_titre"><th colspan="2">'.$langs->trans("ATM_AMB_Tariffs").'</th></tr>';
print '<tr><td><label for="DOLIELEC_ATM_TITLE">'.$langs->trans("ATMBaseTitle").'</label></td><td><select name="DOLIELEC_ATM_TITLE" id="DOLIELEC_ATM_TITLE">';
foreach(array('Billete sencillo','T-Casual','T-Usual') as $optv){
    print '<option value="'.$optv.'"'.($title===$optv?' selected':'').'>'.$optv.'</option>';
}
print '</select></td></tr>';
print '<tr><td><label for="DOLIELEC_ATM_MUNI_CSV">'.$langs->trans("ATMMuniCsv").'</label></td><td><input type="text" name="DOLIELEC_ATM_MUNI_CSV" id="DOLIELEC_ATM_MUNI_CSV" class="minwidth100" value="'.dol_escape_htmltag($csv).'"> <span class="small opacitymedium">'.$langs->trans("NoOfficialApiNote").'</span></td></tr>';
print '<tr><td><label for="DOLIELEC_ATM_METRO_TARIFA">'.$langs->trans("ATMMetroTariff").'</label></td><td><input type="checkbox" name="DOLIELEC_ATM_METRO_TARIFA" id="DOLIELEC_ATM_METRO_TARIFA" '.($metro?'checked':'').'></td></tr>';

// === Redondeo & Estabilidad ===
print '<tr class="liste_titre"><th colspan="2">'.$langs->trans("RoundingStability").'</th></tr>';
print '<tr><td><label for="DOLIELEC_PRICE_ROUND_MODE">'.$langs->trans("RoundMode").'</label></td><td><select name="DOLIELEC_PRICE_ROUND_MODE" id="DOLIELEC_PRICE_ROUND_MODE"><option value="ceil"'.($round_mode==='ceil'?' selected':'').'>'.$langs->trans("RoundUp").'</option><option value="round"'.($round_mode==='round'?' selected':'').'>'.$langs->trans("RoundClassic").'</option><option value="floor"'.($round_mode==='floor'?' selected':'').'>'.$langs->trans("RoundDown").'</option></select></td></tr>';
print '<tr><td><label for="DOLIELEC_PRICE_ROUND_STEP_EUR">'.$langs->trans("RoundStepEUR").'</label></td><td><input type="number" step="0.01" name="DOLIELEC_PRICE_ROUND_STEP_EUR" id="DOLIELEC_PRICE_ROUND_STEP_EUR" value="'.dol_escape_htmltag($round_step).'"></td></tr>';
print '<tr><td><label for="DOLIELEC_PRICE_SMOOTH_EUR">'.$langs->trans("StabilityThresholdEUR").'</label></td><td><input type="number" step="0.01" name="DOLIELEC_PRICE_SMOOTH_EUR" id="DOLIELEC_PRICE_SMOOTH_EUR" value="'.dol_escape_htmltag($smooth_eur).'"></td></tr>';
print '<tr><td><label for="DOLIELEC_PRICE_SMOOTH_PCT">'.$langs->trans("StabilityThresholdPct").'</label></td><td><input type="number" step="0.1" name="DOLIELEC_PRICE_SMOOTH_PCT" id="DOLIELEC_PRICE_SMOOTH_PCT" value="'.dol_escape_htmltag($smooth_pct).'"></td></tr>';

// === Propales: presentaci√≥n ===
print '<tr class="liste_titre"><th colspan="2">'.$langs->trans("ProposalsPresentation").'</th></tr>';
print '<tr><td><label for="DOLIELEC_PROPAL_AUTOLINE">'.$langs->trans("EnableAutoLine").'</label></td><td><input type="checkbox" name="DOLIELEC_PROPAL_AUTOLINE" id="DOLIELEC_PROPAL_AUTOLINE" '.($autoline?'checked':'').'></td></tr>';
print '<tr><td><label for="DOLIELEC_TRAVEL_PRESENTATION">'.$langs->trans("TravelPresentation").'</label></td><td><select name="DOLIELEC_TRAVEL_PRESENTATION" id="DOLIELEC_TRAVEL_PRESENTATION"><option value="explicit"'.($present==='explicit'?' selected':'').'>'.$langs->trans("TravelAsSeparateLine").'</option><option value="base_fee"'.($present==='base_fee'?' selected':'').'>'.$langs->trans("TravelInBaseFee").'</option></select></td></tr>';
print '<tr><td><label for="DOLIELEC_PROPAL_LABEL">'.$langs->trans("TravelLabel").'</label></td><td><input type="text" name="DOLIELEC_PROPAL_LABEL" id="DOLIELEC_PROPAL_LABEL" value="'.dol_escape_htmltag($label).'"></td></tr>';
print '<tr><td><label for="DOLIELEC_BASE_FEE_LABEL">'.$langs->trans("BaseFeeLabel").'</label></td><td><input type="text" name="DOLIELEC_BASE_FEE_LABEL" id="DOLIELEC_BASE_FEE_LABEL" value="'.dol_escape_htmltag($baselbl).'"></td></tr>';
print '<tr><td><label for="DOLIELEC_PROPAL_VAT">'.$langs->trans("VATorTVA").'</label></td><td><input type="number" step="0.1" name="DOLIELEC_PROPAL_VAT" id="DOLIELEC_PROPAL_VAT" value="'.dol_escape_htmltag($vat).'"></td></tr>';

print '</table></div>';
print '<div class="center"><input type="submit" class="button button-save" value="'.$langs->trans("Save").'"></div>';
print '</form>';

// === JS dedicado (se encarga del toggle din√°mico) ===
$js = '/custom/dolielec/js/geoloc.js.php';
if (file_exists(DOL_DOCUMENT_ROOT . $js)) {
    $page_name = dol_buildpath($js, 1);
    print "\n<script type=\"text/javascript\" src=\"".$page_name."\"></script>\n";
}

llxFooter();

>>>file: custom/dolielec/admin/google.php
<?php
//google.php, page configuration for googleAI parameters configuration
global $db, $conf, $langs, $user;
$action = GETPOST('action', 'alpha');
$api_key = GETPOST('GOOGLE_API_KEY', 'alpha');
$model = GETPOST('GOOGLE_DEFAULT_MODEL', 'alpha');
if ($action == 'save') {
	dolibarr_set_const($db, 'GOOGLE_API_KEY', $api_key, 'chaine', 0, '', $conf->entity);
		dolibarr_set_const($db, 'GOOGLE_DEFAULT_MODEL', $model, 'chaine', 0, '', $conf->entity);
		setEventMessages($langs->trans('SetupSaved'), null, 'mesgs');
}
$api_key = getDolGlobalString('GOOGLE_API_KEY');
$model = getDolGlobalString('GOOGLE_DEFAULT_MODEL');
//$js = '/custom/dolielec/js/dolielec.js.php';
//echo "\n<script type=\"text/javascript\" src=\"".dol_buildpath($js,1)."\"></script>\n";

print '<form method="POST" action="' . $_SERVER["PHP_SELF"] . '">';
print '<input type="hidden" name="action" value="save">';
print '<div class="div-table-responsive-no-min">';
print '<table class="noborder centpercent">';
print '<tr class="liste_titre">';
print '<th class="titlefield">' . $langs->trans("Parameter") . '</th>';
print '<th>' . $langs->trans("Value") . '</th>';
print '</tr>';
print '<tr>';
print '<td><label for="google_api_key">' . $langs->trans("GOOGLE_API_KEY") . ' *</label></td>';
print '<td><input type="text" id="google_api_key" name="GOOGLE_API_KEY" class="minwidth100" required value="' . dol_escape_htmltag($api_key) . '">';
print '<button type="button" id="google_check_api" class="button">' . $langs->trans("CheckConnection") . '</button> ';
print '</td></tr>';
print '<tr>';
print '<td><label for="google_model">' . $langs->trans("GOOGLE_DEFAULT_MODEL") . ' *</label></td>';
print '<td><select name="GOOGLE_DEFAULT_MODEL" id="google_model" required>';
if (!empty($model)) print '<option value="' .dol_escape_htmltag($model) . '">' . dol_escape_htmltag($model) . '</option>';
print '</select></td>';
print '</tr>';
print '</table>';
print '</div>';
print '<div class="center">';
print '<input type="submit" class="button button-save" value="' . $langs->trans("Save") . '">';
print '</div>';
print '</form>';

?>>>>file: custom/dolielec/admin/openai.php
<?php

global $db, $conf, $langs, $user;

// Parameters

$action = GETPOST('action', 'alpha');
$api_key = GETPOST('OPENAI_API_KEY', 'alpha');
$model = GETPOST('OPENAI_DEFAULT_MODEL', 'alpha');
$temp = GETPOST('OPENAI_TEMPERATURE', 'alphanohtml');
$top_p = GETPOST('OPENAI_TOP_P', 'alphanohtml');
$freq = GETPOST('OPENAI_FREQUENCY_PENALTY', 'alphanohtml');
$presence = GETPOST('OPENAI_PRESENCE_PENALTY', 'alphanohtml');
$max_tokens = GETPOST('OPENAI_MAX_TOKENS', 'int');

if ($action == 'save') {
dolibarr_set_const($db, 'OPENAI_API_KEY', $api_key, 'chaine', 0, '', $conf->entity);
dolibarr_set_const($db, 'OPENAI_DEFAULT_MODEL', $model, 'chaine', 0, '', $conf->entity);
dolibarr_set_const($db, 'OPENAI_TEMPERATURE', $temp, 'chaine', 0, '', $conf->entity);
dolibarr_set_const($db, 'OPENAI_TOP_P', $top_p, 'chaine', 0, '', $conf->entity);
dolibarr_set_const($db, 'OPENAI_FREQUENCY_PENALTY', $freq, 'chaine', 0, '', $conf->entity);
dolibarr_set_const($db, 'OPENAI_PRESENCE_PENALTY', $presence, 'chaine', 0, '', $conf->entity);
dolibarr_set_const($db, 'OPENAI_MAX_TOKENS', $max_tokens, 'int', 0, '', $conf->entity);
setEventMessages($langs->trans("SetupSaved"), null, 'mesgs');
}
// Load current values

$api_key = getDolGlobalString('OPENAI_API_KEY', '');
$model = getDolGlobalString('OPENAI_DEFAULT_MODEL', '');
$temp = getDolGlobalString('OPENAI_TEMPERATURE', '');
$top_p = getDolGlobalString('OPENAI_TOP_P', '');
$freq = getDolGlobalString('OPENAI_FREQUENCY_PENALTY', '');
$presence = getDolGlobalString('OPENAI_PRESENCE_PENALTY', '');
$max_tokens = getDolGlobalInt('OPENAI_MAX_TOKENS', '');
// JS path (lo dejamos porque tienes planes con √©l)

//$js = '/custom/dolielec/js/dolielec.js.php';
//echo "\n<script type=\"text/javascript\" src=\"".dol_buildpath($js,1)."\"></script>\n";
// ---- Form UI (igual que el aprobado) ----

print '<form method="POST" action="' . $_SERVER["PHP_SELF"] . '">';
print '<input type="hidden" name="action" value="save">';
print '<div class="div-table-responsive-no-min">';
print '<table class="noborder centpercent">';
print '<tr class="liste_titre">';
print '<th class="titlefield">' . $langs->trans("Parameter") . '</th>';
print '<th>' . $langs->trans("Value") . '</th>';
print '</tr>';
// API Key

print '<tr>';
print '<td><label for="openai_api_key">' . $langs->trans("OPENAI_API_KEY") . ' *</label></td>';
print '<td><input type="text" id="openai_api_key" name="OPENAI_API_KEY" class="minwidth100" required value="' . dol_escape_htmltag($api_key) . '"> ';
print '<button type="button" id="openai_check_api" class="button">' . $langs->trans("CheckConnection") . '</button> ';
print '</td>';
print '</tr>';
// Model (select vac√≠o si no hay valor guardado)
print '<tr>';
print '<td><label for="openai_model">' . $langs->trans("OPENAI_DEFAULT_MODEL") . ' *</label></td>';
print '<td><select name="OPENAI_DEFAULT_MODEL" id="openai_model" required>';
if (!empty($model)) print '<option value="' . dol_escape_htmltag($model) . '">' . dol_escape_htmltag($model) . '</option>';
print '</select></td>';

print '</tr>';

// Temperature

print '<tr>';
print '<td><label for="temp">' . $langs->trans("OPENAI_TEMPERATURE") . '</label></td>';
print '<td><input type="number" step="0.01" min="0" max="2" name="OPENAI_TEMPERATURE" id="temp" placeholder="0.7" value="' . dol_escape_htmltag($temp) . '"></td>';
print '</tr>';
// Top P

print '<tr>';
print '<td><label for="top_p">' . $langs->trans("OPENAI_TOP_P") . '</label></td>';
print '<td><input type="number" step="0.01" min="0" max="1" name="OPENAI_TOP_P" id="top_p" placeholder="0.7" value="' . dol_escape_htmltag($top_p) . '"></td>';
print '</tr>';
// Frequency Penalty

print '<tr>';
print '<td><label for="freq">' . $langs->trans("OPENAI_FREQUENCY_PENALTY") . '</label></td>';
print '<td><input type="number" step="0.01" min="-2" max="2" name="OPENAI_FREQUENCY_PENALTY" id="freq" placeholder="0.5" value="' . dol_escape_htmltag($freq) . '"></td>';
print '</tr>';

// Presence Penalty

print '<tr>';
print '<td><label for="presence">' . $langs->trans("OPENAI_PRESENCE_PENALTY") . '</label></td>';
print '<td><input type="number" step="0.01" min="-2" max="2" name="OPENAI_PRESENCE_PENALTY" id="presence" placeholder="0.56" value="' . dol_escape_htmltag($presence) . '"></td>';
print '</tr>';

// Max Tokens

print '<tr>';
print '<td><label for="max_tokens">' . $langs->trans("OPENAI_MAX_TOKENS") . '</label></td>';
print '<td><input type="number" min="1" step="1" name="OPENAI_MAX_TOKENS" id="max_tokens" placeholder="2048" value="' . dol_escape_htmltag($max_tokens) . '"></td>';
print '</tr>';
print '</table>';
print '</div>';
print '<div class="center">';
print '<input type="submit" class="button button-save" value="' . $langs->trans("Save") . '">';
print '</div>';
print '</form>';

?>>>>file: custom/dolielec/admin/setup.php
<?php
$res = 0;
if (!$res) {
 $res = @include '../../main.inc.php';
if (!$res) {
 $res = @include '../../../main.inc.php';
if (!$res) {
 $res = @include '../../../../main.inc.php';
if (!$res) {
 die('Include of main fails');
 }
}
}
}
require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/functions.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/functions2.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/files.lib.php';
require_once DOL_DOCUMENT_ROOT.'/custom/dolielec/lib/dolielec.lib.php';
$langs->loadLangs(array('admin','dolielec'));
$cfg = dolielecTabsConfig();
if (!$user->admin) accessforbidden();

// Tab activa

$tab = GETPOST('tab','alpha');
if (!isset($cfg[$tab])) {
$keys = array_keys($cfg);
$tab = reset($keys);
}
// Header
$help_url = '';

llxHeader('', $langs->trans('DoliElecSetup'), $help_url);

// T√≠tulo + back

$linkback = '<a href="'.DOL_URL_ROOT.'/admin/modules.php">'.$langs->trans('BackToModuleList').'</a>';

print load_fiche_titre($langs->trans('DoliElecSetup'), $linkback, 'title_setup');

// Pesta√±as

$head = dolielecAdminPrepareHead();
 dol_fiche_head($head, $tab, $langs->trans('DoliElecSetup'), -1, 'dolielec@dolielec');
$base = __DIR__;
include $base.'/'.$cfg[$tab][1];
$js = '/custom/dolielec/js/dolielec.js.php';
echo "\n<script type=\"text/javascript\" src=\"".dol_buildpath($js,1)."\"></script>\n";
dol_fiche_end();
llxFooter();

>>>file: custom/dolielec/ajax/anthropic.ajax.php
<?php
$res = @include '../../main.inc.php';
if (!$res) $res = @include '../../../main.inc.php';
if (!$res) {
    header('Content-Type: application/json');
    die(json_encode(array('error' => 'main.inc.php not found')));
}
require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
require_once DOL_DOCUMENT_ROOT.'/custom/dolielec/lib/dolielec.lib.php';
require_once DOL_DOCUMENT_ROOT.'/custom/dolielec/class/anthropic.class.php';
global $user, $conf, $langs, $db;
$langs->loadLangs(array('admin','dolielec'));
if (!$user->admin && empty($user->rights->dolielec->read)) {
    header('Content-Type: application/json');
    echo json_encode(array('error' => 'Access denied'));
    exit;
}
$action  = GETPOST('action', 'aZ09');
$api_key = GETPOST('api_key', 'alphanohtml');
if (!empty($api_key)) {
    $conf->global->ANTHROPIC_API_KEY = $api_key;
}
header('Content-Type: application/json');
switch ($action) {
    case 'check_api_conn':
        $claude = new ClaudeAI($db);
        $result = $claude->getModels($api_key);
        if (!empty($result['success'])) {
                        echo json_encode(array(
                'success' => true,
                'models' => $result['models']));
            exit;
        }
                echo json_encode(array(
            'success' => false,
            'message' => $result['message'] ?? $langs->trans('ConnectionFailed'),
            'http' => $result['http']    ?? null,
            'raw' => isset($result['raw']) ? (is_string($result['raw']) ? substr($result['raw'],0,2048) : null) : null
        ));
        exit;
    default:
        echo json_encode(array('error' => 'Unknown action'));
        exit;
}

>>>file: custom/dolielec/ajax/doc.ajax.php
<?php
// custom/dolielec/ajax/doc.ajax.php
$res = 0;
if (!$res && file_exists("../../main.inc.php"))  $res = @include("../../main.inc.php");
if (!$res && file_exists("../../../main.inc.php")) $res = @include("../../../main.inc.php");
if (!$res && file_exists("../../../../main.inc.php")) $res = @include("../../../../main.inc.php");
if (!$res) die("Include of main fails");

require_once DOL_DOCUMENT_ROOT.'/core/lib/files.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/security.lib.php';
require_once DOL_DOCUMENT_ROOT.'/societe/class/societe.class.php';
require_once DOL_DOCUMENT_ROOT.'/custom/dolielec/class/doc.class.php';

global $db, $conf, $langs, $user;
$langs->loadLangs(array('main','companies','dolielec@dolielec'));

if (empty($user->rights->dolielec->read)) accessforbidden();

$action = GETPOST('action','alpha');

// rutas base
$modroot   = !empty($conf->dolielec->dir_output) ? $conf->dolielec->dir_output : DOL_DATA_ROOT.'/dolielec';
$tmpDir    = $modroot.'/var/tmp';
$signedDir = $modroot.'/docs/signed';
$tplBrie   = DOL_DATA_ROOT.'/doctemplates/dolielec/brie_template.odt';
dol_mkdir($tmpDir); dol_mkdir($signedDir);

switch ($action) {
case 'brie_save': // flujo completo por AJAX
	header('Content-Type: application/json; charset=UTF-8');

	if (empty($user->rights->dolielec->write) && empty($user->admin)) {
		echo json_encode(array('success'=>false,'message'=>$langs->trans('NotEnoughPermissions'))); exit;
	}
	$token = GETPOST('token','alphanohtml');
	if (empty($token) || !dol_verifyToken($token)) {
		echo json_encode(array('success'=>false,'message'=>$langs->trans('ErrorBadToken'))); exit;
	}
	if (!is_readable($tplBrie)) {
		echo json_encode(array('success'=>false,'message'=>$langs->trans('TemplateNotFound').' '.$tplBrie)); exit;
	}

	$socid = GETPOST('socid','int');
	$form  = GETPOST('form','array');
	$out   = GETPOST('out','array');

	$doc  = new Documentation($db);
	$data = $doc->setBrie($form, $socid);

	// destinatarios
	$targets = array();
	if (!empty($out['TITULAR']))       $targets[] = 'TITULAR';
	if (!empty($out['DISTRIBUIDORA'])) $targets[] = 'DISTRIBUIDORA';
	if (!empty($out['INSTALADOR']))    $targets[] = 'INSTALADOR';
	if (empty($targets)) $targets = array('TITULAR');

	$cupsSafe = dol_sanitizeFileName(!empty($data['CUPS']) ? $data['CUPS'] : 'SIN_CUPS');
	$dateSafe = dol_print_date(dol_now(), '%Y%m%d');
	$baseName = 'brie_'.$cupsSafe.'_'.$dateSafe;

	$files = array();
	foreach ($targets as $tg) {
		$fname  = $baseName.'_'.$tg;
		$odtOut = $tmpDir.'/'.$fname.'.odt';
		$pdfTmp = $tmpDir.'/'.$fname.'.pdf';
		$signed = $signedDir.'/'.$fname.'-signed.pdf';

		$r1 = $doc->renderODT($tplBrie, $odtOut, $data);
		if (empty($r1['success'])) { echo json_encode(array('success'=>false,'message'=>'ODT: '.$r1['message'])); exit; }

		$r2 = $doc->odtToPdf($odtOut, $pdfTmp);
	if (empty($r2['success'])) { echo json_encode(array('success'=>false,'message'=>'PDF: '.$r2['message'])); exit; }

		$ok = $doc->setSign($pdfTmp, $signed);
		if (!$ok || !is_readable($signed)) { echo json_encode(array('success'=>false,'message'=>$langs->trans('SignFailed'))); exit; }

		$files[] = array(
			'name'   => basename($signed),
			'path'   => $signed,
			'public' => dol_buildpath('/document.php',1).'?modulepart=dolielec&file='.urlencode('docs/signed/'.basename($signed))
		);
	}

	// ECM opcional
	if (!empty($socid) && !empty($out['DEST']) && $out['DEST']==='ECM') {
		foreach ($files as $f) { $doc->attachToThirdparty($socid, $f['path']); }
	}

	echo json_encode(array('success'=>true,'files'=>$files));
	exit;

case 'signPdf': // firma suelta (subida input file) ‚Üí devuelve blob/pdf
	if (empty($user->rights->dolielec->write) && empty($user->admin)) accessforbidden();

	if (empty($_FILES['file_pdf']['tmp_name']) || !is_uploaded_file($_FILES['file_pdf']['tmp_name'])) {
		header('Content-Type: application/json; charset=UTF-8');
		echo json_encode(array('success'=>false,'message'=>$langs->trans('BadParams'))); exit;
	}

	$srcTmp = $tmpDir.'/upload_'.dol_print_date(dol_now(),'dayhourlog').'_'.dol_sanitizeFileName($_FILES['file_pdf']['name']);
	if (!dol_move_uploaded_file($_FILES['file_pdf']['tmp_name'], $srcTmp, 1, 0, $_FILES['file_pdf']['error'])) {
		header('Content-Type: application/json; charset=UTF-8');
		echo json_encode(array('success'=>false,'message'=>$langs->trans('ErrorFileUpload'))); exit;
	}

	$dest = preg_replace('/\.pdf$/i','-signed.pdf',$srcTmp);
	$doc  = new Documentation($db);
	$ok   = $doc->setSign($srcTmp, $dest);
	if (!$ok || !is_readable($dest)) {
		header('Content-Type: application/json; charset=UTF-8');
		echo json_encode(array('success'=>false,'message'=>$langs->trans('SignFailed'))); exit;
	}

	header('Content-Type: application/pdf');
	header('Content-Disposition: attachment; filename="'.dol_escape_htmltag(basename($dest)).'"');
	header('Content-Length: '.filesize($dest));
	readfile($dest);
	exit;

default:
	header('Content-Type: application/json; charset=UTF-8');
	echo json_encode(array('success'=>false,'message'=>'Unknown action')); exit;
}

>>>file: custom/dolielec/ajax/google.ajax.php
<?php
$res = @include '../../main.inc.php';
if (!$res) $res = @include '../../../main.inc.php';
if (!$res) {
    header('Content-Type: application/json');
    die(json_encode(array('error' => 'main.inc.php not found')));
}
require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
require_once DOL_DOCUMENT_ROOT.'/custom/dolielec/lib/dolielec.lib.php';
require_once DOL_DOCUMENT_ROOT.'/custom/dolielec/class/google.class.php';
global $user, $conf, $langs, $db;
$langs->loadLangs(array('admin','dolielec'));
if (!$user->admin && empty($user->rights->dolielec->read)) {
    header('Content-Type: application/json');
    echo json_encode(array('error' => 'Access denied'));
    exit;
}
$action  = GETPOST('action', 'aZ09');
$api_key = GETPOST('api_key', 'alphanohtml');
if (!empty($api_key)) {
    $conf->global->GOOGLE_API_KEY = $api_key;
}
header('Content-Type: application/json');
switch ($action) {
    case 'check_api_conn':
        $google = new GoogleAI($db);
        $result = $google->getModels($api_key);
        if (!empty($result['success'])) {
                        echo json_encode(array(
                'success' => true,
                'models' => $result['models']));
            exit;
        }
                echo json_encode(array(
            'success' => false,
            'message' => $result['message'] ?? $langs->trans('ConnectionFailed'),
            'http' => $result['http']    ?? null,
            'raw' => isset($result['raw']) ? (is_string($result['raw']) ? substr($result['raw'],0,2048) : null) : null
        ));
        exit;
    default:
        echo json_encode(array('error' => 'Unknown action'));
        exit;
}

>>>file: custom/dolielec/ajax/openai.ajax.php
<?php
$res = @include '../../main.inc.php';
if (!$res) $res = @include '../../../main.inc.php';
if (!$res) {
    header('Content-Type: application/json');
    die(json_encode(array('error' => 'main.inc.php not found')));
}
require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
require_once DOL_DOCUMENT_ROOT.'/custom/dolielec/lib/dolielec.lib.php';
require_once DOL_DOCUMENT_ROOT.'/custom/dolielec/class/openai.class.php';
global $user, $conf, $langs, $db;
$langs->loadLangs(array('admin','dolielec'));
if (!$user->admin && empty($user->rights->dolielec->read)) {
    header('Content-Type: application/json');
    echo json_encode(array('error' => 'Access denied'));
    exit;
}
$action  = GETPOST('action', 'aZ09');
$api_key = GETPOST('api_key', 'alphanohtml');
if (!empty($api_key)) {
    $conf->global->OPENAI_API_KEY = $api_key;
}
header('Content-Type: application/json');
switch ($action) {
    case 'check_api_conn':
        $openai = new OpenAI($db);
        $result = $openai->getModels($api_key);
        if (!empty($result['success'])) {
                        echo json_encode(array(
                'success' => true,
                'models' => $result['models']));
            exit;
        }
                echo json_encode(array(
            'success' => false,
            'message' => $result['message'] ?? $langs->trans('ConnectionFailed'),
            'http' => $result['http']    ?? null,
            'raw' => isset($result['raw']) ? (is_string($result['raw']) ? substr($result['raw'],0,2048) : null) : null
        ));
        exit;
    default:
        echo json_encode(array('error' => 'Unknown action'));
        exit;
}

>>>file: custom/dolielec/calc/homeoffices.php
<?php
$res = 0;
if (!$res) {
 $res = @include '../../main.inc.php';
if (!$res) {
 $res = @include '../../../main.inc.php';
if (!$res) {
 $res = @include '../../../../main.inc.php';
if (!$res) {
 die('Include of main fails');
 }
}
}
}

require_once DOL_DOCUMENT_ROOT.'/custom/dolielec/lib/dolielec.lib.php';
global $conf, $db, $langs, $user;
$langs->load('dolielec@dolielec');
$action = GETPOST('action', 'alpha');
if ($action === 'calculate') {
    $params = GETPOST('params', 'array');
    $result = getPower($params);

    print '<div class="div-table-responsive-no-min">';
    print '<table class="noborder centpercent">';
    print '<tr class="liste_titre">';
    print '<th>' . $langs->trans("CalculationResult") . '</th>';
    print '</tr>';
    print '<tr>';
    print '<td>';
    if (!empty($result['success']) && isset($result['value'])) {
        print '<strong>' . $langs->trans("TotalPower") . ': ' . dol_escape_htmltag($result['value']) . ' kW</strong>';
    }
	else {
        print '<span class="error">' . dol_escape_htmltag($result['message'] ?? 'Unknown error') . '</span>';
    }
    print '</td>';
    print '</tr>';
    print '</table>';
    print '</div>';
}

print '<form method="POST" action="' . $_SERVER["PHP_SELF"] . '">';
print '<input type="hidden" name="action" value="calculate">';
print '<div class="div-table-responsive-no-min">';
print '<table class="noborder centpercent">';
print '<tr class="liste_titre">';
print '<th class="titlefield">' . $langs->trans("Parameter") . '</th>';
print '<th>' . $langs->trans("Value") . '</th>';
print '</tr>';

// Homes
print '<tr>';
print '<td><label for="nh">' . $langs->trans("NumberOfHomes") . ' *</label></td>';
print '<td><input type="number" id="nh" name="params[home][nh]" min="0" step="1" required></td>';
print '</tr>';

print '<tr>';
print '<td><label for="basic">' . $langs->trans("BasicHomes") . '</label></td>';
print '<td><input type="number" id="basic" name="params[home][basic]" min="0" step="1" placeholder="0"></td>';
print '</tr>';

// Services
print '<tr>';
print '<td><label for="elevation">' . $langs->trans("Elevators") . '</label></td>';
print '<td><input type="number" id="elevation" name="params[service][elevation]" min="0" step="1"></td>';
print '</tr>';

print '<tr>';
print '<td>' . $langs->trans("Engines") . '</td>';
print '<td><fieldset><legend class="sr-only">' . $langs->trans("Engines") . '</legend>';
for ($i = 0; $i < 3; $i++) {
    $id = 'engine_' . $i;
    print '<input type="number" id="' . $id . '" 
        name="params[service][engines][]" 
        min="0" step="0.1" class="minwidth50" 
        placeholder="kW" 
        aria-label="' . $langs->trans("Engine") . ' ' . ($i+1) . '"> ';
}
print '</fieldset></td>';
print '</tr>';

print '<tr>';
print '<td><label for="led">' . $langs->trans("LightingPowerW") . '</label></td>';
print '<td><input type="number" id="led" name="params[service][led]" min="0" step="1" placeholder="W"></td>';
print '</tr>';

// Offices
print '<tr>';
print '<td><label for="pl">' . $langs->trans("NumberOfPremises") . '</label></td>';
print '<td><input type="number" id="pl" name="params[office][pl]" min="0" step="1"></td>';
print '</tr>';

print '<tr>';
print '<td>' . $langs->trans("PremisesSurfaceM2") . '</td>';
print '<td><fieldset><legend class="sr-only">' . $langs->trans("PremisesSurfaceM2") . '</legend>';
for ($i = 0; $i < 3; $i++) {
    $id = 'surface_' . $i;
    print '<input type="number" id="' . $id . '" 
        name="params[office][metter][]" 
        min="0" step="1" class="minwidth50" 
        placeholder="m¬≤" 
        aria-label="' . $langs->trans("PremiseSurface") . ' ' . ($i+1) . '"> ';
}
print '</fieldset></td>';
print '</tr>';

// Garage
print '<tr>';
print '<td><label for="npl">' . $langs->trans("NumberOfParkingLots") . '</label></td>';
print '<td><input type="number" id="npl" name="params[garage][npl]" min="0" step="1"></td>';
print '</tr>';

print '<tr>';
print '<td><label for="area">' . $langs->trans("AverageAreaPerLotM2") . '</label></td>';
print '<td><input type="number" id="area" name="params[garage][area]" min="0" step="1" placeholder="20"></td>';
print '</tr>';

print '<tr>';
print '<td><label for="ev">' . $langs->trans("ElectricVehicleCharger") . '</label></td>';
print '<td><select name="params[garage][ev]" id="ev">
<option value="">' . $langs->trans("DefaultYes") . '</option>
<option value="1">' . $langs->trans("Yes") . '</option>
<option value="0">' . $langs->trans("No") . '</option>
</select></td>';
print '</tr>';

print '<tr>';
print '<td><label for="winn">' . $langs->trans("ForcedVentilation") . '</label></td>';
print '<td><select name="params[garage][winn]" id="winn">
<option value="">' . $langs->trans("DefaultYes") . '</option>
<option value="1">' . $langs->trans("Yes") . '</option>
<option value="0">' . $langs->trans("No") . '</option>
</select></td>';
print '</tr>';

print '</table>';
print '</div>';

print '<div class="center">';
print '<input type="submit" class="button button-save" value="' . $langs->trans("Calculate") . '">';
print '</div>';
print '</form>';

?>>>>file: custom/dolielec/class/actions_dolielec.class.php
<?php
/* Copyright (C) 2023		Laurent Destailleur			<eldy@users.sourceforge.net>
 * Copyright (C) ---Replace with your own copyright and developer email---
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

/**
 * \file    htdocs/modulebuilder/template/class/actions_mymodule.class.php
 * \ingroup mymodule
 * \brief   Example hook overload.
 *
 * TODO: Write detailed description here.
 */

require_once DOL_DOCUMENT_ROOT.'/core/class/commonhookactions.class.php';

/**
 * Class ActionsMyModule
 */
class ActionsDolielec extends CommonHookActions
{
	/**
	 * @var DoliDB Database handler.
	 */
	public $db;

	/**
	 * @var string Error code (or message)
	 */
	public $error = '';

	/**
	 * @var string[] Errors
	 */
	public $errors = array();


	/**
	 * @var mixed[] Hook results. Propagated to $hookmanager->resArray for later reuse
	 */
	public $results = array();

	/**
	 * @var ?string String displayed by executeHook() immediately after return
	 */
	public $resprints;

	/**
	 * @var int		Priority of hook (50 is used if value is not defined)
	 */
	public $priority;


	/**
	 * Constructor
	 *
	 *  @param	DoliDB	$db      Database handler
	 */
	public function __construct($db) {
						$this->db = $db;
						global $langs;
						    if (isset($langs) && is_object($langs)) {
        $langs->loadLangs(array('main','admin','dolielec@dolielec'));
    }
	}


	/**
	 * Execute action
	 *
	 * @param	array<string,mixed>	$parameters	Array of parameters
	 * @param	CommonObject		$object		The object to process (an invoice if you are in invoice module, a propale in propale's module, etc...)
	 * @param	string				$action		'add', 'update', 'view'
	 * @return	int								Return integer <0 if KO,
	 *                           				=0 if OK but we want to process standard actions too,
	 *											>0 if OK and we want to replace standard actions.
	 */
	public function getNomUrl($parameters, &$object, &$action)
	{
		global $db, $langs, $conf, $user;
		$this->resprints = '';
		return 0;
	}

	/**
	 * Overload the doActions function : replacing the parent's function with the one below
	 *
	 * @param	array<string,mixed>	$parameters		Hook metadata (context, etc...)
	 * @param	CommonObject		$object			The object to process (an invoice if you are in invoice module, a propale in propale's module, etc...)
	 * @param	?string				$action			Current action (if set). Generally create or edit or null
	 * @param	HookManager			$hookmanager	Hook manager propagated to allow calling another hook
	 * @return	int									Return integer < 0 on error, 0 on success, 1 to replace standard code
	 */
	     public function formObjectOptions($parameters, &$object, &$action, $hookmanager)
    {
        global $langs;
        $context = is_array($parameters['context']) ? $parameters['context'] : array();
        if (!empty($object) && !empty($object->id) && in_array('thirdpartycard', $context) && GETPOST('tab','alpha') == 'documents') {
                        $url = dol_buildpath('/custom/dolielec/includes/certificates.inc.php', 1).'?action=brie&socid='.$object->id;
            print '<div class="tabBar">';
            print '<a class="butAction" href="'.$url.'">'.$langs->trans('NewBRIE').'</a>';
            print '</div>';
        }
        return 0;
    }

	public function doActions($parameters, &$object, &$action, $hookmanager)
	{
		global $langs, $user;
		$error = 0; // Error counter

		/* print_r($parameters); print_r($object); echo "action: " . $action; */
if (!empty($parameters['currentcontext']) && $parameters['currentcontext'] === 'external') {
	if (is_object($object) && $object->element === 'ticket') {
		$titulo = dol_strtolower($object->subject);
		$mensaje = dol_strtolower($object->message);
		if (preg_match('/presupuesto|instalaci[o√≥]n/', $titulo . ' ' . $mensaje)) {
															// Evitar m√∫ltiples respuestas autom√°ticas
			if (empty($object->note_private) || strpos($object->note_private, 'BIEL_AUTO_RESPONDIDO') === false) {
								$response = "Estimado cliente, gracias por contactar. Para poder prepararte un presupuesto ajustado necesitamos estos datos:\n\n";
				$response .= "- Nombre completo y apellidos\n";
				$response .= "- Direcci√≥n completa (calle, n√∫mero, piso‚Ä¶)\n";
				$response .= "- Ciudad, provincia\n";
				$response .= "- Tel√©fono o m√≥vil\n";
				$response .= "- Correo electr√≥nico\n";
				$response .= "- DNI, NIE o tarjeta de residencia\n";
				$response .= "- Y si eres particular, empresa, aut√≥nomo o comunidad de vecinos\n\n";
				$response .= "En cuanto tengamos esto, creamos la ficha y seguimos. Esto es necesario e imprescindible para darte una atenci√≥n personalizada.";

				// Crear respuesta autom√°tica
				$object->addResponse($user, dol_htmlentities($response), 'Biel', '', '', 0, '', 0, '', '', 0, '', 0);


				// Marcar como respondido
				$object->note_private = trim($object->note_private."\n\nBIEL_AUTO_RESPONDIDO");
				$object->update($user);

				$this->resprints = ''; // no se imprime nada
			}
		}
	}
}

		return 0;
	}


	/**
	 * Overload the doMassActions function : replacing the parent's function with the one below
	 *
	 * @param	array<string,mixed>	$parameters		Hook metadata (context, etc...)
	 * @param	CommonObject		$object			The object to process (an invoice if you are in invoice module, a propale in propale's module, etc...)
	 * @param	?string				$action			Current action (if set). Generally create or edit or null
	 * @param	HookManager			$hookmanager	Hook manager propagated to allow calling another hook
	 * @return	int									Return integer < 0 on error, 0 on success, 1 to replace standard code
	 */
	public function doMassActions($parameters, &$object, &$action, $hookmanager)
	{
		global $conf, $user, $langs;

		$error = 0; // Error counter

		/* print_r($parameters); print_r($object); echo "action: " . $action; */
		if (in_array($parameters['currentcontext'], array('somecontext1', 'somecontext2'))) {		// do something only for the context 'somecontext1' or 'somecontext2'
			// @phan-suppress-next-line PhanPluginEmptyStatementForeachLoop
			foreach ($parameters['toselect'] as $objectid) {
				// Do action on each object id
			}

			if (!$error) {
				$this->results = array('myreturn' => 999);
				$this->resprints = 'A text to show';
				return 0; // or return 1 to replace standard code
			} else {
				$this->errors[] = 'Error message';
				return -1;
			}
		}

		return 0;
	}


	/**
	 * Overload the addMoreMassActions function : replacing the parent's function with the one below
	 *
	 * @param	array<string,mixed>	$parameters     Hook metadata (context, etc...)
	 * @param	CommonObject		$object         The object to process (an invoice if you are in invoice module, a propale in propale's module, etc...)
	 * @param	?string	$action						Current action (if set). Generally create or edit or null
	 * @param	HookManager	$hookmanager			Hook manager propagated to allow calling another hook
	 * @return	int									Return integer < 0 on error, 0 on success, 1 to replace standard code
	 */
	public function addMoreMassActions($parameters, &$object, &$action, $hookmanager)
	{
		global $conf, $user, $langs;

		$error = 0; // Error counter
		$disabled = 1;

		/* print_r($parameters); print_r($object); echo "action: " . $action; */
		if (in_array($parameters['currentcontext'], array('somecontext1', 'somecontext2'))) {		// do something only for the context 'somecontext1' or 'somecontext2'
			$this->resprints = '<option value="0"'.($disabled ? ' disabled="disabled"' : '').'>'.$langs->trans("MyModuleMassAction").'</option>';
		}

		if (!$error) {
			return 0; // or return 1 to replace standard code
		} else {
			$this->errors[] = 'Error message';
			return -1;
		}
	}



		/**
	 * Execute action before PDF (document) creation
	 *
	 * @param	array<string,mixed>	$parameters	Array of parameters
	 * @param	CommonObject		$object		Object output on PDF
	 * @param	string				$action		'add', 'update', 'view'
	 * @return	int								Return integer <0 if KO,
	 *											=0 if OK but we want to process standard actions too,
	 *											>0 if OK and we want to replace standard actions.
	 */
	public function beforePDFCreation($parameters, &$object, &$action)
	{
		global $conf, $user, $langs;
		global $hookmanager;

		$outputlangs = $langs;

		$ret = 0;
		$deltemp = array();
		dol_syslog(get_class($this).'::executeHooks action='.$action);

		/* print_r($parameters); print_r($object); echo "action: " . $action; */
		// @phan-suppress-next-line PhanPluginEmptyStatementIf
		if (in_array($parameters['currentcontext'], array('somecontext1', 'somecontext2'))) {
			// do something only for the context 'somecontext1' or 'somecontext2'
		}

		return $ret;
	}

	/**
	 * Execute action after PDF (document) creation
	 *
	 * @param	array<string,mixed>	$parameters	Array of parameters
	 * @param	CommonDocGenerator	$pdfhandler	PDF builder handler
	 * @param	string				$action		'add', 'update', 'view'
	 * @return	int								Return integer <0 if KO,
	 * 											=0 if OK but we want to process standard actions too,
	 *											>0 if OK and we want to replace standard actions.
	 */
	public function afterPDFCreation($parameters, &$pdfhandler, &$action)
	{
		global $conf, $user, $langs;
		global $hookmanager;

		$outputlangs = $langs;

		$ret = 0;
		$deltemp = array();
		dol_syslog(get_class($this).'::executeHooks action='.$action);

		/* print_r($parameters); print_r($object); echo "action: " . $action; */
		// @phan-suppress-next-line PhanPluginEmptyStatementIf
		if (in_array($parameters['currentcontext'], array('somecontext1', 'somecontext2'))) {
			// do something only for the context 'somecontext1' or 'somecontext2'
		}

		return $ret;
	}



	/**
	 * Overload the loadDataForCustomReports function : returns data to complete the customreport tool
	 *
	 * @param	array<string,mixed>	$parameters		Hook metadata (context, etc...)
	 * @param	?string				$action 		Current action (if set). Generally create or edit or null
	 * @param	HookManager			$hookmanager    Hook manager propagated to allow calling another hook
	 * @return	int									Return integer < 0 on error, 0 on success, 1 to replace standard code
	 */
	public function loadDataForCustomReports($parameters, &$action, $hookmanager)
	{
		global $langs;

		$langs->load("mymodule@mymodule");

		$this->results = array();

		$head = array();
		$h = 0;

		if ($parameters['tabfamily'] == 'mymodule') {
			$head[$h][0] = dol_buildpath('/module/index.php', 1);
			$head[$h][1] = $langs->trans("Home");
			$head[$h][2] = 'home';
			$h++;

			$this->results['title'] = $langs->trans("MyModule");
			$this->results['picto'] = 'mymodule@mymodule';
		}

		$head[$h][0] = 'customreports.php?objecttype='.$parameters['objecttype'].(empty($parameters['tabfamily']) ? '' : '&tabfamily='.$parameters['tabfamily']);
		$head[$h][1] = $langs->trans("CustomReports");
		$head[$h][2] = 'customreports';

		$this->results['head'] = $head;

		$arrayoftypes = array();
		//$arrayoftypes['mymodule_myobject'] = array('label' => 'MyObject', 'picto'=>'myobject@mymodule', 'ObjectClassName' => 'MyObject', 'enabled' => isModEnabled('mymodule'), 'ClassPath' => "/mymodule/class/myobject.class.php", 'langs'=>'mymodule@mymodule')

		$this->results['arrayoftype'] = $arrayoftypes;

		return 0;
	}



	/**
	 * Overload the restrictedArea function : check permission on an object
	 *
	 * @param	array<string,mixed>	$parameters		Hook metadata (context, etc...)
	 * @param   CommonObject    	$object         The object to process (an invoice if you are in invoice module, a propale in propale's module, etc...)
	 * @param	string				$action			Current action (if set). Generally create or edit or null
	 * @param	HookManager			$hookmanager	Hook manager propagated to allow calling another hook
	 * @return	int									Return integer <0 if KO,
	 *												=0 if OK but we want to process standard actions too,
	 *												>0 if OK and we want to replace standard actions.
	 */
	public function restrictedArea($parameters, $object, &$action, $hookmanager)
	{
		global $user;

		if ($parameters['features'] == 'myobject') {
			if ($user->hasRight('mymodule', 'myobject', 'read')) {
				$this->results['result'] = 1;
				return 1;
			} else {
				$this->results['result'] = 0;
				return 1;
			}
		}

		return 0;
	}

	/**
	 * Execute action completeTabsHead
	 *
	 * @param	array<string,mixed>	$parameters		Array of parameters
	 * @param	CommonObject		$object			The object to process (an invoice if you are in invoice module, a propale in propale's module, etc...)
	 * @param	string				$action			'add', 'update', 'view'
	 * @param	Hookmanager			$hookmanager	Hookmanager
	 * @return	int									Return integer <0 if KO,
	 *												=0 if OK but we want to process standard actions too,
	 *												>0 if OK and we want to replace standard actions.
	 */
	public function completeTabsHead(&$parameters, &$object, &$action, $hookmanager)
	{
		global $langs, $conf, $user;

		if (!isset($parameters['object']->element)) {
			return 0;
		}
		if ($parameters['mode'] == 'remove') {
			// used to make some tabs removed
			return 0;
		} elseif ($parameters['mode'] == 'add') {
			$langs->load('mymodule@mymodule');
			// used when we want to add some tabs
			$counter = count($parameters['head']);
			$element = $parameters['object']->element;
			$id = $parameters['object']->id;
			// verifier le type d'onglet comme member_stats o√π √ßa ne doit pas apparaitre
			// if (in_array($element, ['societe', 'member', 'contrat', 'fichinter', 'project', 'propal', 'commande', 'facture', 'order_supplier', 'invoice_supplier'])) {
			if (in_array($element, ['context1', 'context2'])) {
				$datacount = 0;

				$parameters['head'][$counter][0] = dol_buildpath('/mymodule/mymodule_tab.php', 1) . '?id=' . $id . '&amp;module='.$element;
				$parameters['head'][$counter][1] = $langs->trans('MyModuleTab');
				if ($datacount > 0) {
					$parameters['head'][$counter][1] .= '<span class="badge marginleftonlyshort">' . $datacount . '</span>';
				}
				$parameters['head'][$counter][2] = 'mymoduleemails';
				$counter++;
			}
			if ($counter > 0 && (int) DOL_VERSION < 14) {  // @phpstan-ignore-line
				$this->results = $parameters['head'];
				// return 1 to replace standard code
				return 1;
			} else {
				// From V14 onwards, $parameters['head'] is modifiable by reference
				return 0;
			}
		} else {
			// Bad value for $parameters['mode']
			return -1;
		}
	}


	/**
	 * Overload the showLinkToObjectBlock function : add or replace array of object linkable
	 *
	 * @param	array<string,mixed>	$parameters		Hook metadata (context, etc...)
	 * @param	CommonObject		$object			The object to process (an invoice if you are in invoice module, a propale in propale's module, etc...)
	 * @param	?string				$action			Current action (if set). Generally create or edit or null
	 * @param	HookManager			$hookmanager	Hook manager propagated to allow calling another hook
	 * @return	int									Return integer < 0 on error, 0 on success, 1 to replace standard code
	 */
	/* Add other hook methods here... */
}

>>>file: custom/dolielec/class/anthropic.class.php
<?php
require_once DOL_DOCUMENT_ROOT.'/core/lib/functions.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/functions2.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
require_once DOL_DOCUMENT_ROOT.'/custom/dolielec/lib/dolielec.lib.php';

class ClaudeAI {
    private $db;
    private $api_key;
    private $endpoint;

    public function __construct($db) {
        global $conf, $langs;
        $langs->loadLangs(array('dolielec@dolielec'));
        $this->db = $db;
        $this->api_key = !empty($conf->global->ANTHROPIC_API_KEY) ? $conf->global->ANTHROPIC_API_KEY : getDolGlobalString('ANTHROPIC_API_KEY', '');
        $this->endpoint = 'https://api.anthropic.com/v1/';
    }

    private function call($path, $method = 'GET', $data = null, $api = '') {
        global $langs;
        $api = ($api !== '') ? $api : $this->api_key;
        if (empty($api)) {
            return array('success' => false, 'message' => $langs->trans('MissingAPIKey'));
        }
        $url = $this->endpoint . ltrim($path, '/');
        $opts = array(
            'method' => $method,
            'headers' => array(
                'x-api-key: '.$api,
                'anthropic-version: 2023-06-01',
                'content-type: application/json'
            ),
            'accept_json' => 1,
            'decode_json' => 1,
            'timeout' => 30,
        );
        if ($method === 'POST' && $data !== null) {
            $opts['body'] = $data;
            $opts['json_body'] = 1;
        }
        $resp = apicall($url, $opts);
        if (empty($resp) || empty($resp['success'])) {
            return array(
                'success' => false,
                'message' => isset($resp['message']) ? $resp['message'] : $langs->trans('ConnectionFailed'),
                'http' => isset($resp['http']) ? $resp['http'] : null,
                'raw' => isset($resp['raw']) ? $resp['raw'] : null,
            );
        }
        return array(
            'success' => true,
            'http' => isset($resp['http']) ? $resp['http'] : 200,
            'json' => isset($resp['json']) ? $resp['json'] : null,
            'raw' => isset($resp['raw']) ? $resp['raw'] : null,
        );
    }

    public function getModels($api = '') {
        global $langs;
        $resp = $this->call('models', 'GET', null, $api);
        if (empty($resp['success'])) {
            return $resp;
        }
        $json = isset($resp['json']) ? $resp['json'] : null;
        if (!is_array($json) || empty($json['data']) || !is_array($json['data'])) {
            return array('success' => false, 'message' => $langs->trans('NoModels'), 'http' => $resp['http'] ?? null, 'raw' => $resp['raw'] ?? null);
        }
        $blocked_patterns = array();
        $filtered = array();
        foreach ($json['data'] as $m) {
            $id = is_array($m) ? ($m['id'] ?? '') : (string)$m;
            if ($id === '') {
                continue;
            }
            $blocked = false;
            foreach ($blocked_patterns as $pattern) {
                if (stripos($id, $pattern) !== false) {
                    $blocked = true;
                    break;
                }
            }
            if (!$blocked) {
                $filtered[] = $id;
            }
        }
        $filtered = array_values(array_unique($filtered));
        if (empty($filtered)) {
            return array('success' => false, 'message' => $langs->trans('NoModels'));
        }
        return array('success' => true, 'models' => $filtered);
    }

    public function setPrompt($temp = null, $top = null, $model = null, $reason = null, $maxt = null, $system = '', $user = '', $tools = null, $api = '') {
        $api = ($api !== '') ? $api : $this->api_key;
        $temp = ($temp !== null) ? $temp : getDolGlobalFloat('ANTHROPIC_TEMPERATURE', 1.0);
        $model = (!empty($model)) ? $model : getDolGlobalString('ANTHROPIC_DEFAULT_MODEL');
        $maxt = ($maxt !== null) ? $maxt : getDolGlobalInt('ANTHROPIC_MAX_TOKENS', 4096);
                $data = array(
            'model' => $model,
            'max_tokens' => $maxt,
            'system' => $system,
            'messages' => array(array('role' => 'user', 'content' => $user))
        );
        
        if (is_array($tools) && !empty($tools)) {
            if (isset($tools['type']) || isset($tools['function'])) {
                $tools = array($tools);
            }
            $data['tools'] = $tools;
            $data['tool_choice'] = 'auto';
        }
        
        if ($temp !== null) {
            $data['temperature'] = $temp;
        }
        if ($top !== null) {
            $data['top_p'] = $top;
        }
        
        $resp = $this->call('messages', 'POST', $data, $api);
        return $resp;
    }

}>>>file: custom/dolielec/class/doc.class.php
<?php
// custom/dolielec/class/doc.class.php
require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/files.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/functions.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/functions2.lib.php';
require_once DOL_DOCUMENT_ROOT.'/societe/class/societe.class.php';

class Documentation {
	private $db;

	public function __construct($db) {
		global $langs;
		$langs->loadLangs(array('main','companies','dolielec@dolielec'));
		$this->db = $db;
	}

	/**
	 * Devuelve info de la empresa instaladora / firmante (mysoc + user si procede)
	 * @return array
	 */
	public function getInst() {
		global $mysoc, $user;
		$out = array(
			'type'      => 'company',
			'display'   => $mysoc->name,
			'nif'       => $mysoc->idprof1,
			'rasic'     => $mysoc->idprof4,
			'firstname' => '',
			'lastname'  => '',
			'niftech'   => ''
		);
		if (!empty($user->firstname) || !empty($user->lastname)) {
			$out['type']      = 'person';
			$out['firstname'] = $user->firstname;
			$out['lastname']  = $user->lastname;
			$out['display']   = trim(($user->firstname!=''?$user->firstname.' ':'').$user->lastname);
			$out['niftech']   = $user->user_mobile ? $user->user_mobile : '';
		}
		return $out;
	}

	/**
	 * Construye array de datos para BRIE a partir del form y un tercero opcional
	 * @param array $form
	 * @param int   $socid
	 * @return array
	 */
	public function setBrie($form, $socid) {
		global $db, $conf;

		$data = is_array($form) ? $form : array();

		if (!empty($socid)) {
			$soc = new Societe($db);
			if ($soc->fetch($socid) > 0) {
				if (empty($data['TIT_NOMBRE']))    $data['TIT_NOMBRE']   = $soc->name;
				if (empty($data['TIT_NIF']))       $data['TIT_NIF']      = $soc->idprof1;
				if (empty($data['TIT_TLF']))       $data['TIT_TLF']      = $soc->phone;
				if (empty($data['TIT_DOM']))       $data['TIT_DOM']      = $soc->address;
				if (empty($data['TIT_CP']))        $data['TIT_CP']       = $soc->zip;
				if (empty($data['TIT_LOCALIDAD'])) $data['TIT_LOCALIDAD']= $soc->town;
			}
		}

		// defaults mÌnimos
		if (empty($data['BRIE_FECHA'])) $data['BRIE_FECHA'] = dol_print_date(dol_now(), '%Y-%m-%d');
		if (!isset($data['ASCENSOR'])) $data['ASCENSOR'] = 'NO';
		if (!isset($data['TIERRA_EXISTE'])) $data['TIERRA_EXISTE'] = 'NO';
		if (!isset($data['AISLAMIENTO'])) $data['AISLAMIENTO'] = 'NO';

		return $data;
	}

	/**
	 * Genera un ODT a partir de una plantilla.
	 * AquÌ no inventamos motor: si no tienes sustituciÛn de marcadores, se copia tal cual.
	 * @param string $template Ruta a la plantilla .odt
	 * @param string $output   Ruta al ODT de salida
	 * @param array  $data     Datos del formulario (si conectas un motor, ˙salo aquÌ)
	 * @return array ['success'=>bool,'file'=>string|false,'message'=>string]
	 */
	public function renderODT($template, $output, $data=array()) {
		global $langs;
		$dir = dirname($output);
		if (!is_dir($dir)) dol_mkdir($dir);
		if (!is_readable($template)) {
			return array('success'=>false,'file'=>false,'message'=>$langs->trans('TemplateNotFound'));
		}

		// TODO: conectar tu motor ODT si lo tienes (TBS/OpenDocument). Por ahora, copia simple.
		if (!dol_copy($template, $output, 0, 1)) {
			return array('success'=>false,'file'=>false,'message'=>'CopyFail');
		}
		return array('success'=>true,'file'=>$output,'message'=>'OK');
	}

	/**
	 * Convierte ODT?PDF usando soffice/unoconv si est·n disponibles
	 * @param string $odt
	 * @param string $pdf
	 * @return array
	 */
	public function odtToPdf($odt, $pdf) {
		if (!is_readable($odt)) return array('success'=>false,'file'=>false,'message'=>'ODTMissing');

		if (file_exists($pdf)) @unlink($pdf);

		global $conf;

		$bin = !empty($conf->global->MAIN_PATH_SOFFICE) ? $conf->global->MAIN_PATH_SOFFICE : '';
		if ($bin == '') $bin = trim(@shell_exec('command -v soffice 2>/dev/null'));
		if ($bin != '') {
			$cmd = escapeshellcmd($bin).' --headless --convert-to pdf --outdir '.escapeshellarg(dirname($pdf)).' '.escapeshellarg($odt).' 2>/dev/null';
			@shell_exec($cmd);
			if (is_readable($pdf)) return array('success'=>true,'file'=>$pdf,'message'=>'OK');
		}

		$unoconv = trim(@shell_exec('command -v unoconv 2>/dev/null'));
		if ($unoconv != '') {
			$cmd = escapeshellcmd($unoconv).' -f pdf -o '.escapeshellarg($pdf).' '.escapeshellarg($odt).' 2>/dev/null';
			@shell_exec($cmd);
			if (is_readable($pdf)) return array('success'=>true,'file'=>$pdf,'message'=>'OK');
		}

		return array('success'=>false,'file'=>false,'message'=>'NoConverter');
	}

	/**
	 * Firma un PDF. Si no hay firmador configurado, copia tal cual.
	 * Puedes definir DOLIELEC_CERT_FILE, DOLIELEC_CERT_PASS y/o DOLIELEC_SIGN_CMD.
	 * SIGN_CMD admite tokens: %in %out %cert %pass
	 * @param string $srcPdf
	 * @param string $destPdf
	 * @return bool
	 */
	public function setSign($srcPdf, $destPdf) {
		global $conf;

		$dir = dirname($destPdf);
		if (!is_dir($dir)) dol_mkdir($dir);

		$cert = !empty($conf->global->DOLIELEC_CERT_FILE) ? $conf->global->DOLIELEC_CERT_FILE : '';
		$pass = !empty($conf->global->DOLIELEC_CERT_PASS) ? $conf->global->DOLIELEC_CERT_PASS : '';
		$cmdt = !empty($conf->global->DOLIELEC_SIGN_CMD) ? $conf->global->DOLIELEC_SIGN_CMD : '';

		// ruta r·pida: comando externo si est· definido
		if ($cmdt != '') {
			$cmd = strtr($cmdt, array(
				'%in'   => escapeshellarg($srcPdf),
				'%out'  => escapeshellarg($destPdf),
				'%cert' => escapeshellarg($cert),
				'%pass' => escapeshellarg($pass)
			));
			@shell_exec($cmd.' 2>/dev/null');
			return is_readable($destPdf);
		}

		// fallback: sin firmar (copia)
		if (!dol_copy($srcPdf, $destPdf, 0, 1)) return false;
		return true;
	}

	/**
	 * Adjunta un fichero al ECM del tercero
	 * @param int    $socid
	 * @param string $absfile
	 * @return string Ruta destino o '' si falla
	 */
	public function attachToThirdparty($socid, $absfile) {
		global $conf, $db;

		$soc = new Societe($db);
		if ($soc->fetch($socid) <= 0) return '';

		$upload_dir = $conf->societe->dir_output.'/'.$soc->id.'/documents';
		if (!is_dir($upload_dir)) dol_mkdir($upload_dir);

		$dest = $upload_dir.'/'.basename($absfile);
		if (!dol_copy($absfile, $dest, 0, 1)) return '';

		return $dest;
	}
}

>>>file: custom/dolielec/class/geoloc.class.php
<?php
/**
 *  DoliElec - Geolocalizaci√≥n y Costes de desplazamiento
 *  @package    dolielec
 */
require_once DOL_DOCUMENT_ROOT.'/core/lib/functions.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/functions2.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/price.lib.php';
require_once DOL_DOCUMENT_ROOT.'/custom/dolielec/lib/dolielec.lib.php';
class Geoloc {
    private $db;
    private $endpoint;
    private $key;
    private $provider;
    public function __construct($db) {
        global $conf, $langs;
		$langs->loadLangs(array('dolielec@dolielec'));
        $this->db = $db;
        $this->key = !empty($GLOBALS['conf']->global->DOLIELEC_GEO_API_KEY) ? $GLOBALS['conf']->global->DOLIELEC_GEO_API_KEY : null;
        $this->provider = $conf->global->DOLIELEC_GEO_PROVIDER ?? '';
        $this->endpoint = '';
        if ($this->provider === 'google') {
            $this->endpoint = 'https://maps.googleapis.com/maps/api/directions/json';
        }
        if ($this->provider === 'ors') {
            $this->endpoint = 'https://api.openrouteservice.org/';
        }
    }

    private function call($path, $method = 'GET', $data = null) {
        global $langs;
		$key = ($key !== '') ? $key : $this->key;
        if (empty($key)) {
            return array('success' => false, 'message' => $langs->trans('MissingAPIKey'));
        }
        if (empty($this->provider)) {
            return array('success' => false, 'message' => $langs->trans('NoAPIProviderConfigured'));
        }

        $url = $this->endpoint;
        $opts = array(
            'method' => $method,
            'timeout' => 25,
            'accept_json' => 1,
            'decode_json' => 1,
        );

        if ($this->provider === 'google') {
            $url .= $path . (strpos($path, '?') === false ? '?' : '&') . 'key=' . rawurlencode($this->key);
        } elseif ($this->provider === 'ors') {
            $url .= ltrim($path, '/');
            $opts['bearer'] = $key;
            $opts['headers'] = array('Content-Type: application/json');
        } else {
            return array('success' => false, 'message' => $langs->trans('UnsupportedAPIProvider'));
        }

        if ($method === 'POST' && $data !== null) {
            $opts['body'] = $data;
            $opts['json_body'] = 1;
        }

        return apicall($url, $opts);
    }

    //geting the operational base address
    public function getAddrBase($origin = null): array {
        if ($origin === null) {
            global $mysoc;
            $origin = $mysoc ?? null;
        }        if (empty($origin)) {
            return array();
        }
        $address = (string)($origin->address ?? '');
        $zip = (string)($origin->zip ?? '');
        $town = (string)($origin->town ?? '');
        $state = (string)($origin->state ?? '');
        $country = (string)($origin->country_code ?? $origin->country ?? '');
        $build_address = array_filter(array($address, $zip, $town, $state, $country));
        $line = implode(', ', $build_address);
        return array('line' => $line);
    }
    //checking if is client thirdparty
    public function isClient($check = null): bool {
        if ($check === null) {
            global $object;
            $check = $object ?? null;
        }
        if (empty($check) || !isset($check->client)) {
            return false;
        }
        return ((int)$check->client === 1);
    }

    //get the client address and format it a line to API invoque
    public function getAddr($loc = null): array {
        if ($loc === null) {
            global $object;
            $loc = $object;
        }
        if (empty($loc)) {
            return array();
        }
        $address = (string)($loc->address ?? '');
        $zip = (string)($loc->zip ?? '');
        $town = (string)($loc->town ?? '');
        $state = (string)($loc->state ?? '');
        $fk_departement = isset($loc->fk_departement) ? (int)$loc->fk_departement : (isset($loc->state_id) ? (int)$loc->state_id : null);
        $fk_pays = isset($loc->fk_pays) ? (int)$loc->fk_pays : (isset($loc->country_code) ? (int)$loc->country_code : null);
        $country_code = (string)($loc->country_code ?? '');
        $country = (string)($loc->country ?? '');
        $build_address = array_filter(array($address, $zip, $town, $state, $country));
        $line = implode(', ', $build_address);
        return array('line' => $line);
    }

    //geting the mode (or modes) for traveling
    public function getTravelMode($mode = null): array {
        $modes = array();
        if (getDolGlobalInt('DOLIELEC_MODE_DRIVE', 0) === 1) $modes[] = 'driving';
        if (getDolGlobalInt('DOLIELEC_MODE_FOOT', 0) === 1) $modes[] = 'walking';
        if (getDolGlobalInt('DOLIELEC_MODE_TRANSIT_TRAIN', 0) === 1) $modes[] = 'train';
        if (getDolGlobalInt('DOLIELEC_MODE_TRANSIT_BUS', 0) === 1) $modes[] = 'bus';
        if (getDolGlobalInt('DOLIELEC_MODE_TRANSIT_METRO', 0) === 1) $modes[] = 'metro';
        if (getDolGlobalInt('DOLIELEC_MODE_BIKE', 0) === 1) $modes[] = 'bicycle';
        if ($mode !== null) {
            return in_array($mode, $modes, true) ? array($mode) : array();
        }
        return $modes;
    }

    //geting avoids to make routes
    public function getTravelAvoids($avoid = null): array {
        $avoids = array();
        if (getDolGlobalInt('DOLIELEC_GEO_AVOID_HIGHWAYS', 0) === 1) $avoids[] = 'highways';
        if (getDolGlobalInt('DOLIELEC_AVOID_TOLLS', 0) === 1) $avoids[] = 'tolls';
        if (getDolGlobalInt('DOLIELEC_AVOID_FERRIES', 0) === 1) $avoids[] = 'ferries';
        if (getDolGlobalInt('DOLIELEC_AVOID_STAIRS', 0) === 1) $avoids[] = 'stairs';
        if (getDolGlobalInt('DOLIELEC_AVOID_HILLS', 0) === 1) $avoids[] = 'hills';
        if (getDolGlobalInt('DOLIELEC_AVOID_CROWDS', 0) === 1) $avoids[] = 'crowds';
        if (getDolGlobalInt('DOLIELEC_AVOID_FORDS', 0) === 1) $avoids[] = 'fords';
        if ($avoid !== null) {
            return in_array($avoid, $avoids, true) ? array($avoid) : array();
        }
        return $avoids;
    }
    public function getCost(): array {
        global $langs;

        $provider = $this->provider;
        if ($provider !== 'google' && $provider !== 'ors') {
            return array('success' => false, 'message' => $langs->trans('NoAPIProviderConfigured'));
        }

        $data = ($provider === 'google') ? $this->google() : $this->ors();
        if (empty($data['success'])) {
            return $data;
        }

        $dist_km = (float) ($data['distance_km'] ?? 0);
        $cost_km = (float) getDolGlobalString('DOLIELEC_GEO_COST_KM');

        if ($dist_km <= 0 || $cost_km <= 0) {
            return array(
                'success' => false,
                'message' => $langs->trans('InvalidDistanceOrCost'),
                'distance_km' => $dist_km,
                'cost_km' => $cost_km
            );
        }

        $total = price2num($dist_km * $cost_km * 2, 2); // ida y vuelta
        $data['cost_eur'] = $total;

        return $data;
    }

    /**
     * Guardar coste de desplazamiento en el cliente
     */
    public function setToClient($client, array $data): array {
        global $langs;

        if (!$this->isClient($client)) {
            return array('success' => false, 'message' => $langs->trans('NotAClientObject'));
        }

        if (empty($data['cost_eur'])) {
            return array('success' => false, 'message' => $langs->trans('MissingTravelCost'));
        }

        $client->array_options['options_dolielec_travel_cost_eur'] = $data['cost_eur'];

        $res = $client->update($client->id, $this->db);
        if ($res <= 0) {
            return array('success' => false, 'message' => $langs->trans('ErrorSavingTravelCost'));
        }

        return array('success' => true, 'message' => $langs->trans('TravelCostSaved'), 'cost_eur' => $data['cost_eur']);
    }

}>>>file: custom/dolielec/class/google.class.php
<?php
require_once DOL_DOCUMENT_ROOT.'/core/lib/functions.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/functions2.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
require_once DOL_DOCUMENT_ROOT.'/custom/dolielec/lib/dolielec.lib.php';

class GoogleAI {
    private $db;
    private $api_key;
    private $endpoint;

    public function __construct($db) {
        global $conf, $langs;
		$langs->loadLangs('dolielec@dolielec');
        $this->db       = $db;
        $this->api_key  = !empty($conf->global->GOOGLE_API_KEY) ? $conf->global->GOOGLE_API_KEY : getDolGlobalString('GOOGLE_API_KEY', '');
        $this->endpoint = 'https://generativelanguage.googleapis.com/v1/';
    }
    private function call($path, $method = 'GET', $data = null, $api = '')
    {
        global $langs;
        $api_key = ($api !== '') ? $api : $this->api_key;
        if (empty($api_key)) {
            return array('success'=>false,'message'=>$langs->trans('MissingAPIKey'));
        }

        $url  = $this->endpoint . ltrim($path, '/');
        $opts = array(
            'method'      => $method,
            'query'       => array('key' => $api_key),
            'accept_json' => 1,
            'decode_json' => 1,
            'timeout'     => 30
        );

        if ($method === 'POST' && $data !== null) {
            $opts['body']      = $data;
            $opts['json_body'] = 1;
        }

        $resp = apicall($url, $opts);

        if (empty($resp) || empty($resp['success'])) {
            return array(
                'success'=>false,
                'message'=>isset($resp['message']) ? $resp['message'] : $langs->trans('ConnectionFailed'),
                'http'   => isset($resp['http']) ? $resp['http'] : null,
                'raw'    => isset($resp['raw'])  ? $resp['raw']  : null
            );
        }

        return array(
            'success'=>true,
            'http'   => isset($resp['http']) ? $resp['http'] : 200,
            'json'   => isset($resp['json']) ? $resp['json'] : null,
            'raw'    => isset($resp['raw'])  ? $resp['raw']  : null
        );
    }

    /** Devuelve lista de modelos Gemini filtrada igual que en OpenAI */
    public function getModels($api = '')
    {
        global $langs;

        $resp = $this->call('models', 'GET', null, $api);
        if (empty($resp['success'])) return $resp;

        $json = isset($resp['json']) ? $resp['json'] : null;
        if (!is_array($json) || empty($json['models']) || !is_array($json['models'])) {
            return array(
                'success'=>false,
                'message'=>$langs->trans('NoModels'),
                'http'=>$resp['http'] ?? null,
                'raw'=>$resp['raw']   ?? null
            );
        }

        /* --- Filtro + limpieza del prefijo "models/" ---------------- */
        $blocked_patterns = array();   // aÒade aquÌ si quieres vetar algo
        $filtered         = array();

        foreach ($json['models'] as $m) {
            $id = is_array($m) ? ($m['name'] ?? '') : (string)$m;
            if ($id === '') continue;

            // quita "models/" del inicio
            if (substr($id, 0, 7) === 'models/') {
                $id = substr($id, 7);
            }

            $blocked = false;
            foreach ($blocked_patterns as $p) {
                if (stripos($id, $p) !== false) { $blocked = true; break; }
            }
            if (!$blocked) $filtered[] = $id;
        }
        $filtered = array_values(array_unique($filtered));
        /* ------------------------------------------------------------ */

        if (empty($filtered)) {
            return array('success'=>false,'message'=>$langs->trans('NoModels'));
        }

        return array('success'=>true,'models'=>$filtered);
    }

}>>>file: custom/dolielec/class/openai.class.php
<?php
require_once DOL_DOCUMENT_ROOT.'/core/lib/functions.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/functions2.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
require_once DOL_DOCUMENT_ROOT.'/custom/dolielec/lib/dolielec.lib.php';
class OpenAI {
    private $db;
    private $api_key;
    private $endpoint;
    public function __construct($db) {
        global $conf, $langs;
		$langs->loadLangs(array('dolielec@dolielec'));
        $this->db = $db;
        $this->api_key = !empty($conf->global->OPENAI_API_KEY) ? $conf->global->OPENAI_API_KEY : getDolGlobalString('OPENAI_API_KEY', '');
        $this->endpoint = 'https://api.openai.com/v1/';
    }
    private function call($path, $method = 'GET', $data = null, $api = '') {
        global $langs;
        $api = ($api !== '') ? $api : $this->api_key;
        if (empty($api)) {
            return array('success' => false, 'message' => $langs->trans('MissingAPIKey'));
        }
        $url = $this->endpoint . ltrim($path, '/');
        $opts = array(
            'method' => $method,
            'bearer' => $api,
            'accept_json' => 1,
            'decode_json' => 1,
            'timeout' => 30,
        );
        if ($method === 'POST' && $data !== null) {
            $opts['body'] = $data;
            $opts['json_body'] = 1;
        }
        $resp = apicall($url, $opts);
        if (empty($resp) || empty($resp['success'])) {
            return array(
                'success' => false,
                'message' => isset($resp['message']) ? $resp['message'] : $langs->trans('ConnectionFailed'),
                'http' => isset($resp['http']) ? $resp['http'] : null,
                'raw' => isset($resp['raw']) ? $resp['raw'] : null,
            );
        }
        return array(
            'success' => true,
            'http' => isset($resp['http']) ? $resp['http'] : 200,
            'json' => isset($resp['json']) ? $resp['json'] : null,
            'raw' => isset($resp['raw']) ? $resp['raw'] : null,
        );
    }
    public function getModels($api = '') {
        global $langs;
        $resp = $this->call('models', 'GET', null, $api);
        if (empty($resp['success'])) {
            return $resp;
        }
        $json = isset($resp['json']) ? $resp['json'] : null;
        if (!is_array($json) || empty($json['data']) || !is_array($json['data'])) {
            return array('success' => false, 'message' => $langs->trans('NoModels'), 'http' => $resp['http'] ?? null, 'raw' => $resp['raw'] ?? null);
        }
                $blocked_patterns = array();
        $filtered = array();
        foreach ($json['data'] as $m) {
            $id = is_array($m) ? ($m['id'] ?? '') : (string)$m;
            if ($id === '') {
				continue;
			}
            $blocked = false;
            foreach ($blocked_patterns as $patterns) {
                if (stripos($id, $patterns) !== false) {
					$blocked = true;
					break;
					}
            }
            if (!$blocked) {
				$filtered[] = $id;
        }
			}
        $filtered = array_values(array_unique($filtered));
        if (empty($filtered)) {
            return array('success' => false, 'message' => $langs->trans('NoModels'));
        }

        return array('success' => true, 'models' => $filtered);
    }
	public function setPrompt($temp = null, $top = null, $model = null, $reason = null, $maxt = null, $system = '', $user = '', $tools = null, $api = '') {
		$temp = (!empty($temp) && $temp !== null) ? $temp : getDolGlobalFloat('OPENAI_TEMPERATURE');
$top = (!empty($top) && $top !== null) ? $top : getDolGlobalFloat('OPENAI_TOP_P');
$model = (!empty($model)) ? $model : getDolGlobalString('OPENAI_DEFAULT_MODEL');
$reason = (!empty($reason)) ? $reason : 'medium';
$maxt = (!empty($maxt) && $maxt !== null) ? $maxt : getDolGlobalInt('OPENAI_MAX_TOKENS');
														$data = array('temperature' => $temp, 'top_p' => $top, 'model' => $model, 'max_tokens' => $maxt, 'messages' => array(array('role' => 'system', 'content' => $system), array('role' => 'user', 'content' => $user)));
				if(is_array($tools) && !empty($tools)) {
					if(isset($tools['type']) || isset($tools['function'])) {
						$tools = array($tools);
								}
					$data['tools'] = $tools;
			$data['tool_choice'] = 'auto';
		}
		if(stripos($model, 'o1') !== false || stripos($model, 'o1pro') !== false || stripos($model, 'o3') !== false) {
			unset($data['temperature']);
			unset($data['top_p']);
			$data['reasoning_effort'] = $reason;
		}
		$resp = $this->call('chat/completions', 'POST', $data, $api);
return $resp;
	}		

}>>>file: custom/dolielec/class/profit.class.php
<?php
/**file profit.class.php
file dedicated to RPO, prices and profitability engine of dolielec
*/
require_once DOL_DOCUMENT_ROOT.'/core/lib/functions.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/functions2.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/price.lib.php';
require_once DOL_DOCUMENT_ROOT.'/custom/dolielec/lib/dolielec.lib.php';
require_once DOL_DOCUMENT_ROOT.'/product/class/product.class.php';
require_once DOL_DOCUMENT_ROOT.'/fourn/class/fournisseur.product.class.php';
include DOL_DOCUMENT_ROOT.'/custom/dolielec/class/anthropic.class.php';
include DOL_DOCUMENT_ROOT.'/custom/dolielec/class/geoloc.class.php';
include DOL_DOCUMENT_ROOT.'/custom/dolielec/class/google.class.php';
include DOL_DOCUMENT_ROOT.'/custom/dolielec/class/openai.class.php';
include DOL_DOCUMENT_ROOT.'/custom/dolielec/class/doc.class.php';
//Class for profitability, pricing and RPO AI engine.
//Uses a openai engines, gemini and claude APIs for take automatic decissions.
//Also can use another system human memories.
class Profit {
	private $db;
public function __construct($db) {
	global $langs, $user;
	$langs->loadLangs(array('dolielec@dolielec'));
		$this->db = $db;
}
		public function getPrice($ref_supplier, $fourn_pu) {
			global $langs, $user;
			$cai=new ClaudeAI($this->db);
			$google = new GoogleAI($this->db);
						$openai = new OpenAI($this->db);
			$product = new Product ($this->db);
			$pf = new ProductFournisseur($this->db);
									if(empty($ref_supplier)) {
				return array('success' => false, 'message' => $langs->trans('MissingSupplier'));
			}
			if(empty($fourn_pu) || $fourn_pu < 0) {
				return array('success' => false, 'message' => $langs->trans('MissingPriceSupplierOrPriceInvalid'));
			}
			$res = $pf->fetch(0, $ref_supplier);
			if ($res <= 0) {
				return array('success' => false, 'message' => $langs->trans('ProductSupplierNotFound'));
			}
			if ($product->fetch($pf->fk_product) <= 0) {
	return array('success' => false, 'message' => $langs->trans('ProductNotFound'));
}
$cleanPrice = price2num($fourn_pu, 2);
						$rsystem= 'Eres Biel, un agresivo comercial y contable experto en el mercado del sector elÈctrico. Tu misiÛn es calcular el precio de venta m·s Ûptimo con la m·xima rentabilidad neutralizando cualquier tipo de competencia. Debes buscar el fabricante, el precio de venta recomendado y el precio de venta al p˙blico seg˙n la referencia del fabricante dada.';
			$ruser = 'calcula el mejor precio de venta para  el producto con Referencia '.$ref_supplier.' que tiene un precio unitario de '.$cleanPrice.'. Debes analizar el mercado en profundidad, revisando: Grandes superficies como leroy merlin, obramat, amazon, aliexpress, etc; pequeÒas superficies como bazares, ferreterÌas de barrio; y devolver un  precio que garantice ganancias, rentabilidad y el mayor margen posible, neutralizando cualquier tipo de competencia; seg˙n lo indicado. Debes devolver un json v·lido y la respuesta debe estar formada por solo n˙meros. Debe tener una forma como esta: {"price":valor}';
			try {
			$data = $openai->setPrompt(0.5, 0.9, 'gpt-5', null, 800, $rsystem, $ruser, $api);
			}
			catch(Exception $e) {
				return array('success' => false, 'message' => $langs->trans('OpenAIError').': '.$e->getMessage());
			}
			if(empty($data['json']['choice'][0]['message']['content'])) {
				return array('success' => false, 'message' => $data['message' ?? $langs->trans('EmptyResponse'));
			}
			$content = trim($data['json']['choice'][0]['message']['content']);
			        $content = preg_replace('/```json\s*|\s*```/', '', $content);
									$decode = json_decode($content, true);
						if(!$decode || !isset($decode['price'])) {
							            dol_syslog(__METHOD__.': Invalid JSON response: '.$content, LOG_WARNING);
															return array('success' => false, 'message' => $langs->trans('ResponseInvalid'));
			}
			$price = price2num($decode['price'], 2);
						if ($price < 0) {
							            				return array('success' => false, 'message' => $langs->trans('PriceInvalid'));
			}
						$update = $product->updatePrice($price, 'HT', $user, 0, 0, 0);
			if ($update > 0) {
				return array('success' => true, 'message' => $langs->trans('PriceUpdated'));
			}
			else {
				return array('success' => false, 'message' => $langs->trans('UpdateFailed'));
			}
			}

		}					>>>file: custom/dolielec/core/modules/modDolielec.class.php
<?php
/* Copyright (C) 2004-2018	Laurent Destailleur			<eldy@users.sourceforge.net>
 * Copyright (C) 2018-2019	Nicolas ZABOURI				<info@inovea-conseil.com>
 * Copyright (C) 2019-2024	Fr√©d√©ric France				<frederic.france@free.fr>
 * Copyright (C) 2025		Torres Gallego Fran			<ftorres@alelectricista.es>
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <https://www.gnu.org/licenses/>.
 */

/**
 * 	\defgroup   dolielec     Module Dolielec
 *  \brief      Dolielec module descriptor.
 *
 *  \file       htdocs/dolielec/core/modules/modDolielec.class.php
 *  \ingroup    dolielec
 *  \brief      Description and activation file for module Dolielec
 */
include_once DOL_DOCUMENT_ROOT.'/core/modules/DolibarrModules.class.php';


/**
 *  Description and activation class for module Dolielec
 */
class modDolielec extends DolibarrModules
{
	/**
	 * Constructor. Define names, constants, directories, boxes, permissions
	 *
	 * @param DoliDB $db Database handler
	 */
	public function __construct($db)
	{
		global $conf, $langs;

		$this->db = $db;

		// Id for module (must be unique).
		// Use here a free id (See in Home -> System information -> Dolibarr for list of used modules id).
		$this->numero = 104000; // TODO Go on page https://wiki.dolibarr.org/index.php/List_of_modules_id to reserve an id number for your module

		// Key text used to identify module (for permissions, menus, etc...)
		$this->rights_class = 'dolielec';

		// Family can be 'base' (core modules),'crm','financial','hr','projects','products','ecm','technic' (transverse modules),'interface' (link with external tools),'other','...'
		// It is used to group modules by family in module setup page
		$this->family = "technic";

		// Module position in the family on 2 digits ('01', '10', '20', ...)
		$this->module_position = '90';

		// Gives the possibility for the module, to provide his own family info and position of this family (Overwrite $this->family and $this->module_position. Avoid this)
		//$this->familyinfo = array('myownfamily' => array('position' => '01', 'label' => $langs->trans("MyOwnFamily")));
		// Module label (no space allowed), used if translation string 'ModuleDolielecName' not found (Dolielec is name of module).
		$this->name = preg_replace('/^mod/i', '', get_class($this));

		// DESCRIPTION_FLAG
		// Module description, used if translation string 'ModuleDolielecDesc' not found (Dolielec is name of module).
		$this->description = 'Gesti√≥n de instalaciones el√©ctricas con IA';
		// Used only if file README.md and README-LL.md not found.
		$this->descriptionlong = "Gesti√≥n de instalaciones el√©ctricas con IA";

		// Author
		$this->editor_name = 'Alelectricista';
		$this->editor_url = 'https://alelectricista.es';		// Must be an external online web site
		$this->editor_squarred_logo = '';					// Must be image filename into the module/img directory followed with @modulename. Example: 'myimage.png@dolielec'

		// Possible values for version are: 'development', 'experimental', 'dolibarr', 'dolibarr_deprecated', 'experimental_deprecated' or a version string like 'x.y.z'
		$this->version = '1.0.0';
		// Url to the file with your last numberversion of this module
		//$this->url_last_version = 'http://www.example.com/versionmodule.txt';

		// Key used in llx_const table to save module status enabled/disabled (where DOLIELEC is value of property name of module in uppercase)
		$this->const_name = 'MAIN_MODULE_'.strtoupper($this->name);

		// Name of image file used for this module.
		// If file is in theme/yourtheme/img directory under name object_pictovalue.png, use this->picto='pictovalue'
		// If file is in module/img directory under name object_pictovalue.png, use this->picto='pictovalue@module'
		// To use a supported fa-xxx css style of font awesome, use this->picto='xxx'
		$this->picto = 'technic';

		// Define some features supported by module (triggers, login, substitutions, menus, css, etc...)
		$this->module_parts = array(
			// Set this to 1 if module has its own trigger directory (core/triggers)
			'triggers' => 1,
			// Set this to 1 if module has its own login method file (core/login)
			'login' => 0,
			// Set this to 1 if module has its own substitution function file (core/substitutions)
			'substitutions' => 0,
			// Set this to 1 if module has its own menus handler directory (core/menus)
			'menus' => 1,
			// Set this to 1 if module overwrite template dir (core/tpl)
			'tpl' => 1,
			// Set this to 1 if module has its own barcode directory (core/modules/barcode)
			'barcode' => 0,
			// Set this to 1 if module has its own models directory (core/modules/xxx)
			'models' => 0,
			// Set this to 1 if module has its own printing directory (core/modules/printing)
			'printing' => 0,
			// Set this to 1 if module has its own theme directory (theme)
			'theme' => 0,
			// Set this to relative path of css file if module has its own css file
			'css' => array(
				'/dolielec/css/dolielec.css.php',
			),
			// Set this to relative path of js file if module must load a js on all pages
			'js' => array(
				'/dolielec/js/dolielec.js.php',
			),
			// Set here all hooks context managed by module. To find available hook context, make a "grep -r '>initHooks(' *" on source code. You can also set hook context to 'all'
					'hooks' => array('all'),
			// Set this to 1 if features of module are opened to external users
			'moduleforexternal' => 0,
			// Set this to 1 if the module provides a website template into doctemplates/websites/website_template-mytemplate
			'websitetemplates' => 0,
			// Set this to 1 if the module provides a captcha driver
			'captcha' => 0
		);

		// Data directories to create when module is enabled.
		// Example: this->dirs = array("/dolielec/temp","/dolielec/subdir");
		$this->dirs = array("/dolielec/var/tmp", "/dolielec/docs/cert", "/dolielec/docs/images", "/dolielec/docs/videos", "/dolielec/docs/schemas", "/dolielec/docs/signed");

		// Config pages. Put here list of php page, stored into dolielec/admin directory, to use to setup module.
		$this->config_page_url = array("setup.php@dolielec");

		// Dependencies
		// A condition to hide module
		$this->hidden = getDolGlobalInt('MODULE_DOLIELEC_DISABLED'); // A condition to disable module;
		// List of module class names that must be enabled if this module is enabled. Example: array('always'=>array('modModuleToEnable1','modModuleToEnable2'), 'FR'=>array('modModuleToEnableFR')...)
		$this->depends = array('modSociete', 'modPropale', 'modProduct', 'modECM', 'modCron','modTicket');
		// List of module class names to disable if this one is disabled. Example: array('modModuleToDisable1', ...)
		$this->requiredby = array();
		// List of module class names this module is in conflict with. Example: array('modModuleToDisable1', ...)
		$this->conflictwith = array();

		// The language file dedicated to your module
		$this->langfiles = array("dolielec@dolielec");

		// Prerequisites
		$this->phpmin = array(8, 4); // Minimum version of PHP required by module
		$this->need_dolibarr_version = array(22, 0); // Minimum version of Dolibarr required by module
		$this->need_javascript_ajax = 1 ;

		// Messages at activation
		$this->warnings_activation = array(); // Warning to show when we activate module. array('always'='text') or array('FR'='textfr','MX'='textmx'...)
		$this->warnings_activation_ext = array(); // Warning to show when we activate an external module. array('always'='text') or array('FR'='textfr','MX'='textmx'...)
		//$this->automatic_activation = array('FR'=>'DolielecWasAutomaticallyActivatedBecauseOfYourCountryChoice');
		//$this->always_enabled = true;								// If true, can't be disabled

		// Constants
		// List of particular constants to add when module is enabled (key, 'chaine', value, desc, visible, 'current' or 'allentities', deleteonunactive)
		// Example: $this->const=array(1 => array('DOLIELEC_MYNEWCONST1', 'chaine', 'myvalue', 'This is a constant to add', 1),
		//                             2 => array('DOLIELEC_MYNEWCONST2', 'chaine', 'myvalue', 'This is another constant to add', 0, 'current', 1)
		// );
		$this->const = array();

		// Some keys to add into the overwriting translation tables
		/*$this->overwrite_translation = array(
			'en_US:ParentCompany'=>'Parent company or reseller',
			'fr_FR:ParentCompany'=>'Maison m√®re ou revendeur'
		)*/

		if (!isModEnabled("dolielec")) {
			$conf->dolielec = new stdClass();
			$conf->dolielec->enabled = 0;
		}

		// Array to add new pages in new tabs
		/* BEGIN MODULEBUILDER TABS */
		$this->tabs = array('data' => 'user:+biel_identity:BielIdentity:dolielec@dolielec:$user->admin || $user->rights->dolielec->read:/dolielec/view.php?id=__ID__');
		/* END MODULEBUILDER TABS */
		// Example:
		// To add a new tab identified by code tabname1
		// $this->tabs[] = array('data' => 'objecttype:+tabname1:Title1:mylangfile@dolielec:$user->hasRight(\'dolielec\', \'read\'):/dolielec/mynewtab1.php?id=__ID__');
		// To add another new tab identified by code tabname2. Label will be result of calling all substitution functions on 'Title2' key.
		// $this->tabs[] = array('data' => 'objecttype:+tabname2:SUBSTITUTION_Title2:mylangfile@dolielec:$user->hasRight(\'othermodule\', \'read\'):/dolielec/mynewtab2.php?id=__ID__',
		// To remove an existing tab identified by code tabname
		// $this->tabs[] = array('data' => 'objecttype:-tabname:NU:conditiontoremove');
		//
		// Where objecttype can be
		// 'categories_x'	  to add a tab in category view (replace 'x' by type of category (0=product, 1=supplier, 2=customer, 3=member)
		// 'contact'          to add a tab in contact view
		// 'contract'         to add a tab in contract view
		// 'delivery'         to add a tab in delivery view
		// 'group'            to add a tab in group view
		// 'intervention'     to add a tab in intervention view
		// 'invoice'          to add a tab in customer invoice view
		// 'invoice_supplier' to add a tab in supplier invoice view
		// 'member'           to add a tab in foundation member view
		// 'opensurveypoll'	  to add a tab in opensurvey poll view
		// 'order'            to add a tab in sale order view
		// 'order_supplier'   to add a tab in supplier order view
		// 'payment'		  to add a tab in payment view
		// 'payment_supplier' to add a tab in supplier payment view
		// 'product'          to add a tab in product view
		// 'propal'           to add a tab in propal view
		// 'project'          to add a tab in project view
		// 'stock'            to add a tab in stock view
		// 'thirdparty'       to add a tab in third party view
		// 'user'             to add a tab in user view


		// Dictionaries
		/* Example:
		 $this->dictionaries=array(
		 'langs' => 'dolielec@dolielec',
		 // List of tables we want to see into dictionary editor
		 'tabname' => array("table1", "table2", "table3"),
		 // Label of tables
		 'tablib' => array("Table1", "Table2", "Table3"),
		 // Request to select fields
		 'tabsql' => array('SELECT f.rowid as rowid, f.code, f.label, f.active FROM '.MAIN_DB_PREFIX.'table1 as f', 'SELECT f.rowid as rowid, f.code, f.label, f.active FROM '.MAIN_DB_PREFIX.'table2 as f', 'SELECT f.rowid as rowid, f.code, f.label, f.active FROM '.MAIN_DB_PREFIX.'table3 as f'),
		 // Sort order
		 'tabsqlsort' => array("label ASC", "label ASC", "label ASC"),
		 // List of fields (result of select to show dictionary)
		 'tabfield' => array("code,label", "code,label", "code,label"),
		 // List of fields (list of fields to edit a record)
		 'tabfieldvalue' => array("code,label", "code,label", "code,label"),
		 // List of fields (list of fields for insert)
		 'tabfieldinsert' => array("code,label", "code,label", "code,label"),
		 // Name of columns with primary key (try to always name it 'rowid')
		 'tabrowid' => array("rowid", "rowid", "rowid"),
		 // Condition to show each dictionary
		 'tabcond' => array(isModEnabled('dolielec'), isModEnabled('dolielec'), isModEnabled('dolielec')),
		 // Tooltip for every fields of dictionaries: DO NOT PUT AN EMPTY ARRAY
		 'tabhelp' => array(array('code' => $langs->trans('CodeTooltipHelp'), 'field2' => 'field2tooltip'), array('code' => $langs->trans('CodeTooltipHelp'), 'field2' => 'field2tooltip'), ...),
		 );
		 */
		/* BEGIN MODULEBUILDER DICTIONARIES */
		$this->dictionaries = array();
		/* END MODULEBUILDER DICTIONARIES */

		// Boxes/Widgets
		// Add here list of php file(s) stored in dolielec/core/boxes that contains a class to show a widget.
		/* BEGIN MODULEBUILDER WIDGETS */
		$this->boxes = array(
			//  0 => array(
			//      'file' => 'dolielecwidget1.php@dolielec',
			//      'note' => 'Widget provided by Dolielec',
			//      'enabledbydefaulton' => 'Home',
			//  ),
			//  ...
		);
		/* END MODULEBUILDER WIDGETS */

		// Cronjobs (List of cron jobs entries to add when module is enabled)
		// unit_frequency must be 60 for minute, 3600 for hour, 86400 for day, 604800 for week
		/* BEGIN MODULEBUILDER CRON */
		global $langs;
		$this->cronjobs = array(
  0 => array(
			      'label' => $langs->trans('TravelCost'),
      'jobtype' => 'method',
			      'class' => '/dolielec/class/geoloc.class.php',
      'objectname' => 'Geoloc',
			      'method' => 'cronRefreshTravelCosts',
      'parameters' => '{"limit":200,"budget_s":60}',
			      'comment' => 'actualiza y guarda los costes de desplazamiento para los clientes',
      'frequency' => 1,
			      'unitfrequency' => 604800,
			      'status' => 1,
			      'test' => 'isModEnabled("dolielec")',
			      'priority' => 50,
			  ),
		);
		/* END MODULEBUILDER CRON */
		// Example: $this->cronjobs=array(
		//    0=>array('label'=>'My label', 'jobtype'=>'method', 'class'=>'/dir/class/file.class.php', 'objectname'=>'MyClass', 'method'=>'myMethod', 'parameters'=>'param1, param2', 'comment'=>'Comment', 'frequency'=>2, 'unitfrequency'=>3600, 'status'=>0, 'test'=>'isModEnabled("dolielec")', 'priority'=>50),
		//    1=>array('label'=>'My label', 'jobtype'=>'command', 'command'=>'', 'parameters'=>'param1, param2', 'comment'=>'Comment', 'frequency'=>1, 'unitfrequency'=>3600*24, 'status'=>0, 'test'=>'isModEnabled("dolielec")', 'priority'=>50)
		// );

		// Permissions provided by this module

        $this->rights = array();
        $r = 0;
        $this->rights[$r][0] = $this->numero . sprintf('%02d', $r + 1);
        $this->rights[$r][1] = $langs->trans('ReadAllow');
        $this->rights[$r][3] = 1;
        $this->rights[$r][4] = 'read';
        $this->rights[$r][5] = '1';
        $r++;

        $this->rights[$r][0] = $this->numero . sprintf('%02d', $r + 1);
        $this->rights[$r][1] = $langs->trans('WriteAllow');
        $this->rights[$r][3] = 1;
        $this->rights[$r][4] = 'write';
        $this->rights[$r][5] = '1';
        $r++;

        $this->rights[$r][0] = $this->numero . sprintf('%02d', $r + 1);
        $this->rights[$r][1] = $langs->trans('DeleteAllow');
        $this->rights[$r][3] = 1;
        $this->rights[$r][4] = 'delete';
        $this->rights[$r][5] = '1';
        $r++;

		// Main menu entries to add
		$this->menu = array();
		$r = 0;
		// Add here entries to declare new menus
				$this->menu[$r++] = array(
			'fk_menu' => '', // Will be stored into mainmenu + leftmenu. Use '' if this is a top menu. For left menu, use 'fk_mainmenu=xxx' or 'fk_mainmenu=xxx,fk_leftmenu=yyy' where xxx is mainmenucode and yyy is a leftmenucode
			'type' => 'top', // This is a Top menu entry
			'titre' => 'Dolielec',
			'prefix' => img_picto('', $this->picto, 'class="pictofixedwidth valignmiddle"'),
			'mainmenu' => 'dolielec',
			'leftmenu' => '',
			'url' => 'index.php',
			'langs' => 'dolielec@dolielec', 
			'position' => 1000 + $r,
			'enabled' => 'isModEnabled("dolielec")', // Define condition to show or hide menu entry. Use 'isModEnabled("dolielec")' if entry must be visible if module is enabled.
			'perms' => '1', // Use 'perms'=>'$user->hasRight("dolielec", "myobject", "read")' if you want your menu with a permission rules
			'target' => '',
			'user' => 0, // 0=Menu for internal users, 1=external users, 2=both
		);
				/* BEGIN MODULEBUILDER LEFTMENU MYOBJECT */
		/*
		$this->menu[$r++]=array(
			'fk_menu' => 'fk_mainmenu=dolielec',      // '' if this is a top menu. For left menu, use 'fk_mainmenu=xxx' or 'fk_mainmenu=xxx,fk_leftmenu=yyy' where xxx is mainmenucode and yyy is a leftmenucode
			'type' => 'left',                          // This is a Left menu entry
			'titre' => $langs->trans('InternalDocumentation'),
			'prefix' => img_picto('', $this->picto, 'class="pictofixedwidth valignmiddle paddingright"'),
			'mainmenu' => 'dolielec',
			'leftmenu' => 'documentation',
			'url' => '',
			'langs' => 'dolielec@dolielec',	        // Lang file to use (without .lang) by module. File must be in langs/code_CODE/ directory.
			'position' => 1000 + $r,
			'enabled' => 'isModEnabled("dolielec")', // Define condition to show or hide menu entry. Use 'isModEnabled("dolielec")' if entry must be visible if module is enabled.
			'perms' => '$user->hasRight("dolielec", "calculate", "read")',
			'target' => '',
			'user' => 0,				                // 0=Menu for internal users, 1=external users, 2=both
			'object' => 'document'
		);
		$this->menu[$r++]=array(
			'fk_menu' => 'fk_mainmenu=dolielec,fk_leftmenu=documentation',	    // '' if this is a top menu. For left menu, use 'fk_mainmenu=xxx' or 'fk_mainmenu=xxx,fk_leftmenu=yyy' where xxx is mainmenucode and yyy is a leftmenucode
			'type' => 'left',			                // This is a Left menu entry
			'titre' => $langs->trans('InternalDocumentationManager'),
			'mainmenu' => 'dolielec',
			'leftmenu' => '',
			'url' => '/dolielec/doc.php',
			'langs' => 'dolielec@dolielec',	        // Lang file to use (without .lang) by module. File must be in langs/code_CODE/ directory.
			'position' => 1000 + $r,
			'enabled' => 'isModEnabled("dolielec")', // Define condition to show or hide menu entry. Use 'isModEnabled("dolielec")' if entry must be visible if module is enabled. Use '$leftmenu==\'system\'' to show if leftmenu system is selected.
			'perms' => '$user->hasRight("dolielec", "calculate", "read")',
			'target' => '',
			'user' => 2,				                // 0=Menu for internal users, 1=external users, 2=both
			'object' => ''
		);
		//$this->menu[$r++]=array(
//			'fk_menu' => 'fk_mainmenu=dolielec,fk_leftmenu=calculate',	    // '' if this is a top menu. For left menu, use 'fk_mainmenu=xxx' or 'fk_mainmenu=xxx,fk_leftmenu=yyy' where xxx is mainmenucode and yyy is a leftmenucode
			//'type' => 'left',			                // This is a Left menu entry
			//'titre' => $lants->trans('CalculatePrevisionOnCommerce'),
			//'mainmenu' => 'dolielec',
			//'leftmenu' => '',
			//'url' => '/dolielec/calc/commerces.php',
			//'langs' => 'dolielec@dolielec',	        // Lang file to use (without .lang) by module. File must be in langs/code_CODE/ directory.
			//'position' => 1000 + $r,
			//'enabled' => 'isModEnabled("dolielec")', // Define condition to show or hide menu entry. Use 'isModEnabled("dolielec")' if entry must be visible if module is enabled.
			//'perms' => '$user->hasRight("dolielec", "calculate", "read")'
			//'target' => '',
			//'user' => 2,				                // 0=Menu for internal users, 1=external users, 2=both
			//'object' => ''
		//);
		*/
		/* END MODULEBUILDER LEFTMENU MYOBJECT */


		// Exports profiles provided by this module
		$r = 0;
		/* BEGIN MODULEBUILDER EXPORT MYOBJECT */
		/*
		$langs->load("dolielec@dolielec");
		$this->export_code[$r] = $this->rights_class.'_'.$r;
		$this->export_label[$r] = 'MyObjectLines';	// Translation key (used only if key ExportDataset_xxx_z not found)
		$this->export_icon[$r] = $this->picto;
		// Define $this->export_fields_array, $this->export_TypeFields_array and $this->export_entities_array
		$keyforclass = 'MyObject'; $keyforclassfile='/dolielec/class/myobject.class.php'; $keyforelement='myobject@dolielec';
		include DOL_DOCUMENT_ROOT.'/core/commonfieldsinexport.inc.php';
		//$this->export_fields_array[$r]['t.fieldtoadd']='FieldToAdd'; $this->export_TypeFields_array[$r]['t.fieldtoadd']='Text';
		//unset($this->export_fields_array[$r]['t.fieldtoremove']);
		//$keyforclass = 'MyObjectLine'; $keyforclassfile='/dolielec/class/myobject.class.php'; $keyforelement='myobjectline@dolielec'; $keyforalias='tl';
		//include DOL_DOCUMENT_ROOT.'/core/commonfieldsinexport.inc.php';
		$keyforselect='myobject'; $keyforaliasextra='extra'; $keyforelement='myobject@dolielec';
		include DOL_DOCUMENT_ROOT.'/core/extrafieldsinexport.inc.php';
		//$keyforselect='myobjectline'; $keyforaliasextra='extraline'; $keyforelement='myobjectline@dolielec';
		//include DOL_DOCUMENT_ROOT.'/core/extrafieldsinexport.inc.php';
		//$this->export_dependencies_array[$r] = array('myobjectline' => array('tl.rowid','tl.ref')); // To force to activate one or several fields if we select some fields that need same (like to select a unique key if we ask a field of a child to avoid the DISTINCT to discard them, or for computed field than need several other fields)
		//$this->export_special_array[$r] = array('t.field' => '...');
		//$this->export_examplevalues_array[$r] = array('t.field' => 'Example');
		//$this->export_help_array[$r] = array('t.field' => 'FieldDescHelp');
		$this->export_sql_start[$r]='SELECT DISTINCT ';
		$this->export_sql_end[$r]  =' FROM '.MAIN_DB_PREFIX.'dolielec_myobject as t';
		//$this->export_sql_end[$r]  .=' LEFT JOIN '.MAIN_DB_PREFIX.'dolielec_myobject_line as tl ON tl.fk_myobject = t.rowid';
		$this->export_sql_end[$r] .=' WHERE 1 = 1';
		$this->export_sql_end[$r] .=' AND t.entity IN ('.getEntity('myobject').')';
		$r++; */
		/* END MODULEBUILDER EXPORT MYOBJECT */

		// Imports profiles provided by this module
		$r = 0;
		/* BEGIN MODULEBUILDER IMPORT MYOBJECT */
		/*
		$langs->load("dolielec@dolielec");
		$this->import_code[$r] = $this->rights_class.'_'.$r;
		$this->import_label[$r] = 'MyObjectLines';	// Translation key (used only if key ExportDataset_xxx_z not found)
		$this->import_icon[$r] = $this->picto;
		$this->import_tables_array[$r] = array('t' => MAIN_DB_PREFIX.'dolielec_myobject', 'extra' => MAIN_DB_PREFIX.'dolielec_myobject_extrafields');
		$this->import_tables_creator_array[$r] = array('t' => 'fk_user_author'); // Fields to store import user id
		$import_sample = array();
		$keyforclass = 'MyObject'; $keyforclassfile='/dolielec/class/myobject.class.php'; $keyforelement='myobject@dolielec';
		include DOL_DOCUMENT_ROOT.'/core/commonfieldsinimport.inc.php';
		$import_extrafield_sample = array();
		$keyforselect='myobject'; $keyforaliasextra='extra'; $keyforelement='myobject@dolielec';
		include DOL_DOCUMENT_ROOT.'/core/extrafieldsinimport.inc.php';
		$this->import_fieldshidden_array[$r] = array('extra.fk_object' => 'lastrowid-'.MAIN_DB_PREFIX.'dolielec_myobject');
		$this->import_regex_array[$r] = array();
		$this->import_examplevalues_array[$r] = array_merge($import_sample, $import_extrafield_sample);
		$this->import_updatekeys_array[$r] = array('t.ref' => 'Ref');
		$this->import_convertvalue_array[$r] = array(
			't.ref' => array(
				'rule'=>'getrefifauto',
				'class'=>(!getDolGlobalString('DOLIELEC_MYOBJECT_ADDON') ? 'mod_myobject_standard' : getDolGlobalString('DOLIELEC_MYOBJECT_ADDON')),
				'path'=>"/core/modules/dolielec/".(!getDolGlobalString('DOLIELEC_MYOBJECT_ADDON') ? 'mod_myobject_standard' : getDolGlobalString('DOLIELEC_MYOBJECT_ADDON')).'.php',
				'classobject'=>'MyObject',
				'pathobject'=>'/dolielec/class/myobject.class.php',
			),
			't.fk_soc' => array('rule' => 'fetchidfromref', 'file' => '/societe/class/societe.class.php', 'class' => 'Societe', 'method' => 'fetch', 'element' => 'ThirdParty'),
			't.fk_user_valid' => array('rule' => 'fetchidfromref', 'file' => '/user/class/user.class.php', 'class' => 'User', 'method' => 'fetch', 'element' => 'user'),
			't.fk_mode_reglement' => array('rule' => 'fetchidfromcodeorlabel', 'file' => '/compta/paiement/class/cpaiement.class.php', 'class' => 'Cpaiement', 'method' => 'fetch', 'element' => 'cpayment'),
		);
		$this->import_run_sql_after_array[$r] = array();
		$r++; */
		/* END MODULEBUILDER IMPORT MYOBJECT */
	}

	/**
	 *  Function called when module is enabled.
	 *  The init function add constants, boxes, permissions and menus (defined in constructor) into Dolibarr database.
	 *  It also creates data directories
	 *
	 *  @param      string  $options    Options when enabling module ('', 'noboxes')
	 *  @return     int<-1,1>          	1 if OK, <=0 if KO
	 */
	public function init($options = '')
	{
		global $conf, $langs;
			// Create tables of module at module activation
				$result = $this->_load_tables('/dolielec/sql/');
		if ($result < 0) {
			return -1; // Do not activate module if error 'not allowed' returned when loading module SQL queries (the _load_table run sql with run_sql with the error allowed parameter set to 'default')
		}

		// Create extrafields during init
		include_once DOL_DOCUMENT_ROOT.'/core/class/extrafields.class.php';
$extrafields = new ExtraFields($this->db);
		$extrafields->addExtraField('dolielec_travel_cost_eur', $langs->transnoentitiesnoconv('TravelCost'), 'price', 100,  12, 'societe',   0, 0, '0.00', '', 0, '0', '1', '', '', $conf->entity, 'dolielec@dolielec', 'isModEnabled("dolielec")', 0, 1, '');
		//$result1=$extrafields->addExtraField('dolielec_myattr1', "New Attr 1 label", 'boolean', 1,  3, 'thirdparty',   0, 0, '', '', 1, '', -1, 0, '', '', 'dolielec@dolielec', 'isModEnabled("dolielec")');
		//$result2=$extrafields->addExtraField('dolielec_myattr2', "New Attr 2 label", 'varchar', 1, 10, 'project',      0, 0, '', '', 1, '', -1, 0, '', '', 'dolielec@dolielec', 'isModEnabled("dolielec")');
		//$result3=$extrafields->addExtraField('dolielec_myattr3', "New Attr 3 label", 'varchar', 1, 10, 'bank_account', 0, 0, '', '', 1, '', -1, 0, '', '', 'dolielec@dolielec', 'isModEnabled("dolielec")');
		//$result4=$extrafields->addExtraField('dolielec_myattr4', "New Attr 4 label", 'select',  1,  3, 'thirdparty',   0, 1, '', array('options'=>array('code1'=>'Val1','code2'=>'Val2','code3'=>'Val3')), 1,'', -1, 0, '', '', 'dolielec@dolielec', 'isModEnabled("dolielec")');
		//$result5=$extrafields->addExtraField('dolielec_myattr5', "New Attr 5 label", 'text',    1, 10, 'user',         0, 0, '', '', 1, '', -1, 0, '', '', 'dolielec@dolielec', 'isModEnabled("dolielec")');

		// Permissions
		$this->remove($options);

		$sql = array();

		// Document templates
		$moduledir = dol_sanitizeFileName('dolielec');
													$src = DOL_DOCUMENT_ROOT.'/custom/'.$moduledir.'/assets/brie_template.odt';
				$dirodt = DOL_DATA_ROOT.($conf->entity > 1 ? '/'.$conf->entity : '').'/doctemplates/'.$moduledir;
				$dest = $dirodt.'/brie_template.odt';
				if (file_exists($src) && !file_exists($dest)) {
					require_once DOL_DOCUMENT_ROOT.'/core/lib/files.lib.php';
					dol_mkdir($dirodt);
					$result = dol_copy($src, $dest, '0', 0);
					if ($result < 0) {
						$langs->load("errors");
						$this->error = $langs->trans('ErrorFailToCopyFile', $src, $dest);
						return 0;
					}
				}	return $this->_init($sql, $options);
	}

	/**
	 *	Function called when module is disabled.
	 *	Remove from database constants, boxes and permissions from Dolibarr database.
	 *	Data directories are not deleted
	 *
	 *	@param	string		$options	Options when enabling module ('', 'noboxes')
	 *	@return	int<-1,1>				1 if OK, <=0 if KO
	 */
	public function remove($options = '')
	{
		$sql = array();
		return $this->_remove($sql, $options);
	}
}

			>>>file: custom/dolielec/core/triggers/interface_99_moddolielec_DolielecTriggers.class.php
<?php
/* Copyright (C) 2023		Laurent Destailleur			<eldy@users.sourceforge.net>
 * Copyright (C) 2025		Torres Gallego Fran			<ftorres@alelectricista.es>
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

/**
 * \file    core/triggers/interface_99_modDolielec_DolielecTriggers.class.php
 * \ingroup dolielec
 * \brief   Example trigger.
 *
 * Put detailed description here.
 *
 * \remarks You can create other triggers by copying this one.
 * - File name should be either:
 *      - interface_99_modDolielec_MyTrigger.class.php
 *      - interface_99_all_MyTrigger.class.php
 * - The file must stay in core/triggers
 * - The class name must be InterfaceMytrigger
 */

require_once DOL_DOCUMENT_ROOT.'/core/triggers/dolibarrtriggers.class.php';


/**
 *  Class of triggers for Dolielec module
 */
class InterfaceDolielecTriggers extends DolibarrTriggers
{
	/**
	 * Constructor
	 *
	 * @param DoliDB $db Database handler
	 */
	public function __construct($db)
	{
		parent::__construct($db);
		$this->family = "dolielec";
		$this->description = "Dolielec triggers.";
		$this->version = self::VERSIONS['dev'];
		$this->picto = 'dolielec@dolielec';
	}

	/**
	 * Function called when a Dolibarr business event is done.
	 * All functions "runTrigger" are triggered if file
	 * is inside directory core/triggers
	 *
	 * @param string 		$action 	Event action code
	 * @param CommonObject 	$object 	Object
	 * @param User 			$user 		Object user
	 * @param Translate 	$langs 		Object langs
	 * @param Conf 			$conf 		Object conf
	 * @return int              		Return integer <0 if KO, 0 if no triggered ran, >0 if OK
	 */
	public function runTrigger($action, $object, User $user, Translate $langs, Conf $conf)
	{
		if (!isModEnabled('dolielec')) {
			return 0; // If module is not enabled, we do nothing
		}

		// Put here code you want to execute when a Dolibarr business events occurs.
		// Data and type of action are stored into $object and $action

		// You can isolate code for each action in a separate method: this method should be named like the trigger in camelCase.
		// For example : COMPANY_CREATE => public function companyCreate($action, $object, User $user, Translate $langs, Conf $conf)
		$methodName = lcfirst(str_replace(' ', '', ucwords(str_replace('_', ' ', strtolower($action)))));
		$callback = array($this, $methodName);
		if (is_callable($callback)) {
			dol_syslog(
				"Trigger '".$this->name."' for action '$action' launched by ".__FILE__.". id=".$object->id
			);

			return call_user_func($callback, $action, $object, $user, $langs, $conf);
}
if (!is_object($object) || empty($object->element) || $object->element !== 'societe') {
return 0;
}
$clientflag = isset($object->client) ? (int) $object->client : 0;
if ($clientflag !== 1 && $clientflag !== 3) {
return 0;
}
if (in_array($action, array('COMPANY_CREATE', 'COMPANY_MODIFY'), true)) {
if ((!isset($object->array_options) || !is_array($object->array_options)) && method_exists($object, 'fetch_optionals')) {
$object->fetch_optionals();
}
            if (!isset($object->array_options) || !is_array($object->array_options)) {
$object->array_options = array();
}
$k = 'options_dolielec_travel_cost_eur';
if (!array_key_exists($k, $object->array_options) || $object->array_options[$k] === '' || $object->array_options[$k] === null) {
$object->array_options[$k] = '0.0';
if (method_exists($object, 'updateExtraFields')) {
$object->updateExtraFields();
}
elseif (method_exists($object, 'insertExtraFields')) {
$object->insertExtraFields();
}
}
if (!empty($conf->global->DOLIELEC_AUTOCALC_ON_CREATE)) {
dol_include_once('/custom/dolielec/class/geoloc.class.php');
if (class_exists('DolielecGeoloc') && method_exists('DolielecGeoloc','computeAndSaveTravelCost')) {
try {
DolielecGeoloc::computeAndSaveTravelCost($this->db, (int)$object->id);
}
catch (Exception $e) {
dol_syslog(__METHOD__.' compute error: '.$e->getMessage(), LOG_WARNING);
}
}
}
}
return 0;
if ($action === 'COMPANY_CREATE' || $action === 'COMPANY_MODIFY') {
            return $this->companyCreateModify($action, $object, $user, $langs, $conf);
        }
        return 0;
    }

    protected function companyCreateModify($action, $object, $user, $langs, $conf)
    {
        if (!is_object($object) || empty($object->element) || $object->element !== 'societe') return 0;

        $clientflag = isset($object->client) ? (int)$object->client : 0;
        if ($clientflag !== 1 && $clientflag !== 3) return 0;

        if ((!isset($object->array_options) || !is_array($object->array_options)) && method_exists($object,'fetch_optionals')) {
            $object->fetch_optionals();
        }
        if (!isset($object->array_options) || !is_array($object->array_options)) $object->array_options = array();

        $k = 'options_dolielec_travel_cost_eur';
        if (!array_key_exists($k, $object->array_options) || $object->array_options[$k] === '' || $object->array_options[$k] === null) {
            $object->array_options[$k] = '0.0';
            if (method_exists($object,'updateExtraFields'))      $object->updateExtraFields();
            elseif (method_exists($object,'insertExtraFields'))  $object->insertExtraFields();
        }

        // Autocalc toggles
        $doCreate = !empty($conf->global->DOLIELEC_AUTOCALC_ON_CREATE);
        $doModify = !empty($conf->global->DOLIELEC_AUTOCALC_ON_MODIFY);
        $doNow = (($action === 'COMPANY_CREATE' && $doCreate) || ($action === 'COMPANY_MODIFY' && $doModify));

        if ($doNow) {
            dol_include_once('/custom/dolielec/class/geoloc.class.php');
            if (class_exists('DolielecGeoloc') && method_exists('DolielecGeoloc','computeAndSaveTravelCost')) {
                try {
                    \DolielecGeoloc::computeAndSaveTravelCost($this->db, (int)$object->id);
                } catch (\Throwable $e) {
                    dol_syslog(__METHOD__.' autocalc error: '.$e->getMessage(), LOG_WARNING);
                }
            } else {
                dol_syslog(__METHOD__.' autocalc unavailable: class or method missing', LOG_DEBUG);
            }
        }
        return 0;
    }
		// Or you can execute some code here
		//switch ($action) {  // @phan-suppress-current-line PhanNoopSwitchCases
			// Users
			//case 'USER_CREATE':
			//case 'USER_MODIFY':
			//case 'USER_NEW_PASSWORD':
			//case 'USER_ENABLEDISABLE':
		//case 'USER_DELETE':

			// Actions
			//case 'ACTION_MODIFY':
			//case 'ACTION_CREATE':
			//case 'ACTION_DELETE':

			// Groups
			//case 'USERGROUP_CREATE':
			//case 'USERGROUP_MODIFY':
			//case 'USERGROUP_DELETE':

			// Companies
			//case 'COMPANY_CREATE':
			//case 'COMPANY_MODIFY':
			//case 'COMPANY_DELETE':

			// Contacts
			//case 'CONTACT_CREATE':
			//case 'CONTACT_MODIFY':
			//case 'CONTACT_DELETE':
			//case 'CONTACT_ENABLEDISABLE':

			// Products
			//case 'PRODUCT_CREATE':
			//case 'PRODUCT_MODIFY':
			//case 'PRODUCT_DELETE':
			//case 'PRODUCT_PRICE_MODIFY':
			//case 'PRODUCT_SET_MULTILANGS':
			//case 'PRODUCT_DEL_MULTILANGS':

			//Stock movement
			//case 'STOCK_MOVEMENT':

			//MYECMDIR
			//case 'MYECMDIR_CREATE':
			//case 'MYECMDIR_MODIFY':
			//case 'MYECMDIR_DELETE':

			// Sales orders
			//case 'ORDER_CREATE':
			//case 'ORDER_MODIFY':
			//case 'ORDER_VALIDATE':
			//case 'ORDER_DELETE':
			//case 'ORDER_CANCEL':
			//case 'ORDER_SENTBYMAIL':
			//case 'ORDER_CLASSIFY_BILLED':		// TODO Replace it with ORDER_BILLED
			//case 'ORDER_CLASSIFY_UNBILLED':	// TODO Replace it with ORDER_UNBILLED
			//case 'ORDER_SETDRAFT':
			//case 'LINEORDER_INSERT':
			//case 'LINEORDER_MODIFY':
			//case 'LINEORDER_DELETE':

			// Supplier orders
			//case 'ORDER_SUPPLIER_CREATE':
			//case 'ORDER_SUPPLIER_MODIFY':
			//case 'ORDER_SUPPLIER_VALIDATE':
			//case 'ORDER_SUPPLIER_DELETE':
			//case 'ORDER_SUPPLIER_APPROVE':
			//case 'ORDER_SUPPLIER_CLASSIFY_BILLED':		// TODO Replace with ORDER_SUPPLIER_BILLED
			//case 'ORDER_SUPPLIER_CLASSIFY_UNBILLED':		// TODO Replace with ORDER_SUPPLIER_UNBILLED
			//case 'ORDER_SUPPLIER_REFUSE':
			//case 'ORDER_SUPPLIER_CANCEL':
			//case 'ORDER_SUPPLIER_SENTBYMAIL':
			//case 'ORDER_SUPPLIER_RECEIVE':
			//case 'LINEORDER_SUPPLIER_DISPATCH':
			//case 'LINEORDER_SUPPLIER_CREATE':
			//case 'LINEORDER_SUPPLIER_MODIFY':
			//case 'LINEORDER_SUPPLIER_DELETE':

			// Proposals
			//case 'PROPAL_CREATE':
			//case 'PROPAL_MODIFY':
			//case 'PROPAL_VALIDATE':
			//case 'PROPAL_SENTBYMAIL':
			//case 'PROPAL_CLASSIFY_BILLED':		// TODO Replace it with PROPAL_BILLED
			//case 'PROPAL_CLASSIFY_UNBILLED':		// TODO Replace it with PROPAL_UNBILLED
			//case 'PROPAL_CLOSE_SIGNED':
			//case 'PROPAL_CLOSE_REFUSED':
			//case 'PROPAL_DELETE':
			//case 'LINEPROPAL_INSERT':
			//case 'LINEPROPAL_MODIFY':
			//case 'LINEPROPAL_DELETE':

			// SupplierProposal
			//case 'SUPPLIER_PROPOSAL_CREATE':
			//case 'SUPPLIER_PROPOSAL_MODIFY':
			//case 'SUPPLIER_PROPOSAL_VALIDATE':
			//case 'SUPPLIER_PROPOSAL_SENTBYMAIL':
			//case 'SUPPLIER_PROPOSAL_CLOSE_SIGNED':
			//case 'SUPPLIER_PROPOSAL_CLOSE_REFUSED':
			//case 'SUPPLIER_PROPOSAL_DELETE':
			//case 'LINESUPPLIER_PROPOSAL_INSERT':
			//case 'LINESUPPLIER_PROPOSAL_MODIFY':
			//case 'LINESUPPLIER_PROPOSAL_DELETE':

			// Contracts
			//case 'CONTRACT_CREATE':
			//case 'CONTRACT_MODIFY':
			//case 'CONTRACT_ACTIVATE':
			//case 'CONTRACT_CANCEL':
			//case 'CONTRACT_CLOSE':
			//case 'CONTRACT_DELETE':
			//case 'LINECONTRACT_INSERT':
			//case 'LINECONTRACT_MODIFY':
			//case 'LINECONTRACT_DELETE':

			// Bills
			//case 'BILL_CREATE':
			//case 'BILL_MODIFY':
			//case 'BILL_VALIDATE':
			//case 'BILL_UNVALIDATE':
			//case 'BILL_SENTBYMAIL':
			//case 'BILL_CANCEL':
			//case 'BILL_DELETE':
			//case 'BILL_PAYED':
			//case 'LINEBILL_INSERT':
			//case 'LINEBILL_MODIFY':
			//case 'LINEBILL_DELETE':

			// Recurring Bills
			//case 'BILLREC_MODIFY':
			//case 'BILLREC_DELETE':
			//case 'BILLREC_AUTOCREATEBILL':
			//case 'LINEBILLREC_MODIFY':
			//case 'LINEBILLREC_DELETE':

			//Supplier Bill
			//case 'BILL_SUPPLIER_CREATE':
			//case 'BILL_SUPPLIER_MODIFY':
			//case 'BILL_SUPPLIER_DELETE':
			//case 'BILL_SUPPLIER_PAYED':
			//case 'BILL_SUPPLIER_UNPAYED':
			//case 'BILL_SUPPLIER_VALIDATE':
			//case 'BILL_SUPPLIER_UNVALIDATE':
			//case 'LINEBILL_SUPPLIER_CREATE':
			//case 'LINEBILL_SUPPLIER_MODIFY':
			//case 'LINEBILL_SUPPLIER_DELETE':

			// Payments
			//case 'PAYMENT_CUSTOMER_CREATE':
			//case 'PAYMENT_SUPPLIER_CREATE':
			//case 'PAYMENT_ADD_TO_BANK':
			//case 'PAYMENT_DELETE':

			// Online
			//case 'PAYMENT_PAYBOX_OK':
			//case 'PAYMENT_PAYPAL_OK':
			//case 'PAYMENT_STRIPE_OK':

			// Donation
			//case 'DON_CREATE':
			//case 'DON_MODIFY':
			//case 'DON_DELETE':

			// Interventions
			//case 'FICHINTER_CREATE':
			//case 'FICHINTER_MODIFY':
			//case 'FICHINTER_VALIDATE':
			//case 'FICHINTER_CLASSIFY_BILLED':			// TODO Replace it with FICHINTER_BILLED
			//case 'FICHINTER_CLASSIFY_UNBILLED':		// TODO Replace it with FICHINTER_UNBILLED
			//case 'FICHINTER_DELETE':
			//case 'LINEFICHINTER_CREATE':
			//case 'LINEFICHINTER_MODIFY':
			//case 'LINEFICHINTER_DELETE':

			// Members
			//case 'MEMBER_CREATE':
			//case 'MEMBER_VALIDATE':
			//case 'MEMBER_SUBSCRIPTION':
			//case 'MEMBER_MODIFY':
			//case 'MEMBER_NEW_PASSWORD':
			//case 'MEMBER_RESILIATE':
			//case 'MEMBER_DELETE':

			// Categories
			//case 'CATEGORY_CREATE':
			//case 'CATEGORY_MODIFY':
			//case 'CATEGORY_DELETE':
			//case 'CATEGORY_SET_MULTILANGS':

			// Projects
			//case 'PROJECT_CREATE':
			//case 'PROJECT_MODIFY':
			//case 'PROJECT_DELETE':

			// Project tasks
			//case 'TASK_CREATE':
			//case 'TASK_MODIFY':
			//case 'TASK_DELETE':

			// Task time spent
			//case 'TASK_TIMESPENT_CREATE':
			//case 'TASK_TIMESPENT_MODIFY':
			//case 'TASK_TIMESPENT_DELETE':
			//case 'PROJECT_ADD_CONTACT':
			//case 'PROJECT_DELETE_CONTACT':
			//case 'PROJECT_DELETE_RESOURCE':

			// Shipping
			//case 'SHIPPING_CREATE':
			//case 'SHIPPING_MODIFY':
			//case 'SHIPPING_VALIDATE':
			//case 'SHIPPING_SENTBYMAIL':
			//case 'SHIPPING_BILLED':
			//case 'SHIPPING_CLOSED':
			//case 'SHIPPING_REOPEN':
			//case 'SHIPPING_DELETE':

			// and more...

			//default:
//				dol_syslog("Trigger '".$this->name."' for action '".$action."' launched by ".__FILE__.". id=".$object->id);
				//break;
		//}
//return 0;
	//}

    public function companyModify($action, $object, User $user, Translate $langs, Conf $conf)
    {
        if (!is_object($object) || empty($object->element) || $object->element !== 'societe') return 0;
        $clientflag = isset($object->client) ? (int)$object->client : 0;
        if ($clientflag !== 1 && $clientflag !== 3) return 0;
        // Cargar extrafields
        if ((!isset($object->array_options) || !is_array($object->array_options)) && method_exists($object,'fetch_optionals')) {
            $object->fetch_optionals();
        }
        if (!isset($object->array_options) || !is_array($object->array_options)) {
            $object->array_options = array();
        }
        $k = 'options_dolielec_travel_cost_eur';
        if (!array_key_exists($k, $object->array_options) || $object->array_options[$k] === '' || $object->array_options[$k] === null) {
            $object->array_options[$k] = '0.0';
            if (method_exists($object,'updateExtraFields')) {
                $object->updateExtraFields();
            } elseif (method_exists($object,'insertExtraFields')) {
                $object->insertExtraFields();
            }
        }
        return 0;
    }

}

// TODO: could not locate method companyCreate

>>>file: custom/dolielec/core/triggers/interface_99_moddolielec_ProfitTriggers.class.php
<?php
require_once DOL_DOCUMENT_ROOT.'/core/triggers/dolibarrtriggers.class.php';
require_once DOL_DOCUMENT_ROOT.'/custom/dolielec/class/profit.class.php';

class InterfaceProfitTriggers extends DolibarrTriggers {
    public $db;
    public function __construct($db) {
        parent::__construct($db);
        $this->db = $db;
        $this->family = 'dolielec';
        $this->description = 'Profitability/Prices/RPO triggers';
        $this->version = self::VERSIONS['dev'];
    }
    public function runTrigger($action, $object, $user, $langs, $conf) {
        if (!in_array($action, array('PRODUCT_SUPPLIER_PRICE_CREATE', 'PRODUCT_SUPPLIER_PRICE_MODIFY'))) {
            return 0;
        }
       
        $refSupplier = isset($object->ref_supplier) ? $object->ref_supplier : '';
        $buyPriceHT = isset($object->fourn_price) ? $object->fourn_price : (isset($object->fourn_pu) ? $object->fourn_pu : 0);
        
        if (empty($refSupplier)) {
            dol_syslog(__METHOD__.': ref_supplier vac√≠o, abortando', LOG_WARNING);
            return 0;
        }
        if ($buyPriceHT <= 0) {
            dol_syslog(__METHOD__.': Precio compra inv√°lido, abortando', LOG_WARNING);
            return 0;
        }
                $profit = new Profit($this->db);
        $result = $profit->getPrice($refSupplier, $buyPriceHT);
              if (!$result['success']) {
            dol_syslog(__METHOD__.': Profit->getPrice KO: '.$result['message'], LOG_WARNING);
            return -1;
        }
             dol_syslog(__METHOD__.': Precio calculado autom√°ticamente: '.$result['price'].' EUR', LOG_INFO);
        return 0;
    }

}>>>file: custom/dolielec/css/dolielec.css.php
<?php
// dolielec.css.php - CSS accesible para el m√≥dulo Dolielec (bloque 17)
header("Content-type: text/css");

// Estilo para el asterisco de campo obligatorio
?>
.fieldrequired {
    color: #B00020; /* Alto contraste rojo */
    font-weight: bold;
    margin-right: 5px;
    font-size: 1.1em;
}
input[required], select[required], textarea[required] {
    border-left: 4px solid #B00020;
}
input:focus-visible, select:focus-visible, textarea:focus-visible, button:focus-visible {
    outline: 3px solid #005fcc;
    outline-offset: 2px;
}
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    overflow: hidden;
    clip: rect(0,0,0,0);
    white-space: nowrap;
    border: 0;
}

/* === Accesibilidad ‚Äì helpers comunes === */
.visually-hidden{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.skip-link{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
.skip-link:focus{position:static;width:auto;height:auto;display:inline-block;padding:.5rem 1rem;border:2px solid currentColor;border-radius:.2rem;background:transparent}
.biel-identity{max-width:70ch;line-height:1.6}
.biel-identity a{text-decoration:underline;text-underline-offset:2px;text-decoration-thickness:2px}
.biel-identity a:focus-visible{outline:3px solid currentColor;outline-offset:3px;border-radius:.2rem}
.biel-identity h2,.biel-identity h3{margin:1rem 0 .25rem 0}
.biel-identity ul{padding-left:1.25rem}
.biel-identity li{margin:.25rem 0}
.biel-identity code{padding:.1rem .3rem;border:1px solid #888;border-radius:.2rem}
@media (max-width: 360px){ .biel-identity{max-width:100%;word-break:break-word;overflow-wrap:anywhere} }

>>>file: custom/dolielec/includes/certificates.inc.php
<?php
// custom/dolielec/includes/certificates.inc.php
require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/files.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/functions.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/functions2.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/security.lib.php';
require_once DOL_DOCUMENT_ROOT.'/societe/class/societe.class.php';
require_once DOL_DOCUMENT_ROOT.'/ecm/class/ecmfiles.class.php';
require_once DOL_DOCUMENT_ROOT.'/custom/dolielec/class/doc.class.php';
require_once DOL_DOCUMENT_ROOT.'/custom/dolielec/lib/dolielec.lib.php';
global $db, $conf, $langs, $user, $mysoc;
$langs->loadLangs(array('main','companies','dolielec@dolielec'));
if (empty($user->rights->dolielec->read)) accessforbidden();
$action  = GETPOST('action','alpha');
$socid   = GETPOST('socid','int');
$backurl = !empty($socid) ? dol_buildpath('/societe/card.php',1).'?id='.$socid.'&tab=documents' : dol_buildpath('/custom/dolielec/doc.php',1).'?tab=brie';
$doc  = new Documentation($db);
$inst = $doc->getInst();
// Directorios base (convenci√≥n Dolibarr)
$modroot   = !empty($conf->dolielec->dir_output) ? $conf->dolielec->dir_output : DOL_DATA_ROOT.'/dolielec';
$tmpDir    = $modroot.'/var/tmp';
$signedDir = $modroot.'/docs/signed';
$certDir   = $modroot.'/docs/cert';
dol_mkdir($tmpDir);
dol_mkdir($signedDir);
dol_mkdir($certDir);
// Ruta plantilla (correcta: doctemplates)
$templateBrie = DOL_DATA_ROOT.'/doctemplates/dolielec/brie_template.odt';
if ($action === 'brie_save') {
    // CSRF
    $token = GETPOST('token','alphanohtml');
    if (empty($token) || !dol_verifyToken($token)) accessforbidden();
    $form = GETPOST('form','array');
    $out  = GETPOST('out','array');
    // 1) Construir datos
    $data = $doc->setBrie($form, $socid);
    // 2) Destinatarios
    $targets = array();
    if (!empty($out['TITULAR']))        $targets[] = 'TITULAR';
    if (!empty($out['DISTRIBUIDORA']))  $targets[] = 'DISTRIBUIDORA';
    if (!empty($out['INSTALADOR']))     $targets[] = 'INSTALADOR';
    if (empty($targets)) $targets = array('TITULAR');
    // 3) Generaci√≥n documentos
    $generated = array();   // signed pdfs absolutos

    $cupsSafe   = dol_sanitizeFileName(!empty($data['CUPS']) ? $data['CUPS'] : 'SIN_CUPS');
    $dateSafe   = dol_print_date(dol_now(), '%Y%m%d');
    $baseName   = 'brie_'.$cupsSafe.'_'.$dateSafe;
    // Plantilla debe existir
    if (!is_readable($templateBrie)) {
        setEventMessages($langs->trans('TemplateNotFound').' '.$templateBrie, null, 'errors');
        header('Location: '.$backurl);
        exit;
    }
    foreach ($targets as $tg) {
        $fname = $baseName.'_'.$tg;
        // ODT
        $odtOut = $tmpDir.'/'.$fname.'.odt';
        // >>> orden correcto: (template, output, data)
        $resODT = $doc->renderODT($templateBrie, $odtOut, $data);
        if (empty($resODT['success'])) {
            setEventMessages($langs->trans('Error').' ODT: '.$resODT['message'], null, 'errors');
            continue;
        }
        // PDF
        $pdfTmp = $tmpDir.'/'.$fname.'.pdf';
        $resPDF = $doc->odtToPdf($odtOut, $pdfTmp);
        if (empty($resPDF['success'])) {
            setEventMessages($langs->trans('Error').' PDF: '.$resPDF['message'], null, 'errors');
            continue;
        }
        // Firmar
        try {
            $signedOut = $signedDir.'/'.$fname.'-signed.pdf';
            $ok = $doc->setSign($pdfTmp, $signedOut);
            if ($ok && is_readable($signedOut)) {
                $generated[] = $signedOut;
            } else {
                setEventMessages($langs->trans('ErrorFileNotFound').' (signed pdf)', null, 'errors');
            }
        } catch (Exception $e) {
            setEventMessages($e->getMessage(), null, 'errors');
        }
    }

    // 4) Destino
    $dest = !empty($out['DEST']) ? $out['DEST'] : 'ECM';

    if ($dest === 'ECM') {
        // Guardar/adjuntar en ECM (si hay tercero)
        if (!empty($socid)) {
            foreach ($generated as $abs) {
                $rel = $doc->attachToThirdparty($socid, $abs);
                if ($rel === '') {
                    setEventMessages($langs->trans('Error').' ECM attach: '.basename($abs), null, 'warnings');
                }
            }
            setEventMessages($langs->trans('RecordSaved'), null, 'mesgs');
            header('Location: '.$backurl);
            exit;
        } else {
            // Sin tercero, igualmente deja los ficheros en signed y muestra mensaje con nombres
            $names = array_map('basename', $generated);
            setEventMessages($langs->trans('RecordSaved').' ‚Äî '.implode(', ', $names), null, 'mesgs');
            header('Location: '.$backurl);
            exit;
        }
    } else {
        // SIGNED: preparar descarga (si >1 => ZIP)
        if (count($generated) === 0) {
            setEventMessages($langs->trans('ErrorFileNotFound'), null, 'errors');
            header('Location: '.$backurl);
            exit;
        }
        if (count($generated) === 1) {
            $abs = $generated[0];
            $bn  = basename($abs);
            header('Content-Type: application/pdf');
            header('Content-Disposition: attachment; filename="'.dol_escape_htmltag($bn).'"');
            header('Content-Length: '.filesize($abs));
            readfile($abs);
            exit;
        } else {
            $zipPath = $tmpDir.'/'.$baseName.'_signed.zip';
            if (file_exists($zipPath)) @unlink($zipPath);
            $zip = new ZipArchive();
            if ($zip->open($zipPath, ZipArchive::CREATE) === true) {
                foreach ($generated as $abs) {
                    $zip->addFile($abs, basename($abs));
                }
                $zip->close();
                header('Content-Type: application/zip');
                header('Content-Disposition: attachment; filename="'.dol_escape_htmltag(basename($zipPath)).'"');
                header('Content-Length: '.filesize($zipPath));
                readfile($zipPath);
                @unlink($zipPath);
                exit;
            } else {
                // Si falla el zip, muestra links en mensaje y vuelve
                $names = array_map('basename', $generated);
                setEventMessages($langs->trans('RecordSaved').' ‚Äî '.implode(', ', $names), null, 'mesgs');
                header('Location: '.$backurl);
                exit;
            }
        }
    }
}

if ($action === 'brie' || empty($action) || $action === 'brie_save') {
    $third = null;
    if (!empty($socid)) {
        $third = new Societe($db);
        $third->fetch($socid);
    }

    // Prefills
    $valueDate       = dol_print_date(dol_now(), '%Y-%m-%d'); // HTML date
    $isPerson        = ($inst['type'] === 'person');
    $prefillTechName = $isPerson ? dol_escape_htmltag(trim((!empty($inst['firstname'])?$inst['firstname']:'').' '.(!empty($inst['lastname'])?$inst['lastname']:''))) : '';
    $prefillTechDni  = $isPerson ? dol_escape_htmltag($inst['nif']) : '';
    print '<form method="POST" action="'.$_SERVER['PHP_SELF'].'">';
    print '<input type="hidden" name="token" value="'.newToken().'">';
    print '<input type="hidden" name="action" value="brie_save">';
    if (!empty($socid)) print '<input type="hidden" name="socid" value="'.$socid.'">';
    print '<div class="div-table-responsive-no-min"><table class="noborder centpercent">';

    // Fecha
    print '<tr class="liste_titre"><th colspan="4">'.$langs->trans("Date").'</th></tr>';
    print '<tr><td class="titlefield"><label for="brie_date">'.$langs->trans("Date").' *</label></td>';
    print '<td colspan="3"><input type="date" id="brie_date" name="form[BRIE_FECHA]" value="'.$valueDate.'" required></td></tr>';

    // Identificaci√≥n
    print '<tr class="liste_titre"><th colspan="4">'.$langs->trans("BRIEIdentification").'</th></tr>';
    print '<tr><td class="titlefield"><label for="cups">'.$langs->trans("CUPS").' *</label></td><td colspan="3"><input type="text" id="cups" name="form[CUPS]" required class="quatrevingtpercent"></td></tr>';

    // Datos del titular
    print '<tr class="liste_titre"><th colspan="4">'.$langs->trans("BRIEOwnerData").'</th></tr>';
    if (!empty($third) && $third->id > 0) {
        print '<tr><td class="titlefield">'.$langs->trans("Name").' *</td><td>'.dol_escape_htmltag($third->name).'</td>';
        print '<td>'.$langs->trans("Email").'</td><td>'.dol_escape_htmltag($third->email).'</td></tr>';
        print '<tr><td>'.$langs->transcountry("ProfId1", !empty($third->country_id) ? $third->country_id : $mysoc->country_id).' *</td><td>'.dol_escape_htmltag($third->idprof1).'</td>';
        print '<td>'.$langs->trans("Phone").' *</td><td>'.dol_escape_htmltag($third->phone).'</td></tr>';
        print '<tr><td>'.$langs->trans("Address").' *</td><td colspan="3">'.dol_escape_htmltag($third->address).'</td></tr>';
        print '<tr><td>'.$langs->trans("Zip").' *</td><td>'.dol_escape_htmltag($third->zip).'</td>';
        print '<td>'.$langs->trans("Town").' *</td><td>'.dol_escape_htmltag($third->town).'</td></tr>';
        print '<input type="hidden" name="form[TIT_NIF]" value="'.dol_escape_htmltag($third->idprof1).'">';
        print '<input type="hidden" name="form[TIT_NOMBRE]" value="'.dol_escape_htmltag($third->name).'">';
        print '<input type="hidden" name="form[TIT_TLF]" value="'.dol_escape_htmltag($third->phone).'">';
        print '<input type="hidden" name="form[TIT_DOM]" value="'.dol_escape_htmltag($third->address).'">';
        print '<input type="hidden" name="form[TIT_CP]" value="'.dol_escape_htmltag($third->zip).'">';
        print '<input type="hidden" name="form[TIT_LOCALIDAD]" value="'.dol_escape_htmltag($third->town).'">';
    } else {
        print '<tr><td class="titlefield"><label for="tit_nombre">'.$langs->trans("Name").' *</label></td><td><input type="text" id="tit_nombre" name="form[TIT_NOMBRE]" required></td>';
        print '<td><label for="tit_nif">'.$langs->transcountry("ProfId1", $mysoc->country_id).' *</label></td><td><input type="text" id="tit_nif" name="form[TIT_NIF]" required></td></tr>';
        print '<tr><td><label for="tit_tel">'.$langs->trans("Phone").' *</label></td><td><input type="text" id="tit_tel" name="form[TIT_TLF]" required></td>';
        print '<td><label for="tit_email">'.$langs->trans("Email").'</label></td><td><input type="email" id="tit_email" name="form[TIT_EMAIL]"></td></tr>';
        print '<tr><td><label for="tit_dom">'.$langs->trans("Address").' *</label></td><td colspan="3"><input type="text" id="tit_dom" name="form[TIT_DOM]" required class="quatrevingtpercent"></td></tr>';
        print '<tr><td><label for="tit_cp">'.$langs->trans("Zip").' *</label></td><td><input type="text" id="tit_cp" name="form[TIT_CP]" required></td>';
        print '<td><label for="tit_loc">'.$langs->trans("Town").' *</label></td><td><input type="text" id="tit_loc" name="form[TIT_LOCALIDAD]" required></td></tr>';
    }

    // Direcci√≥n instalaci√≥n
    print '<tr class="liste_titre"><th colspan="4">'.$langs->trans("BRIEInstallationPlace").'</th></tr>';
    print '<tr><td class="titlefield"><label for="via">'.$langs->trans("Street").' *</label></td><td><input type="text" id="via" name="form[VIA]" required></td>';
    print '<td><label for="num">'.$langs->trans("Number").' *</label></td><td><input type="text" id="num" name="form[NUM]" required></td></tr>';
    print '<tr><td><label for="piso">'.$langs->trans("Floor").'</label></td><td><input type="text" id="piso" name="form[PISO]"></td>';
    print '<td><label for="porta">'.$langs->trans("Door").' *</label></td><td><input type="text" id="porta" name="form[PORTA]" required></td></tr>';
    print '<tr><td><label for="cp">'.$langs->trans("Zip").' *</label></td><td><input type="text" id="cp" name="form[CP]" required></td>';
    print '<td><label for="loc">'.$langs->trans("Town").' *</label></td><td><input type="text" id="loc" name="form[LOCALIDAD]" required></td></tr>';
    print '<tr><td><label for="act_ant">'.$langs->trans("PreviousActivity").'</label></td><td><input type="text" id="act_ant" name="form[ACTIVIDAD_ANT]"></td>';
    print '<td><label for="act_act">'.$langs->trans("NewActivity").'</label></td><td><input type="text" id="act_act" name="form[ACTIVIDAD_ACT]"></td></tr>';
    print '<tr><td><label for="superf">'.$langs->trans("Surface").' (m¬≤) *</label></td><td><input type="number" id="superf" name="form[SUPERF]" min="0" step="1" required></td><td></td><td></td></tr>';

    // Datos t√©cnicos
    print '<tr class="liste_titre"><th colspan="4">'.$langs->trans("BRIETechnicalData").'</th></tr>';
    print '<tr><td class="titlefield"><label for="dif_num">Interruptors diferencials ‚Äî '.$langs->trans("RCDNumber").' *</label></td><td><input type="number" id="dif_num" name="form[DIF_NUM]" min="0" step="1" required></td>';
    print '<td><label for="dif_sens">'.$langs->trans("Sensitivity").' (mA) *</label></td><td><input type="number" id="dif_sens" name="form[DIF_SENS]" min="0" step="1" required></td></tr>';
    print '<tr><td class="titlefield"><label for="di_sec">'.$langs->trans("Section").' (mm¬≤) *</label></td><td><input type="text" id="di_sec" name="form[DI_SECCION]" required></td><td></td><td></td></tr>';
    print '<tr><td class="titlefield"><label for="ten_ant">'.$langs->trans("PreviousVoltage").' *</label></td><td><input type="text" id="ten_ant" name="form[TENSION_ANT]" required></td>';
    print '<td><label for="ten_act">'.$langs->trans("NewVoltage").' *</label></td><td><input type="text" id="ten_act" name="form[TENSION_ACT]" required></td></tr>';
    print '<tr><td class="titlefield"><label for="pot_max">'.$langs->trans("MaxPowerKW").' *</label></td><td><input type="number" id="pot_max" name="form[POT_MAX]" step="0.01" min="0" required></td>';
    print '<td><label for="pot_ini">'.$langs->trans("InitialPowerKW").' *</label></td><td><input type="number" id="pot_ini" name="form[POT_INICIAL]" step="0.01" min="0" required></td></tr>';
    print '<tr><td class="titlefield"><label for="pot_con">'.$langs->trans("ContractedPowerKW").' *</label></td><td><input type="number" id="pot_con" name="form[POT_CONTRATAR]" step="0.01" min="0" required></td>';
    print '<td><label for="prot_tipo">Protecci√≥ general</label></td><td>'.
        '<span class="opacitymedium">IGA / ICPM</span><br>'.
        '<label><input type="radio" name="form[PROT_GEN_TIPO]" value="IGA" required> IGA</label>'.
        '<label class="marginleftonly"><input type="radio" name="form[PROT_GEN_TIPO]" value="ICPM"> ICPM</label> '.
        '<label for="prot_int">'.$langs->trans("NominalIntensity").' (A) *</label> '.
        '<input type="number" id="prot_int" name="form[PROT_GEN_INT]" min="0" step="1" required>'.
    '</td></tr>';

    // Tierra / Aislamiento / Ascensor
    print '<tr><td class="titlefield"><span id="lbl_tierra">'.$langs->trans("EarthingExists").' *</span></td><td>'.
         '<div role="group" aria-labelledby="lbl_tierra">'.
         '  <input type="radio" id="tierra_si" name="form[TIERRA_EXISTE]" value="SI" required aria-labelledby="lbl_tierra"> <label for="tierra_si">'.$langs->trans("Yes").'</label>'.
         '  <input type="radio" id="tierra_no" name="form[TIERRA_EXISTE]" value="NO" aria-labelledby="lbl_tierra" class="marginleftonly"> <label for="tierra_no">'.$langs->trans("No").'</label>'.
         '</div>'.
    '</td>';
    print '<td><label for="tierra_val">'.$langs->trans("EarthingOhms").' *</label></td><td>'.
        '<input type="number" id="tierra_val" name="form[TIERRA_VALOR]" step="0.01" min="0" required>'.
    '</td></tr>';

    print '<tr><td class="titlefield"><span id="lbl_aisla">'.$langs->trans("Insulation").' *</span></td><td>'.
         '<div role="group" aria-labelledby="lbl_aisla">'.
         '  <input type="radio" id="aisla_si" name="form[AISLAMIENTO]" value="SI" required aria-labelledby="lbl_aisla"> <label for="aisla_si">'.$langs->trans("Yes").'</label>'.
         '  <input type="radio" id="aisla_no" name="form[AISLAMIENTO]" value="NO" aria-labelledby="lbl_aisla" class="marginleftonly"> <label for="aisla_no">'.$langs->trans("No").'</label>'.
         '</div>'.
    '</td>';
    print '<td><label for="aisla_val">'.$langs->trans("Resistance").' (Œ©) *</label></td><td>'.
        '<input type="number" id="aisla_val" name="form[AISLAMIENTO_VALOR]" step="1" min="0" required>'.
    '</td></tr>';

    print '<tr><td class="titlefield"><span id="lbl_asc">'.$langs->trans("Lift").' *</span></td><td>'.
         '<div role="group" aria-labelledby="lbl_asc">'.
         '  <input type="radio" id="asc_si" name="form[ASCENSOR]" value="SI" required aria-labelledby="lbl_asc"> <label for="asc_si">'.$langs->trans("Yes").'</label>'.
         '  <input type="radio" id="asc_no" name="form[ASCENSOR]" value="NO" aria-labelledby="lbl_asc" class="marginleftonly"> <label for="asc_no">'.$langs->trans("No").'</label>'.
         '</div>'.
    '</td>';
    print '<td><label for="pot_asc">'.$langs->trans("LiftPowerKW").' *</label></td><td>'.
        '<input type="number" id="pot_asc" name="form[POT_ASCENSOR]" step="0.01" min="0" required>'.
    '</td></tr>';

    // Defectos (8)
    print '<tr class="liste_titre"><th colspan="4">'.$langs->trans("BRIEDefects").'</th></tr>';
    $def = array(
        'DEF_1' => $langs->trans('DefectDirectContact'),
        'DEF_2' => $langs->trans('DefectProhibitedZoneBathroom'),
        'DEF_3' => $langs->trans('DefectIndirectContactProtectionLacking'),
        'DEF_4' => $langs->trans('DefectMainSwitchMissing'),
        'DEF_5' => $langs->trans('DefectOvercurrentProtectionMissing'),
        'DEF_6' => $langs->trans('DefectInsulationResistanceLow'),
        'DEF_7' => $langs->trans('DefectLeakageCurrentHigh'),
        'DEF_8' => $langs->trans('DefectEarthResistanceHigh')
    );
    print '<tr><td colspan="4"><div class="div-table-responsive-no-min"><table class="noborder centpercent">';
    print '<tr class="liste_titre"><th class="titlefield">'.$langs->trans("Defect").'</th><th>'.$langs->trans("Yes").'</th><th>'.$langs->trans("No").'</th></tr>';
    $idx = 0;
    foreach ($def as $k => $label) {
        $idx++;
        $rowHdrId = 'defect_'.$idx.'_label';
        $idYes = 'def_'.$idx.'_si';
        $idNo  = 'def_'.$idx.'_no';
        print '<tr>';
        print '<th id="'.dol_escape_htmltag($rowHdrId).'" scope="row" class="titlefield">'.dol_escape_htmltag($label).'</th>';
        print '<td>';
        print '<div role="group" aria-labelledby="'.dol_escape_htmltag($rowHdrId).'">';
        print '  <input type="radio" id="'.dol_escape_htmltag($idYes).'" name="form['.$k.']" value="SI" required aria-labelledby="'.dol_escape_htmltag($rowHdrId).'">';
        print '  <label for="'.dol_escape_htmltag($idYes).'">'.$langs->trans("Yes").'</label>';
        print '</div>';
        print '</td>';
        print '<td>';
        print '<div role="group" aria-labelledby="'.dol_escape_htmltag($rowHdrId).'">';
        print '  <input type="radio" id="'.dol_escape_htmltag($idNo).'" name="form['.$k.']" value="NO" aria-labelledby="'.dol_escape_htmltag($rowHdrId).'">';
        print '  <label for="'.dol_escape_htmltag($idNo).'">'.$langs->trans("No").'</label>';
        print '</div>';
        print '</td>';
        print '</tr>';
    }
    print '</table></div></td></tr>';

    // Trabajo / comentarios
    print '<tr class="liste_titre"><th colspan="4">'.$langs->trans("BRIEWorks").'</th></tr>';
    print '<tr><td class="titlefield"><label for="trab">'.$langs->trans("WorksDone").' *</label></td><td colspan="3"><input type="text" id="trab" name="form[TRABAJO]" required class="quatrevingtpercent"></td></tr>';
    print '<tr><td><label for="coment">'.$langs->trans("Comments").' *</label></td><td colspan="3"><input type="text" id="coment" name="form[COMENTARIOS]" required class="quatrevingtpercent"></td></tr>';

    // Instalador (mostrar nombre/empresa + RASIC) + firmante
    print '<tr class="liste_titre"><th colspan="4">'.$langs->trans("BRIEInstaller").'</th></tr>';
    print '<tr><td class="titlefield">'.$langs->trans("Company").'</td><td>'.dol_escape_htmltag($inst['display']).'</td>';
    print '<td>'.$langs->transcountry("ProfId4", $mysoc->country_id).'</td><td>'.dol_escape_htmltag($inst['rasic']).'</td></tr>';

    // Prefill del firmante si 401
    print '<tr><td><label for="cert_nom">'.$langs->trans("TechnicianName").' *</label></td><td><input id="cert_nom" type="text" name="form[CERT_NOMBRE]" required value="'.$prefillTechName.'"></td>';
    print '<td><label for="cert_dni">'.$langs->transcountry("ProfId1", $mysoc->country_id).' *</label></td><td><input id="cert_dni" type="text" name="form[CERT_DNI]" required value="'.$prefillTechDni.'"></td></tr>';

    print '<tr><td><label for="lugar">'.$langs->trans("Place").' *</label></td><td><input id="lugar" type="text" name="form[LUGAR]" required></td><td></td><td></td></tr>';

    // Salidas
    print '<tr class="liste_titre"><th colspan="4">'.$langs->trans("Outputs").'</th></tr>';
    print '<tr><td class="titlefield">'.$langs->trans("GenerateFor").'</td><td colspan="3">
        <label><input type="checkbox" name="out[TITULAR]" value="1" checked> '.$langs->trans("Owner").'</label>
        <label class="marginleftonly"><input type="checkbox" name="out[DISTRIBUIDORA]" value="1" checked> '.$langs->trans("Distributor").'</label>
        <label class="marginleftonly"><input type="checkbox" name="out[INSTALADOR]" value="1" checked> '.$langs->trans("Installer").'</label>
    </td></tr>';
    print '<tr><td>'.$langs->trans("Destination").'</td><td colspan="3">
        <label><input type="radio" name="out[DEST]" value="ECM" checked> '.$langs->trans("SaveInECM").'</label>
        <label class="marginleftonly"><input type="radio" name="out[DEST]" value="SIGNED"> '.$langs->trans("SaveInSignedFolder").'</label>
    </td></tr>';

    print '</table></div>';
    print '<div class="center">';
    print '<input class="button button-save" type="submit" value="'.$langs->trans("Save").'">';
    print ' <a class="button" href="'.$backurl.'">'.$langs->trans("Cancel").'</a>';
    print '</div>';
    print '</form>';
}

>>>file: custom/dolielec/includes/sign.inc.php
<?php
// sig_form.inc.php ‚Äì formulario de firma de PDF con certificado digital
global $langs, $conf;
$langs->load('dolielec@dolielec');

$cert_file = $conf->global->DOLIELEC_CERT_FILE;

print '<form id="SignPdf" enctype="multipart/form-data" method="POST" action="'.dol_buildpath('/custom/dolielec/doc.php?tab=signature',1).'">';
print '  <input type="hidden" name="action" value="">';
print '  <div class="div-table-responsive-no-min">';
print '    <table class="noborder centpercent">';
print '      <tr class="liste_titre">';
print '        <th class="titlefield">'.$langs->trans('DocumentToSign').'</th>';
print '        <th>'.$langs->trans('Value').'</th>';
print '      </tr>';
print '      <tr>';
print '        <td><label for="file_pdf">'.$langs->trans('ChoosePDF').' *</label></td>';
print '        <td><input type="file" id="file_pdf" name="file_pdf" class="minwidth200" required accept=".pdf">';
if ($cert_file) {
    print '<br><span class="opacitymedium">'.$langs->trans('CertFile').': '.dol_escape_htmltag($cert_file).'</span>';
}
print '        </td>';
print '      </tr>';
print '    </table>';
print '  </div>';
print '  <div class="center">';
print '<button type="button" id="signPdfBtn" class="button button-sign">'.$langs->trans('SignPDF').'</button>';
print '  </div>';
print '</form>';

// Carga JS para firma
print '<script type="text/javascript" src="'.dol_buildpath('/custom/dolielec/js/doc.js.php',1).'"></script>';
?>

>>>file: custom/dolielec/js/anthropic.js.php
<?php
$res = 0;
if (! $res && file_exists("../../main.inc.php")) $res = @include("../../main.inc.php");
if (! $res && file_exists("../../../main.inc.php")) $res = @include("../../../main.inc.php");
if (! $res && file_exists("../../../../main.inc.php")) $res = @include("../../../../main.inc.php");
if (! $res) die("Include of main fails");

header('Content-Type: application/javascript; charset=UTF-8');
global $langs;
$langs->load("dolielec@dolielec");

?>

jQuery(document).ready(function($) {
if (!$('#anthropic_api_key').length) return;
// Bot√≥n: comprobar conexi√≥n

¬† ¬† $('#anthropic_check_api').click(function(e) {

¬† ¬† ¬† ¬† e.preventDefault();

¬† ¬† ¬† ¬† let api_key = $('#anthropic_api_key').val();

¬† ¬† ¬† ¬† if (!api_key || api_key.trim() === '') {

¬† ¬† ¬† ¬† ¬† ¬† alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv("MissingAPIKey")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† return;

¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† $.ajax({

¬† ¬† ¬† ¬† ¬† ¬† url: "<?php echo dol_buildpath('/custom/dolielec/ajax/anthropic.ajax.php', 1); ?>",

¬† ¬† ¬† ¬† ¬† ¬† method: "POST",

¬† ¬† ¬† ¬† ¬† ¬† dataType: "json",

¬† ¬† ¬† ¬† ¬† ¬† data: {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† action: "check_api_conn",

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† api_key: api_key

¬† ¬† ¬† ¬† ¬† ¬† },

¬† ¬† ¬† ¬† ¬† ¬† success: function(response) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (response.success) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (response.models && Array.isArray(response.models)) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† let $modelSelect = $('#anthropic_model');

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† $modelSelect.empty();

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† response.models.forEach(function(model) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† $modelSelect.append($('<option>', {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† value: model,

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† text: model

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }));

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† });

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (response.default_model) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† $modelSelect.val(response.default_model);

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv("ConnectionSuccess")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv("NoModels")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert(response.message || "<?php echo dol_escape_js($langs->transnoentitiesnoconv("ConnectionFailed")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† },

¬† ¬† ¬† ¬† ¬† ¬† error: function(xhr, status, error) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv("ConnectionFailed")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† });

¬† ¬† });

¬† ¬† // Bot√≥n: comprobar saldo

¬† ¬† $('#check_api_balance').click(function(e) {

¬† ¬† ¬† ¬† e.preventDefault();

¬† ¬† ¬† ¬† $.ajax({

¬† ¬† ¬† ¬† ¬† ¬† url: "<?php echo dol_buildpath('/custom/dolielec/ajax/openai.ajax.php', 1); ?>",

¬† ¬† ¬† ¬† ¬† ¬† method: "POST",

¬† ¬† ¬† ¬† ¬† ¬† dataType: "json",

¬† ¬† ¬† ¬† ¬† ¬† data: {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† action: "check_api_balance"

¬† ¬† ¬† ¬† ¬† ¬† },

¬† ¬† ¬† ¬† ¬† ¬† success: function(response) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (response.success && typeof response.saldo_eur !== "undefined") {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv("DoliElec_Balance")); ?>: " + response.saldo_eur + " ‚Ç¨");

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert(response.message || "<?php echo dol_escape_js($langs->transnoentitiesnoconv("DoliElec_ErrorBalance")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† },

¬† ¬† ¬† ¬† ¬† ¬† error: function(xhr, status, error) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv("DoliElec_ErrorBalance")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† });

¬† ¬† });

});

>>>file: custom/dolielec/js/doc.js.php
<?php
// doc.js.php ó dolielec documentation manager JavaScript file.
$res = 0;
if (!$res && file_exists("../../main.inc.php"))  $res = @include("../../main.inc.php");
if (!$res && file_exists("../../../main.inc.php")) $res = @include("../../../main.inc.php");
if (!$res && file_exists("../../../../main.inc.php")) $res = @include("../../../../main.inc.php");
if (!$res) die("Include of main fails");

header('Content-Type: application/javascript; charset=UTF-8');
global $langs;
$langs->load("dolielec@dolielec");
?>
jQuery(document).ready(function($) {
    if ($('#signPdfBtn').length) {
    $('#signPdfBtn').on('click', function(e) {
      e.preventDefault();
      var fileInput = $('#file_pdf')[0];
      if (!fileInput.files || !fileInput.files.length) {
        alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv('BadParams')); ?>");
        return;
      }
      var file = fileInput.files[0];
      var formData = new FormData();
      formData.append('action', 'signPdf');
      formData.append('file_pdf', file);
      $.ajax({
        url: "<?php echo dol_buildpath('/custom/dolielec/ajax/doc.ajax.php',1); ?>",
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        xhrFields: { responseType: 'blob' },
        success: function(blob, status, xhr) {
          var contentType = xhr.getResponseHeader('Content-Type');
          if (contentType === 'application/pdf') {
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            var origName = file.name;
            var newName = origName.replace(/\.pdf$/i, '') + '-signed.pdf';
            a.download = newName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
          } else {
            var reader = new FileReader();
            reader.onload = function() {
              try {
                var json = JSON.parse(reader.result);
                alert(json.message || json.error || "<?php echo dol_escape_js($langs->transnoentitiesnoconv('ConnectionFailed')); ?>");
              } catch (err) {
                alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv('ConnectionFailed')); ?>");
              }
            };
            reader.readAsText(blob);
          }
        },
        error: function() {
          alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv('ConnectionFailed')); ?>");
        }
      });
    });
  }

    if (!$('#cups').length) return;

  function setDisabledWithHidden($input, disable, zeroValue) {
    if (!$input.length) return;

    var name   = $input.attr('name');
    var baseId = $input.attr('id') || ('fld_'+Math.random().toString(36).slice(2));
    $input.attr('id', baseId);

    var hidId  = baseId + '_hidden';
    var $hidden = $('#'+hidId);

    if (disable) {
      $input.prop('disabled', true)
            .prop('required', false)
            .addClass('opacitymedium');

      if (!$hidden.length) {
        $hidden = $('<input>', {type:'hidden', id:hidId, name:name, value:(zeroValue!=null?zeroValue:'0')});
        $input.after($hidden);
      } else {
        $hidden.val(zeroValue!=null?zeroValue:'0');
      }
    } else {
      $input.prop('disabled', false)
            .prop('required', true) // requerido solo cuando est· habilitado
            .removeClass('opacitymedium');
      if ($hidden.length) $hidden.remove();
    }
  }

  function syncTierra() {
    var yes = $('input[name="form[TIERRA_EXISTE]"][value="SI"]').is(':checked');
    setDisabledWithHidden($('#tierra_val'), !yes, '0');
  }
  function syncAislamiento() {
    var yes = $('input[name="form[AISLAMIENTO]"][value="SI"]').is(':checked');
    setDisabledWithHidden($('#aisla_val'), !yes, '0');
  }
  function syncAscensor() {
    var yes = $('input[name="form[ASCENSOR]"][value="SI"]').is(':checked');
    setDisabledWithHidden($('#pot_asc'), !yes, '0');
  }

  $('input[name="form[TIERRA_EXISTE]"]').on('change', syncTierra);
  $('input[name="form[AISLAMIENTO]"]').on('change', syncAislamiento);
  $('input[name="form[ASCENSOR]"]').on('change', syncAscensor);

  
  syncTierra();
  syncAislamiento();
  syncAscensor();


  $('form').on('submit', function(){
    syncTierra(); syncAislamiento(); syncAscensor();
  });
});

>>>file: custom/dolielec/js/dolielec.js.php
<?php
$res = 0;
if (!$res && file_exists("../../main.inc.php"))  $res = @include("../../main.inc.php");
if (!$res && file_exists("../../../main.inc.php")) $res = @include("../../../main.inc.php");
if (!$res && file_exists("../../../../main.inc.php")) $res = @include("../../../../main.inc.php");
if (!$res) die("Include of main fails");
header('Content-Type: application/javascript; charset=UTF-8');

$openaiJs = dol_buildpath('/custom/dolielec/js/openai.js.php', 1);
$googleJs = dol_buildpath('/custom/dolielec/js/google.js.php', 1);
$docJs = dol_buildpath('/custom/dolielec/js/doc.js.php', 1);
$anthropicJs = dol_buildpath('/custom/dolielec/js/anthropic.js.php', 1);
?>
jQuery(function($){
  function loadScriptOnce(src){
    if (document.querySelector('script[data-dle-src="'+src+'"]')) return;
    var s = document.createElement('script');
    s.src = src;
    s.async = false;
    s.setAttribute('data-dle-src', src);
    document.head.appendChild(s);
  }

  function needOpenAI(){ return !!(document.getElementById('openai_api_key') || document.getElementById('openai_model')); }
  function needGoogle(){ return !!(document.getElementById('google_api_key') || document.getElementById('google_model')); }
  function needAnthropic(){ return !!(document.getElementById('anthropic_api_key') || document.getElementById('anthropic_model')); }
  function needDocJS(){
    return !!(
      document.getElementById('signPdfBtn') ||
      document.getElementById('file_pdf')   ||
      document.getElementById('cups')        ||                    // BRIE form
      document.querySelector('input[name="form[ASCENSOR]"]') ||
      document.getElementById('pot_asc')     ||
      document.getElementById('tierra_val')  ||
      document.getElementById('aisla_val')
    );
  }

    if (needOpenAI()) loadScriptOnce('<?php echo $openaiJs; ?>');
	if (needAnthropic()) loadScriptOnce('<?php echo $anthropicJs; ?>');
  if (needGoogle()) loadScriptOnce('<?php echo $googleJs; ?>');
  if (needDocJS())  loadScriptOnce('<?php echo $docJs; ?>');

  $(document).on('click', '.tabBar a', function(){
    setTimeout(function(){
      if (needOpenAI()) loadScriptOnce('<?php echo $openaiJs; ?>');
	  if (needAnthropic()) loadScriptOnce('<?php echo $anthropicJs; ?>');
      if (needGoogle()) loadScriptOnce('<?php echo $googleJs; ?>');
      if (needDocJS())  loadScriptOnce('<?php echo $docJs; ?>');
    }, 50);
  });
});

>>>file: custom/dolielec/js/geoloc.js.php
<?php
// geoloc.js.php ‚Äî JS espec√≠fico de geolocalizaci√≥n (sin jQuery), Dolibarr-friendly
$res = 0;
if (!$res && file_exists("../../main.inc.php"))       $res = @include("../../main.inc.php");
if (!$res && file_exists("../../../main.inc.php"))    $res = @include("../../../main.inc.php");
if (!$res && file_exists("../../../../main.inc.php")) $res = @include("../../../../main.inc.php");
if (!$res) die("Include of main fails");
header('Content-Type: application/javascript; charset=UTF-8');
global $langs; $langs->loadLangs(array('dolielec@dolielec'));
?>
(function(){
  function $(id){ return document.getElementById(id); }
  function on(el, ev, fn){ if(el) el.addEventListener(ev, fn, false); }

  // Mantener SIEMPRE visible la fila de API key; alternar s√≥lo readonly/required y el asterisco
  function syncApiKey(){
    var prov = $('DOLIELEC_GEO_PROVIDER');
    var key  = $('DOLIELEC_GEO_API_KEY');
    var mark = $('req_apikey');
    var row  = document.getElementById('row_api_key') || (key && key.closest ? key.closest('tr') : null);
    if(!prov || !key) return;

    var needs = (prov.value === 'google' || prov.value === 'ors');

    // Nunca ocultar
    if(row){ row.style.display=''; row.removeAttribute('hidden'); row.style.removeProperty('visibility'); }
    key.style.display = ''; key.removeAttribute('hidden'); key.style.removeProperty('visibility');

    // No usar disabled (algunos temas ocultan). Usar readonly cuando no se requiere
    key.disabled = false;
    key.readOnly = !needs;

    if(needs){
      key.required = true;
      key.setAttribute('aria-required','true');
      key.removeAttribute('aria-readonly');
      key.removeAttribute('aria-disabled');
      if(mark) mark.style.display = 'inline';
    } else {
      key.required = false;
      key.removeAttribute('aria-required');
      key.setAttribute('aria-readonly','true');
      key.setAttribute('aria-disabled','true');
      if(mark) mark.style.display = 'none';
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    var prov = $('DOLIELEC_GEO_PROVIDER');
    on(prov, 'change', syncApiKey);
    syncApiKey();
  });

})();>>>file: custom/dolielec/js/google.js.php
<?php
$res = 0;
if (! $res && file_exists("../../main.inc.php")) $res = @include("../../main.inc.php");
if (! $res && file_exists("../../../main.inc.php")) $res = @include("../../../main.inc.php");
if (! $res && file_exists("../../../../main.inc.php")) $res = @include("../../../../main.inc.php");
if (! $res) die("Include of main fails");

header('Content-Type: application/javascript; charset=UTF-8');
global $langs;
$langs->load("dolielec@dolielec");

?>

jQuery(document).ready(function($) {
if (!$('#google_api_key').length) return; 


¬† ¬† // Bot√≥n: comprobar conexi√≥n

¬† ¬† $('#google_check_api').click(function(e) {

¬† ¬† ¬† ¬† e.preventDefault();

¬† ¬† ¬† ¬† let api_key = $('#google_api_key').val();

¬† ¬† ¬† ¬† if (!api_key || api_key.trim() === '') {

¬† ¬† ¬† ¬† ¬† ¬† alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv("MissingAPIKey")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† return;

¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† $.ajax({

¬† ¬† ¬† ¬† ¬† ¬† url: "<?php echo dol_buildpath('/custom/dolielec/ajax/google.ajax.php', 1); ?>",

¬† ¬† ¬† ¬† ¬† ¬† method: "POST",

¬† ¬† ¬† ¬† ¬† ¬† dataType: "json",

¬† ¬† ¬† ¬† ¬† ¬† data: {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† action: "check_api_conn",

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† api_key: api_key

¬† ¬† ¬† ¬† ¬† ¬† },

¬† ¬† ¬† ¬† ¬† ¬† success: function(response) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (response.success) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (response.models && Array.isArray(response.models)) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† let $modelSelect = $('#google_model');

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† $modelSelect.empty();

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† response.models.forEach(function(model) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† $modelSelect.append($('<option>', {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† value: model,

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† text: model

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }));

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† });

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (response.default_model) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† $modelSelect.val(response.default_model);

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv("ConnectionSuccess")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv("NoModels")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert(response.message || "<?php echo dol_escape_js($langs->transnoentitiesnoconv("ConnectionFailed")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† },

¬† ¬† ¬† ¬† ¬† ¬† error: function(xhr, status, error) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv("ConnectionFailed")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† });

¬† ¬† });

¬† ¬† // Bot√≥n: comprobar saldo

¬† ¬† $('#check_api_balance').click(function(e) {

¬† ¬† ¬† ¬† e.preventDefault();

¬† ¬† ¬† ¬† $.ajax({

¬† ¬† ¬† ¬† ¬† ¬† url: "<?php echo dol_buildpath('/custom/dolielec/ajax/openai.ajax.php', 1); ?>",

¬† ¬† ¬† ¬† ¬† ¬† method: "POST",

¬† ¬† ¬† ¬† ¬† ¬† dataType: "json",

¬† ¬† ¬† ¬† ¬† ¬† data: {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† action: "check_api_balance"

¬† ¬† ¬† ¬† ¬† ¬† },

¬† ¬† ¬† ¬† ¬† ¬† success: function(response) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (response.success && typeof response.saldo_eur !== "undefined") {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv("DoliElec_Balance")); ?>: " + response.saldo_eur + " ‚Ç¨");

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert(response.message || "<?php echo dol_escape_js($langs->transnoentitiesnoconv("DoliElec_ErrorBalance")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† },

¬† ¬† ¬† ¬† ¬† ¬† error: function(xhr, status, error) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv("DoliElec_ErrorBalance")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† });

¬† ¬† });

});

>>>file: custom/dolielec/js/openai.js.php
<?php
$res = 0;
if (! $res && file_exists("../../main.inc.php")) $res = @include("../../main.inc.php");
if (! $res && file_exists("../../../main.inc.php")) $res = @include("../../../main.inc.php");
if (! $res && file_exists("../../../../main.inc.php")) $res = @include("../../../../main.inc.php");
if (! $res) die("Include of main fails");

header('Content-Type: application/javascript; charset=UTF-8');
global $langs;
$langs->load("dolielec@dolielec");

?>

jQuery(document).ready(function($) {
if (!$('#openai_api_key').length) return;
// Bot√≥n: comprobar conexi√≥n

¬† ¬† $('#openai_check_api').click(function(e) {

¬† ¬† ¬† ¬† e.preventDefault();

¬† ¬† ¬† ¬† let api_key = $('#openai_api_key').val();

¬† ¬† ¬† ¬† if (!api_key || api_key.trim() === '') {

¬† ¬† ¬† ¬† ¬† ¬† alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv("MissingAPIKey")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† return;

¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† $.ajax({

¬† ¬† ¬† ¬† ¬† ¬† url: "<?php echo dol_buildpath('/custom/dolielec/ajax/openai.ajax.php', 1); ?>",

¬† ¬† ¬† ¬† ¬† ¬† method: "POST",

¬† ¬† ¬† ¬† ¬† ¬† dataType: "json",

¬† ¬† ¬† ¬† ¬† ¬† data: {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† action: "check_api_conn",

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† api_key: api_key

¬† ¬† ¬† ¬† ¬† ¬† },

¬† ¬† ¬† ¬† ¬† ¬† success: function(response) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (response.success) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (response.models && Array.isArray(response.models)) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† let $modelSelect = $('#openai_model');

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† $modelSelect.empty();

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† response.models.forEach(function(model) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† $modelSelect.append($('<option>', {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† value: model,

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† text: model

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }));

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† });

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (response.default_model) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† $modelSelect.val(response.default_model);

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv("ConnectionSuccess")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv("NoModels")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert(response.message || "<?php echo dol_escape_js($langs->transnoentitiesnoconv("ConnectionFailed")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† },

¬† ¬† ¬† ¬† ¬† ¬† error: function(xhr, status, error) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv("ConnectionFailed")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† });

¬† ¬† });

¬† ¬† // Bot√≥n: comprobar saldo

¬† ¬† $('#check_api_balance').click(function(e) {

¬† ¬† ¬† ¬† e.preventDefault();

¬† ¬† ¬† ¬† $.ajax({

¬† ¬† ¬† ¬† ¬† ¬† url: "<?php echo dol_buildpath('/custom/dolielec/ajax/openai.ajax.php', 1); ?>",

¬† ¬† ¬† ¬† ¬† ¬† method: "POST",

¬† ¬† ¬† ¬† ¬† ¬† dataType: "json",

¬† ¬† ¬† ¬† ¬† ¬† data: {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† action: "check_api_balance"

¬† ¬† ¬† ¬† ¬† ¬† },

¬† ¬† ¬† ¬† ¬† ¬† success: function(response) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (response.success && typeof response.saldo_eur !== "undefined") {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv("DoliElec_Balance")); ?>: " + response.saldo_eur + " ‚Ç¨");

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert(response.message || "<?php echo dol_escape_js($langs->transnoentitiesnoconv("DoliElec_ErrorBalance")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† },

¬† ¬† ¬† ¬† ¬† ¬† error: function(xhr, status, error) {

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alert("<?php echo dol_escape_js($langs->transnoentitiesnoconv("DoliElec_ErrorBalance")); ?>");

¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† });

¬† ¬† });

});

>>>file: custom/dolielec/lib/calculate.lib.php
<?php
//functions for calculate load previsions on diferent offices, for ITC-BT-10 compliance and other ITC's with same requirements.
//file started with ITC-BT-10 and ITC-BT-52 calculate functions
function getCoefi($num): array {
global $langs;
if(!is_numeric($num) || $num < 1) {
return array('success' => false, 'message' => $langs->trans('ValueInvalid'));
}
$cs = array('1' => '1', '2' => '2', '3' => '3', '4' => '3.8', '5' => '4.6', '6' => '5.4', '7' => '6.2', '8' => '7', '9' => '7.8', '10' => '8.5', '11' => '9.2', '12' => '9.9', '13' => '10.6', '14' => '11.3', '15' => '11.9', '16' => '12.5', '17' => '13.1', '18' => '13.7', '19' => '14.3', '20' => '14.8', '21' => '15.3');
if ($num <=21) {
$result = $cs[$num];
return array('success' => true, 'value' => $result);
}
$response = 15.3+($num-21)*0.5;
return array('success' => true, 'value' => $response);
}
function getHome($nh, $basic = null) {
    global $langs;
    $nh = (int) $nh;
    if ($basic === "" || $basic === null) {
        $basic = null;
    }
	else {
        $basic = (int) $basic;
    }
    if ($nh < 1) {
        return array('success' => false, 'message' => $langs->trans('NumberInvalid'));
    }
    if ($basic !== null) {
        if ($basic < 0 || $basic > $nh) {
            return array('success' => false, 'message' => $langs->trans('ValueInvalidOrOutOfRange'));
        }
        $elevated = $nh - $basic;
        $power = ((5.75 * $basic) + (9.2 * $elevated)) / $nh;
    }
	else {
        $power = 9.2; // kW
    }
    $cs = getCoefi($nh);
    if (!$cs['success']) {
        return $cs;
	}
$result = (float) $cs['value'];
    $avg = $power * $result;
    return array('success' => true, 'value' => $avg);
}
function getComService($elevation = null, $engines = null, $led = null) {
    global $langs;
    $elevation = ($elevation === "" || $elevation === null) ? 0 : (int) $elevation;
    $led = ($led === "" || $led === null) ? 0 : (int) $led;
    $engines = is_array($engines) ? array_filter($engines, fn($value) => $value !== "" && $value !== null) : [];
    if ($elevation < 0 || $led < 0 || count(array_filter($engines, fn($value) => !is_numeric($value) || $value < 0)) > 0) {
        return array('success' => false, 'message' => $langs->trans('OneOrMoreValuesAreInvalid'));
    }
    if ($elevation === 0 && array_sum($engines) === 0 && $led === 0) {
        return array('success' => true, 'value' => 0);
    }
    $elecorr = $elevation > 0 ? $elevation * 1.3 : 0;
    $engicorr = 0;
    if (count($engines) > 1) {
        rsort($engines);
        $engicorr += $engines[0] * 1.25;
        for ($i = 1; $i < count($engines); $i++) {
            $engicorr += $engines[$i];
       }
    }
	elseif (count($engines) === 1) {
        $engicorr += $engines[0];
    }
    $il = $led > 0 ? ($led * 1.8) / 1000 : 0;
    $result = $elecorr + $engicorr + $il;
    return array('success' => true, 'value' => round($result, 2));
}
function getOffice($pl = null, $metter = null) {
    global $langs;
    if ($pl === "" || $pl === null) {
        return array('success' => true, 'value' => 0);
    }
    $pl = (int) $pl;
    $metter = array_filter((array)$metter, fn($value) => $value !== "" && $value !== null);
    if (count($metter) !== $pl) {
        return array('success' => false, 'message' => $langs->trans('InvalidMetterFormat'));
    }
    $power = 0;
    foreach ($metter as $m2) {
        if (!is_numeric($m2) || $m2 <= 0) {
            return array('success' => false, 'message' => $langs->trans('ValueInvalid'));
       }
        $power += max(3450, $m2 * 100); // W
    }
    return array('success' => true, 'value' => $power / 1000);
}
function getParking($npl, $ev = null, $winn = null, $area = null) {
    global $langs;
    $npl = (int) $npl;
    if ($area === "" || $area === null) {
        $area = 20;
    }    $area = (int) $area;
    if ($npl < 0) {
        return array('success' => false, 'message' => $langs->trans('numberInvalid'));
    }
    if ($npl === 0) {
        return array('success' => true, 'value' => 0);
    }
    $ev = ($ev === "" || $ev === null) ? 1 : (int) $ev;
    $winn = ($winn === "" || $winn === null) ? 1 : (int) $winn;
	$result = 0;
    if ($ev === 1) {
        $result += $npl * 3.68;
    }
	if ($winn === 1) {
        $result += $npl * $area * 0.02;
    }
	else {
        $result += $npl * $area * 0.01;
    }
    if ($result < 3.45) {
        $result = 3.45;
    }
    return array('success' => true, 'value' => $result);
}
function getPower($params) {
global $langs;
$total = 0;
if (!empty($params['home'])) {
$res = getHome($params['home']['nh'] ?? null, $params['home']['basic'] ?? null);
if (!empty($res['success']) && isset($res['value'])) {
$total += $res['value'];
}
}
if (!empty($params['service'])) {
$res = getComService($params['service']['elevation'] ?? null, $params['service']['engines'] ?? [], $params['service']['led'] ?? null);
if (!empty($res['success']) && isset($res['value'])) {
$total += $res['value'];
}
}
if (!empty($params['office'])) {
$res = getOffice($params['office']['pl'] ?? null, $params['office']['metter'] ?? null);
if (!empty($res['success']) && isset($res['value'])) {
$total += $res['value'];
}
}
if (!empty($params['parking'])) {
$res = getParking($params['parking']['npl'] ?? null, $params['parking']['ev'] ?? null, $params['parking']['winn'] ?? null, $params['parking']['area'] ?? null);
if (!empty($res['success']) && isset($res['value'])) {
$total += $res['value'];
}
}
if ($total === 0) {
return array('success' => false, 'message' => $langs->trans('CalculationNotPossible'));
}
return array('success' => true, 'value' => round($total, 2));
}
function getIndustries($pl = null, $metter = null) {
    global $langs;
    if ($pl === "" || $pl === null) {
        return array('success' => true, 'value' => 0);
    }
    $pl = (int) $pl;
    $metter = array_filter((array)$metter, fn($value) => $value !== "" && $value !== null);
    if (count($metter) !== $pl) {
        return array('success' => false, 'message' => $langs->trans('InvalidMetterFormat'));
    }
    $power = 0;
    foreach ($metter as $m2) {
        if (!is_numeric($m2) || $m2 <= 0) {
            return array('success' => false, 'message' => $langs->trans('ValueInvalid'));
       }
        $power += max(10350, $m2 * 125);
    }
    return array('success' => true, 'value' => $power / 1000);
}
//ITC-BT-52 compliance
function getCollectiveParking($pev, $spl) {
	global $langs, $params;
	if ($pev < 0) {
		return array('success' => $langs->trans('NumberInvalid'));
	}
		$total = $pev * 0.1;
		$pot = $total * 3680;
		$ev = $pot;
		$response =getPower($params);
		if(empty($response['success']) || !isset($response['value'])) {
			return array('success' => false, 'message' => $langs->trans('CalculationFailed'));
		}
			if ($spl === 1) {
$pot = (($response['value'] * 1000) + $ev) * 0.3 / 1000;
return array ('success' => true, 'value' => $pot);
		}
		else {
			$pot = ($response['value'] * 1000)+ $ev;
			return array('success' => true, 'values' => $pot);
		}
}			
//calculating wires section, with bt19, bt40, bt20, bt06 compliance.
function getSystemInstall($route, $cores) {
$route = trim($route);
$cores = intval($cores);
$map = array('A'=>array(3=>'a1', 2=>'a2'), 'B'=>array(3=>'b1', 2=>'b2'), 'C'=>array(3=>'c1', 2=>'c2'), 'G'=>array(3=>'g1'));
return isset($map[$route][$cores]) ? $map[$route][$cores] : null;
}
function getVoltage($i, $longitude, $section, $mat = 'Cu', $family = 'UNI', $phase = 3, $cosphi = 0.8) {
    $r_cu = array(1.5 => 12.1, 2.5 => 7.41, 4 => 4.61, 6 => 3.08, 10 => 1.83, 16 => 1.15, 25 => 0.727, 35 => 0.524, 50 => 0.387, 70 => 0.268, 95 => 0.193, 120 => 0.153, 150 => 0.124, 185 => 0.0991, 240 => 0.0754, 300 => 0.0601);
    if ($mat === 'Al' || $mat === 'al') {
        foreach ($r_cu as $k => $v) {
$r_cu[$k] = $v * 1.6;
    }
}
    $x_uni = array(1.5 => 0.080, 2.5 => 0.075, 4 => 0.070, 6 => 0.065, 10 => 0.060, 16 => 0.056, 25 => 0.052, 35 => 0.050, 50 => 0.048, 70 => 0.045, 95 => 0.043, 120 => 0.042, 150 => 0.041, 185 => 0.040, 240 => 0.039, 300 => 0.038);
    $x_multi = array();
    foreach ($x_uni as $k => $v) {
$x_multi[$k] = $v * 0.8;
}
    $x_map = ($family === 'MULTI' || $family === 'multi') ? $x_multi : $x_uni;
    if (!isset($r_cu[$section]) || !isset($x_map[$section])) {
return null;
}
    $r = $r_cu[$section];
    $x = $x_map[$section];
    $u = ($phase === 3) ? 400 : 230;
    $k = ($phase === 3) ? sqrt(3) : 2;
    $l = ($phase === 1 ? $longitude * 2 : $longitude) / 1000;
    $dv_v = $k * $i * ($r * $cosphi + $x * sqrt(1 - $cosphi * $cosphi)) * $l;
    return ($dv_v * 100) / $u;
}

>>>file: custom/dolielec/lib/dolielec.lib.php
<?php
require_once DOL_DOCUMENT_ROOT.'/core/lib/functions.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/functions2.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/geturl.lib.php';
require_once 'calculate.lib.php';
// dolielec.lib.php - Funciones utilitarias para Biel y Dolielec (accesibilidad bloque 17)
//gestionar pesta√±as
function dolielecTabsConfig () {
	return array(
	'openai' => array('OpenaiSettings', 'openai.php'),
	'google' => array('GoogleAISettings', 'google.php'),
	'geoloc' => array('GeolocalizationSettings', 'geoloc.php'),
	'documentation' => array('DocumentationSettings', 'doc.php'),
	);
}
function dolielecAdminPrepareHead () {
	global $langs;
	$langs->load("dolielec@dolielec");
	$self = DOL_URL_ROOT.'/custom/dolielec/admin/setup.php';
	$cfg = dolielecTabsConfig();
$head =array();
$h = 0;
foreach ($cfg as $id => $t) {
	$label = $langs->trans($t[0]);
	$head[$h][0] = $self.'?tab='.$id;
	$head[$h][1] = $label;
	$head[$h][2] = $id;
	$h++;
}
return $head;
}
//accesibilidad
function dolielec_print_textfield($label, $name, $value = '', $required = false, $helptext = '')
{
    global $langs;

    $fieldid = 'field_' . $name;
    $asterisk = $required ? '<span class="fieldrequired" title="Campo obligatorio" aria-label="Campo obligatorio">*</span>' : '';
    $required_attr = $required ? 'required aria-required="true"' : '';
    $aria_label = $required ? 'aria-label="' . dol_escape_htmltag($label) . ' (requerido)"' : 'aria-label="' . dol_escape_htmltag($label) . '"';
    print '<tr class="oddeven">';
    print '<td><label for="' . $fieldid . '">' . $asterisk . $label . '</label></td>';
    print '<td><input type="text" id="' . $fieldid . '" name="' . $name . '" value="' . dol_escape_htmltag($value) . '" ' . $required_attr . ' ' . $aria_label . ' class="minwidth200"/>';
    if (!empty($helptext)) print ' <span class="opacitymedium">' . $helptext . '</span>';
    print '</td>';
    print '</tr>';
}
function dolielec_a11y_print_status($message, $type='ok') {
    print '<div class="dolielec-status '.($type==='ok'?'ok':'err').'" role="status" aria-live="polite">'
        .dol_escape_htmltag($message).'</div>';
}
function dolielec_a11y_region_start($title, $level=2, $id='') {
    $h = max(1, min(6, (int)$level));
    $idattr = $id ? ' id="'.dol_escape_htmltag($id).'"' : '';
    print '<section class="dolielec-a11y-region" role="region"'.$idattr
        .' aria-labelledby="dolielec-'.$h.'-'.md5($title).'">';
    print '<h'.$h.' id="dolielec-'.$h.'-'.md5($title).'">'
        .dol_escape_htmltag($title).'</h'.$h.'>';
}
function dolielec_a11y_region_end() {
 print '</section>';
 }

//identidad de biel, bloque 1
function dolielec_get_biel_identity()
{
    static $cache = null;
    if ($cache !== null) return $cache;

    $path = DOL_DATA_ROOT . '/dolielec/identity/biel_identity.md';
    if (!file_exists($path)) $path = DOL_DOCUMENT_ROOT . '/custom/dolielec/identity/biel_identity.md';

    $cache = file_exists($path) ? file_get_contents($path) : '';
    return $cache;
}
//saludo
function dolielec_get_biel_greeting()
{
    $id = dolielec_get_biel_identity();
    foreach (preg_split('/\R/', $id) as $l) {
        $t = trim($l);
        if ($t === '' || preg_match('/^(===|t√≠tulo\\s*:)/i', $t)) continue;
        if (stripos($t, 'soy biel') !== false) return $t;
        return $t;
    }
    return '';
}


/**
 * Render accesible (WCAG 2.2 AA) para markdown b√°sico.
 * Soporta: t√≠tulos "=== BLOQUE X ===" -> h2, "t√≠tulo:" -> h3, listas "- ", **negritas**, `code`,
 * enlaces [txt](url), im√°genes ![alt](src). Incluye landmarks y respeta sr-only/skip-link via CSS.
 *
 * @param string $raw Markdown plano
 * @param string $pageTitle T√≠tulo accesible de la p√°gina
 * @return string HTML seguro
 */
function dolielec_md_render_accessible($raw, $pageTitle = 'Identidad de Biel')
{
    $raw = str_replace(array("\r\n","\r"), "\n", $raw);
    $raw = str_replace("\\n", "\n", $raw);
    $lines = explode("\n", $raw);
    $html = '';

    // Wrapper sem√°ntico. Las clases se definen en css/dolielec.css.php
    $html .= '<a class="skip-link" href="#main-content">'.htmlspecialchars($pageTitle, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8').' ‚Äì Saltar al contenido</a>';
    $html .= '<main id="main-content" role="main" tabindex="-1" aria-labelledby="page-title" class="biel-identity" lang="es">';
    $html .= '<h1 id="page-title" class="visually-hidden">'.htmlspecialchars($pageTitle, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8').'</h1>';

    $in_list = false;

    foreach ($lines as $line) {
        $t = trim($line);
        if ($t === '') { if ($in_list) { $html .= "</ul>\n"; $in_list = false; } continue; }

        // H2 por bloque
        if (preg_match('/^===\s*BLOQUE\s+\d+\s*===/i', $t)) {
            if ($in_list) { $html .= "</ul>\n"; $in_list = false; }
            $html .= '<h2>'.htmlspecialchars($t, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8')."</h2>\n";
            continue;
        }
        // H3 por "t√≠tulo: x"
        if (preg_match('/^t[i√≠]tulo\s*:\s*(.+)$/i', $t, $m)) {
            if ($in_list) { $html .= "</ul>\n"; $in_list = false; }
            $html .= '<h3>'.htmlspecialchars($m[1], ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8')."</h3>\n";
            continue;
        }
        // Imagen
        if (preg_match('/^!\[([^\]]*)\]\(([^)]+)\)/', $t, $m)) {
            if ($in_list) { $html .= "</ul>\n"; $in_list = false; }
            $alt = htmlspecialchars($m[1] !== '' ? $m[1] : 'Imagen', ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8');
            $src = dolielec_sanitize_url($m[2]);
            $html .= '<figure><img src="'.$src.'" alt="'.$alt.'" /></figure>'."\n";
            continue;
        }
        // Lista
        if (preg_match('/^-\s+(.+)/', $t, $m)) {
            if (!$in_list) { $html .= "<ul>\n"; $in_list = true; }
            $item = $m[1];
            // Links [text](url)
            $item = preg_replace_callback('/\[(.+?)\]\((.+?)\)/', function($mm){
                $txt = htmlspecialchars($mm[1], ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8');
                $href = dolielec_sanitize_url($mm[2]);
                return '<a href="'.$href.'">'.$txt.'</a>';
            }, $item);
            // C√≥digo y negritas
            $item = preg_replace('/`(.+?)`/s', '<code>$1</code>', $item);
            $item = preg_replace('/\*\*(.+?)\*\*/s', '<strong>$1</strong>', $item);
            $item = htmlspecialchars_decode(htmlspecialchars($item, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8'));
            $html .= "<li>$item</li>\n";
            continue;
        }
        // P√°rrafo
        $p = $t;
        $p = preg_replace_callback('/\[(.+?)\]\((.+?)\)/', function($mm){
            $txt = htmlspecialchars($mm[1], ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8');
            $href = dolielec_sanitize_url($mm[2]);
            return '<a href="'.$href.'">'.$txt.'</a>';
        }, $p);
        $p = preg_replace('/`(.+?)`/s', '<code>$1</code>', $p);
        $p = preg_replace('/\*\*(.+?)\*\*/s', '<strong>$1</strong>', $p);
        $p = htmlspecialchars_decode(htmlspecialchars($p, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8'));
        $html .= "<p>$p</p>\n";
    }
    if ($in_list) $html .= "</ul>\n";
    $html .= '</main>';
    return $html;
}

/**
 * Sanitiza URL a http(s)/mailto √∫nicamente (para renderer accesible).
 */
function dolielec_sanitize_url($url) {
    $url = trim($url);
    if (preg_match('#^(https?://|mailto:)#i', $url)) {
        return htmlspecialchars($url, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8');
    }
    return '#';
}
//calling to apis
/**
 * Llamada HTTP (GET / POST / PUT / PATCH / HEAD) usando getURLContent() de Dolibarr 22.
 * Devuelve un array est√°ndar:
 *   [ 'success'=>bool, 'http'=>int|null, 'json'=>mixed|null, 'raw'=>string|null, 'message'=>string|null ]
 *
 * @param string $url
 * @param array  $opts
 * @return array
 */
function apicall($url, $opts = array())
{
    // ----- Lectura de opciones -------------------------------------------------
    $method      = !empty($opts['method'])      ? $opts['method']      : 'GET';
    $query       = !empty($opts['query'])       ? $opts['query']       : '';
    $body        = array_key_exists('body',   $opts) ? $opts['body']   : null;
    $json_body   = array_key_exists('json_body',$opts) ? (int)$opts['json_body'] : 1;
	    $multipart   = array_key_exists('multipart',$opts) ? (int)$opts['multipart'] : 0;
    $bearer      = !empty($opts['bearer'])      ? $opts['bearer']      : '';
    $headers_in  = !empty($opts['headers']) && is_array($opts['headers']) ? $opts['headers'] : array();
    $timeout     = !empty($opts['timeout'])     ? intval($opts['timeout']) : 25;
    $maxredirect = array_key_exists('maxredirect',$opts) ? intval($opts['maxredirect']) : 3;
    $referer     = !empty($opts['referer'])     ? $opts['referer']     : '';
    $noproxy     = !empty($opts['noproxy'])     ? intval($opts['noproxy']) : 0;
    $useragent   = !empty($opts['useragent'])   ? $opts['useragent']   : ('Dolibarr/'.DOL_VERSION.' dolielec/1.0');
    $accept_json = array_key_exists('accept_json',$opts) ? intval($opts['accept_json']) : 1;
    $decode_json = array_key_exists('decode_json',$opts) ? intval($opts['decode_json']) : 1;
	$save_to     = !empty($opts['save_to']) ? $opts['save_to'] : '';

        if (is_array($query)) {
        $qs = http_build_query($query);
    } else {
        $qs = (string) $query;
    }
    if ($qs !== '') {
        $url .= (strpos($url, '?') === false ? '?' : '&') . ltrim($qs, '?&');
    }
        $headers = array();
    if ($accept_json)  $headers[] = 'Accept: application/json';
    if ($bearer !== '') $headers[] = 'Authorization: Bearer '.$bearer;
    if ($referer !== '') $headers[] = 'Referer: '.$referer;
    if ($useragent !== '') $headers[] = 'User-Agent: '.$useragent;
    if (!empty($headers_in)) {
        foreach ($headers_in as $h) $headers[] = $h;
    }

    // ----- Cuerpo para m√©todos con payload ------------------------------------
    $post_data = '';
    if (in_array($method, array('POST','PUT','PATCH'))) {
        if ($body !== null) {
			if ($multipart) {
				    $post_data = $body;
			}
            elseif ($json_body && is_array($body)) {
                $post_data = json_encode($body, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
                $has_ct = 0;
                foreach ($headers as $h) {
                    if (stripos($h, 'content-type:') === 0) { $has_ct = 1; break; }
                }
                if (!$has_ct) $headers[] = 'Content-Type: application/json';
            } else {
                $post_data = is_array($body) ? http_build_query($body) : (string) $body;
            }
        }
    }

    // ----- Llamada a getURLContent() ------------------------------------------
    $r = getURLContent(
	        $url,                    // 1
        $method,                 // 2
        $post_data,              // 3
        1,                       // 4 followlocation
        $headers,                // 5
        array('http','https'),   // 6 allowedschemes
        $noproxy ? 1 : 0,        // 7 localurl
        -1,                      // 8 ssl_verifypeer
        $timeout,                // 9 connect timeout
        $timeout                 //10 response timeout
    );

    // ----- Procesado de respuesta ---------------------------------------------
	$ctype = !empty($r['content_type']) ? $r['content_type'] : '';
    $http = !empty($r['http_code']) ? intval($r['http_code']) : null;

    if (!empty($r['curl_error_no'])) {
        return array(
            'success' => false,
            'http'    => $http,
            'json'    => null,
            'raw'     => isset($r['content']) ? $r['content'] : null,
			'content_type' => $ctype,
            'message' => !empty($r['curl_error_msg']) ? $r['curl_error_msg'] : 'Transport error'
        );
    }

    $raw = isset($r['content']) ? $r['content'] : '';

    if ($http === null || $http < 200 || $http >= 300) {
        $msg = 'HTTP '.$http;
        if ($decode_json && $raw !== '') {
            $j = json_decode($raw, true);
            if (is_array($j)) {
                if (isset($j['error']['message']))       $msg = $j['error']['message'];
                elseif (isset($j['error']) && is_string($j['error']))  $msg = $j['error'];
                elseif (isset($j['message']))            $msg = $j['message'];
                elseif (isset($j['detail']) && is_string($j['detail'])) $msg = $j['detail'];
            }
        }
        return array(
            'success' => false,
            'http'    => $http,
            'json'    => null,            'raw'     => $raw,
			'content_type' => $ctype,
            'message' => $msg
        );
    }
if ($save_to !== '') {
    $dir = dirname($save_to);
    if (!is_dir($dir)) { dol_mkdir($dir); } // helper Dolibarr
    file_put_contents($save_to, $raw);
    return array(
        'success' => true,
        'http' => $http,
        'json' => null,
        'raw' => null,
        'file' => $save_to,
        'content_type' => $ctype,
        'message' => null
    );
}
    if ($decode_json) {
        if ($raw === '' || $raw === 'null') {
            return array('success'=>true,'http'=>$http,'json'=>null,'raw'=>$raw,'content_type'=>$ctype,'message'=>null);
        }
        $j = json_decode($raw, true);
        if (is_array($j)) {
            return array('success'=>true,'http'=>$http,'json'=>$j,'raw'=>$raw,'content_type'=>$ctype,'message'=>null);
        }
        return array(
            'success' => false,
            'http'    => $http,
            'json'    => null,
            'raw'     => (dol_strlen($raw) > 512 ? dol_substr($raw,0,512).'‚Ä¶' : $raw),
			'content_type' => $ctype,
            'message' => 'InvalidJSONResponse'
        );
    }

    return array('success'=>true,'http'=>$http,'json'=>null,'raw'=>$raw,'content_type'=>$ctype,'message'=>null);
}

>>>file: custom/dolielec/sql/dolielec.sql
-- Cache de costes por tercero/contexto
<CREATE TABLE IF NOT EXISTS llx_dolielec_cost_cache (
  rowid integer AUTO_INCREMENT PRIMARY KEY,
  entity integer NOT NULL DEFAULT 1,
  fk_thirdparty integer NOT NULL,
  context_key varchar(64) NOT NULL,
  value decimal(24,8) NOT NULL,
  tms timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uq_entity_third_ctx (entity, fk_thirdparty, context_key)
) ENGINE=innodb DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
-- Entrenamiento de biel
CREATE TABLE IF NOT EXISTS llx_dolielec_biel_learn (
rowid integer AUTO_INCREMENT primary key,
entity integer not null default 1,
fk_blockid integer not null,
fk_sublock integer,
ctx MEDIUMTEXT not null,
tms timestamp not null default current_timestamp on update current_timestamp,
unique key BlockLearningID(fk_blockid, fk_sublock))
engine=innodb DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
-- frases para relaci√≥n psicol√≥gica orientada
create table if not exists llx_dolielec_rpo (
rowid integer AUTO_INCREMENT primary key,
entity integer not null default 1,
rpoid varchar(10) not null,
rpo_sentence varchar(255) not null,
unique key RPO(rpoid))
engine=innodb DEFAULT CHARSET=utf8mb4_unicode_ci COLLATE=utf8mb4_unicode_ci;

CREATE TABLE IF NOT EXISTS llx_dolielec_openai_balance(
rowid integer auto_increment not null primary key,
idmodel varchar(5) not null,
total decimal not null,
unique key tokenid (idmodel))
engine=innodb DEFAULT CHARSET=utf8mb4_unicode_ci COLLATE=utf8mb4_unicode_ci;
CREATE TABLE IF NOT EXISTS llx_dolielec_anthropic_balance(
rowid integer auto_increment not null primary key,
idmodel varchar(5) not null,
total decimal not null,
tms timestamp not null default current_timestamp on update current_timestamp,
unique key tokenid (idmodel))
engine=innodb DEFAULT CHARSET=utf8mb4_unicode_ci COLLATE=utf8mb4_unicode_ci;

CREATE TABLE IF NOT EXISTS llx_dolielec_memories(
rowid integer auto_increment not null,
msgid varchar(50) not null,
message text not null,
tms timestamp not null default current_timestamp on update current_timestamp,
unique key id(msgid))
engine=innodb DEFAULT CHARSET=utf8mb4_unicode_ci COLLATE=utf8mb4_unicode_ci;

>>>file: custom/dolielec/doc.php
<?php
//doc.php - dolielec documentation manager file.
$res = 0;
if (!$res) {
 $res = @include '../../main.inc.php';
if (!$res) {
 $res = @include '../../../main.inc.php';
if (!$res) {
 $res = @include '../../../../main.inc.php';
if (!$res) {
 die('Include of main fails');
 }
}
}
}
require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
require_once DOL_DOCUMENT_ROOT.'/custom/dolielec/lib/dolielec.lib.php';
global $langs, $user, $conf, $db;
$langs->loadLangs(array('admin','dolielec@dolielec'));
if (!$user->rights->dolielec->read) {
	accessforbidden();
}
$action = GETPOST('action', 'alpha');
$tab = GETPOST('tab', 'alpha') ?? 'signature';
$head = array();
$head[] = array(dol_buildpath('/custom/dolielec/doc.php?tab=signature',1), $langs->trans('Signature'), 'signature');
$head[] = array(dol_buildpath('/custom/dolielec/doc.php?tab=brie',1), $langs->trans('BRIE'), 'BRIE');
llxHeader('', $langs->trans('InternalDocumentManager'));
dol_fiche_head($head, $tab, $langs->trans('InternalDocumentManager'));
switch($tab) {
	case 'signature':
	include 'includes/sign.inc.php';
	break;
		case 'brie':
		define('DOLIELEC_brie', 1);
	include 'includes/certificates.inc.php';
	break;
}
$js = '/custom/dolielec/js/dolielec.js.php';
echo "\n<script type=\"text/javascript\" src=\"".dol_buildpath($js,1)."\"></script>\n";
dol_fiche_end();
llxFooter();
?>